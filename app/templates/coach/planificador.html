{% extends "layout.html" %}
{% block title %}Planificador ‚Äî VR Training{% endblock %}

{% block content %}
<div class="vr-page">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <div class="section-title" style="letter-spacing:.18em;font-weight:950;">PLANIFICADOR</div>
      <div class="text-soft text-muted">Semana ¬∑ Bloques ¬∑ Rutinas ¬∑ Disponibilidad</div>
    </div>

    <div class="d-flex gap-2 flex-wrap align-items-center">
      <a class="btn btn-outline-light" href="{{ url_for('main.dashboard_entrenador') }}">
        <i class="bi bi-arrow-left"></i> Panel
      </a>
    </div>
  </div>

  <!-- Selector atleta + semana -->
  <div class="card glass p-3 p-md-4 mb-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <form method="get" class="d-flex gap-2 flex-wrap align-items-center">
        <input type="hidden" name="center" value="{{ center.isoformat() }}">

        <div style="min-width:240px;">
          <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">ATLETA</label>
          <select class="form-select" name="user_id" onchange="this.form.submit()">
            {% for u in atletas %}
              <option value="{{ u.id }}" {% if atleta and u.id==atleta.id %}selected{% endif %}>
                {{ u.nombre }} {% if u.grupo %}¬∑ {{ u.grupo }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">SEMANA</label>
          <div class="d-flex gap-2">
            <input type="date" class="form-control" name="center" value="{{ center.isoformat() }}">
            <button class="btn btn-outline-info" type="submit">Ir</button>
          </div>
        </div>
      </form>

      <div class="d-flex gap-2 flex-wrap">
        {% if atleta %}
          <a class="btn btn-outline-info"
             href="{{ url_for('main.coach_planificador', user_id=atleta.id, center=prev_center.isoformat()) }}">
            ‚Üê Semana
          </a>

          <a class="btn btn-outline-info"
             href="{{ url_for('main.coach_planificador', user_id=atleta.id, center=next_center.isoformat()) }}">
            Semana ‚Üí
          </a>

          <form method="post" action="{{ url_for('main.coach_copiar_semana', user_id=atleta.id) }}" class="m-0">
            <input type="hidden" name="center" value="{{ center.isoformat() }}">
            <button class="btn btn-info" type="submit">
              <i class="bi bi-files"></i> Copiar a la siguiente
            </button>
          </form>
        {% endif %}
      </div>
    </div>

    {% if atleta %}
      <div class="text-muted mt-2">
        <span style="font-weight:900;letter-spacing:.10em;">SEMANA:</span> {{ semana_str }}
      </div>
    {% endif %}
  </div>

  {% if not atleta %}
    <div class="card glass p-4">
      <div class="text-muted">No hay atleta seleccionado.</div>
    </div>
  {% else %}

  <div class="vr-plani-grid">

    <!-- IZQUIERDA: d√≠as -->
    <div>

      <!-- ‚úÖ AHORA: 7 d√≠as visibles + expand -->
      <div class="vr-days-grid vr-days-grid-7" id="daysGrid">
        {% for f in fechas %}
          {% set p = planes[f] %}
          {% set blocked = ((p.puede_entrenar or 'si') == 'no') %}
          {% set cmt = (p.comentario_atleta or '') %}
          {% set day_id = "day_" ~ f.isoformat().replace('-','') %}

          <div class="vr-day-card vr-day-collapsed"
               data-day="{{ f.isoformat() }}"
               id="{{ day_id }}">

            <!-- HEADER (siempre visible) -->
            <div class="vr-day-title vr-day-clickable">
              <div>
                <div style="font-weight:950;letter-spacing:.10em;">
                  {{ f.strftime('%A %d/%m')|upper }}
                </div>
                <div class="text-muted" style="font-weight:800;">
                  {% if blocked %}
                    <i class="bi bi-slash-circle text-danger"></i> No puede entrenar
                    {% if cmt %}¬∑ {{ cmt }}{% endif %}
                  {% else %}
                    OK
                  {% endif %}
                </div>
              </div>

              <!-- ‚úÖ RESUMEN VISIBLE (W/P/E) -->
              <div class="d-flex flex-column align-items-end gap-1">
                <span class="badge bg-secondary" style="font-weight:900;">
                  {{ p.plan_type or 'Descanso' }}
                </span>

                {% set wtxt = (p.warmup or '').strip() %}
                {% set mtxt = (p.main or '').strip() %}
                {% set ftxt = (p.finisher or '').strip() %}
                {% set has_w = (wtxt|length > 0) %}
                {% set has_m = (mtxt|length > 0) %}
                {% set has_f = (ftxt|length > 0) %}

                <div class="d-flex gap-1 flex-wrap justify-content-end">
                  <span class="badge {% if has_w %}bg-success{% else %}bg-secondary{% endif %}" style="font-weight:900;">W</span>
                  <span class="badge {% if has_m %}bg-info text-dark{% else %}bg-secondary{% endif %}" style="font-weight:900;">P</span>
                  <span class="badge {% if has_f %}bg-warning text-dark{% else %}bg-secondary{% endif %}" style="font-weight:900;">E</span>
                </div>

                {% if has_w or has_m or has_f %}
                  <div class="text-muted small vr-day-lines">
                    {% if has_w %}<div>W: {{ wtxt.splitlines()[0] }}</div>{% endif %}
                    {% if has_m %}<div>P: {{ mtxt.splitlines()[0] }}</div>{% endif %}
                    {% if has_f %}<div>E: {{ ftxt.splitlines()[0] }}</div>{% endif %}
                  </div>
                {% else %}
                  <div class="text-muted small">Sin contenido</div>
                {% endif %}

                <div class="d-flex gap-2 mt-1">
                  <button type="button"
                          class="btn btn-sm btn-outline-info"
                          onclick="expandDay(event, '{{ f.isoformat() }}')"
                          {% if blocked %}disabled{% endif %}>
                    Planificar
                  </button>

                  <button type="button"
                          class="btn btn-sm btn-outline-light d-none"
                          data-close-btn
                          onclick="collapseDay(event)">
                    Cerrar
                  </button>
                </div>
              </div>
            </div>

            <!-- ‚úÖ EDITOR (oculto hasta expand) -->
            <div class="vr-day-editor">

              <form method="post" action="{{ url_for('main.save_day') }}" class="vr-day-body">
                <input type="hidden" name="user_id" value="{{ atleta.id }}">
                <input type="hidden" name="fecha" value="{{ f.isoformat() }}">

                <div class="row g-2">
                  <div class="col-12">
                    <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">TIPO</label>
                    <select class="form-select" name="plan_type" {% if blocked %}disabled{% endif %}>
                      {% set cur = (p.plan_type or 'Descanso')|lower %}
                      <option value="Descanso" {% if cur=='descanso' %}selected{% endif %}>Descanso</option>
                      <option value="Fuerza" {% if cur=='fuerza' %}selected{% endif %}>Fuerza</option>
                      <option value="Run" {% if cur=='run' %}selected{% endif %}>Run</option>
                      <option value="Pista" {% if cur=='pista' %}selected{% endif %}>Pista</option>
                      <option value="Bike" {% if cur=='bike' %}selected{% endif %}>Bike</option>
                      <option value="Swim" {% if cur=='swim' or cur in ['natacion','nataci√≥n'] %}selected{% endif %}>Swim</option>
                    </select>
                  </div>

                  <!-- =========================
                       ‚úÖ WARMUP como BLOQUES (drag & drop)
                  ========================== -->
                  <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                      <label class="text-muted mb-0" style="font-weight:900;letter-spacing:.10em;">WARMUP</label>
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-light" type="button"
                                onclick="addNoteToZone('{{ day_id }}','warmup')"
                                {% if blocked %}disabled{% endif %}>
                          <i class="bi bi-chat-left-text"></i> Nota
                        </button>
                        <button class="btn btn-sm btn-outline-light" type="button"
                                onclick="toggleRaw('{{ day_id }}','warmup')"
                                {% if blocked %}disabled{% endif %}>
                          <i class="bi bi-code-slash"></i> Texto
                        </button>
                      </div>
                    </div>

                    <div class="vr-dropzone mt-2"
                         id="{{ day_id }}_warmup_zone"
                         data-zone="warmup"
                         data-day="{{ day_id }}"
                         {% if blocked %}data-disabled="1"{% endif %}>
                      <div class="vr-dropzone-hint">
                        Arrastr√° aqu√≠ rutinas / ejercicios / notas (WARMUP)
                      </div>
                      <div class="vr-zone-list" id="{{ day_id }}_warmup_list"></div>
                    </div>

                    <textarea class="form-control mt-2 d-none"
                              name="warmup_raw"
                              id="{{ day_id }}_warmup_raw"
                              rows="3"
                              {% if blocked %}disabled{% endif %}>{{ p.warmup or '' }}</textarea>

                    <textarea class="form-control d-none"
                              name="warmup"
                              id="{{ day_id }}_warmup_submit"
                              rows="1"
                              {% if blocked %}disabled{% endif %}>{{ p.warmup or '' }}</textarea>
                  </div>

                  <!-- =========================
                       ‚úÖ BLOQUES 1..4
                  ========================== -->
                  <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                      <div class="text-muted" style="font-weight:950;letter-spacing:.14em;text-transform:uppercase;">
                        Principal (hasta 4 bloques)
                      </div>
                      <button class="btn btn-sm btn-outline-light" type="button"
                              onclick="fillFromMain('{{ day_id }}')" {% if blocked %}disabled{% endif %}>
                        <i class="bi bi-magic"></i> Autocargar desde Main
                      </button>
                    </div>

                    <input type="hidden" name="main" id="{{ day_id }}_main" value="{{ p.main or '' }}">

                    {% for i in range(1,5) %}
                      <div class="mt-2 p-2 vr-block-wrap"
                           id="{{ day_id }}_block{{ i }}"
                           data-day="{{ day_id }}"
                           data-block="{{ i }}"
                           {% if blocked %}data-disabled="1"{% endif %}
                           style="border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.18);">
                        <div class="d-flex justify-content-between align-items-center">
                          <div class="text-muted" style="font-weight:950;letter-spacing:.12em;">BLOQUE {{ i }}</div>
                          <div class="d-flex gap-2 align-items-center">
                            <span class="badge bg-dark" id="{{ day_id }}_b{{i}}_badge">‚Äî</span>
                            <span class="badge bg-secondary-subtle text-dark border vr-drop-badge">
                              Drop aqu√≠
                            </span>
                          </div>
                        </div>

                        <div class="row g-2 mt-1">
                          <div class="col-md-4">
                            <label class="text-muted" style="font-weight:900;">Tipo</label>
                            <select class="form-select"
                                    name="b{{i}}_type"
                                    id="{{ day_id }}_b{{i}}_type"
                                    onchange="syncBlockUI('{{ day_id }}', {{ i }})"
                                    {% if blocked %}disabled{% endif %}>
                              <option value="">(vac√≠o)</option>
                              <option value="TABATA">TABATA</option>
                              <option value="FUERZA">FUERZA</option>
                              <option value="STRETCH">STRETCH</option>
                              <option value="EJ">EJ (ejercicio suelto)</option>
                              <option value="RUN">RUN</option>
                              <option value="BIKE">BIKE</option>
                              <option value="SWIM">SWIM</option>
                              <option value="FREE">FREE</option>
                              <option value="NOTE">NOTE</option>
                            </select>
                          </div>

                          <div class="col-md-4" id="{{ day_id }}_b{{i}}_rutina_wrap">
                            <label class="text-muted" style="font-weight:900;">Rutina</label>
                            <select class="form-select" name="b{{i}}_rutina" id="{{ day_id }}_b{{i}}_rutina"
                                    {% if blocked %}disabled{% endif %}>
                              <option value="">(seleccionar)</option>
                              {% for r in rutinas %}
                                <option value="{{ r.id }}">{{ r.nombre }}</option>
                              {% endfor %}
                            </select>
                          </div>

                          <div class="col-md-8" id="{{ day_id }}_b{{i}}_text_wrap">
                            <label class="text-muted" style="font-weight:900;">Texto</label>
                            <input class="form-control" name="b{{i}}_text" id="{{ day_id }}_b{{i}}_text"
                                   placeholder="Ej: 10km suave / 6x400 / 60' Z2 / t√©cnica / comentario"
                                   {% if blocked %}disabled{% endif %}>
                          </div>

                          <div class="col-md-8" id="{{ day_id }}_b{{i}}_ej_wrap">
                            <label class="text-muted" style="font-weight:900;">Ejercicio (Banco)</label>

                            <select class="form-select"
                                    id="{{ day_id }}_b{{i}}_ej_select"
                                    onchange="syncEjToText('{{ day_id }}', {{ i }})"
                                    {% if blocked %}disabled{% endif %}>
                              <option value="">(seleccionar ejercicio)</option>
                              {% for g in muscle_groups_order %}
                                {% set arr = ejercicios_por_grupo.get(g, []) %}
                                {% if arr and arr|length %}
                                  <optgroup label="{{ g }}">
                                    {% for e in arr %}
                                      <option value="{{ e.id }}">{{ e.nombre }}</option>
                                    {% endfor %}
                                  </optgroup>
                                {% endif %}
                              {% endfor %}
                            </select>

                            <div class="d-flex gap-2 mt-2">
                              <input class="form-control"
                                     name="b{{i}}_text"
                                     id="{{ day_id }}_b{{i}}_ej_text"
                                     placeholder="ID ejercicio (auto) ¬∑ ej: 123"
                                     {% if blocked %}disabled{% endif %}>
                              <button class="btn btn-outline-light" type="button"
                                      onclick="openEjPreview('{{ day_id }}', {{ i }})" {% if blocked %}disabled{% endif %}>
                                <i class="bi bi-eye"></i>
                              </button>
                            </div>

                            <div class="text-muted small mt-1">
                              Se guarda como <span class="badge bg-dark border">EJ:&lt;id&gt;</span> (video y descripci√≥n aparecen en el perfil del atleta).
                            </div>
                          </div>
                        </div>
                      </div>
                    {% endfor %}
                  </div>

                  <!-- =========================
                       ‚úÖ ENFRIAMIENTO como BLOQUES
                  ========================== -->
                  <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                      <label class="text-muted mb-0" style="font-weight:900;letter-spacing:.10em;">ENFRIAMIENTO</label>
                      <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-light" type="button"
                                onclick="addNoteToZone('{{ day_id }}','finisher')"
                                {% if blocked %}disabled{% endif %}>
                          <i class="bi bi-chat-left-text"></i> Nota
                        </button>
                        <button class="btn btn-sm btn-outline-light" type="button"
                                onclick="toggleRaw('{{ day_id }}','finisher')"
                                {% if blocked %}disabled{% endif %}>
                          <i class="bi bi-code-slash"></i> Texto
                        </button>
                      </div>
                    </div>

                    <div class="vr-dropzone mt-2"
                         id="{{ day_id }}_finisher_zone"
                         data-zone="finisher"
                         data-day="{{ day_id }}"
                         {% if blocked %}data-disabled="1"{% endif %}>
                      <div class="vr-dropzone-hint">
                        Arrastr√° aqu√≠ rutinas / ejercicios / notas (COOLDOWN)
                      </div>
                      <div class="vr-zone-list" id="{{ day_id }}_finisher_list"></div>
                    </div>

                    <textarea class="form-control mt-2 d-none"
                              name="finisher_raw"
                              id="{{ day_id }}_finisher_raw"
                              rows="3"
                              {% if blocked %}disabled{% endif %}>{{ p.finisher or '' }}</textarea>

                    <textarea class="form-control d-none"
                              name="finisher"
                              id="{{ day_id }}_finisher_submit"
                              rows="1"
                              {% if blocked %}disabled{% endif %}>{{ p.finisher or '' }}</textarea>
                  </div>

                  <div class="col-12">
                    <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">SCORE (opcional)</label>
                    <input class="form-control" name="propuesto_score" value="{{ p.propuesto_score or 0 }}" {% if blocked %}disabled{% endif %}>
                  </div>

                  <div class="col-12 d-grid">
                    <button class="btn btn-primary" type="submit" {% if blocked %}disabled{% endif %}>
                      üíæ Guardar d√≠a
                    </button>
                  </div>

                </div>
              </form>

              {% if blocked %}
                <div class="text-muted mt-2" style="font-size:.92rem;">
                  Este d√≠a est√° bloqueado por el atleta. Si quer√©s replanificar, pedile que lo desbloquee desde su perfil.
                </div>
              {% endif %}

            </div><!-- /vr-day-editor -->

          </div>
        {% endfor %}
      </div>

    </div>

    <!-- DERECHA: sidebar -->
    <div class="vr-sidebar">
      <div class="card glass p-3 p-md-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <div style="font-weight:950;letter-spacing:.14em;text-transform:uppercase;">Banco</div>
            <div class="text-muted" style="font-size:.95rem;">Rutinas + Ejercicios agrupados</div>
          </div>
          <a class="btn btn-sm btn-outline-info" href="{{ url_for('main.dashboard_entrenador') }}">
            <i class="bi bi-boxes"></i> Gestionar
          </a>
        </div>

        <hr>

        <div class="text-muted" style="font-weight:950;letter-spacing:.14em;text-transform:uppercase;">Rutinas (arrastrables)</div>
        <div class="mt-2" style="max-height:260px; overflow:auto;">
          {% for r in rutinas %}
            <div class="d-flex justify-content-between align-items-center py-2"
                 style="border-bottom:1px dashed rgba(255,255,255,.10);">
              <div style="font-weight:900;" class="d-flex align-items-center gap-2">
                <span class="vr-drag-item badge bg-dark border"
                      draggable="true"
                      data-kind="rutina"
                      data-id="{{ r.id }}"
                      data-name="{{ r.nombre|e }}"
                      data-type="FUERZA"
                      title="Arrastrar">
                  <i class="bi bi-grip-vertical"></i>
                </span>
                <span>{{ r.nombre }}</span>
              </div>
              <a class="btn btn-sm btn-outline-light" href="{{ url_for('main.rutina_builder', rutina_id=r.id) }}">
                Builder
              </a>
            </div>
          {% endfor %}
          <div class="text-muted small mt-2">
            Tip: por defecto una rutina cae como <span class="badge bg-dark border">FUERZA</span>.
            Si quer√©s que caiga como TABATA o STRETCH, elegilo luego en el bloque (o lo cambi√°s en el warmup/cooldown).
          </div>
        </div>

        <hr>

        <div class="text-muted" style="font-weight:950;letter-spacing:.14em;text-transform:uppercase;">Ejercicios (arrastrables)</div>

        <div class="accordion mt-2" id="accGroups">
          {% for g in muscle_groups_order %}
            {% set arr = ejercicios_por_grupo.get(g, []) %}
            {% if arr and arr|length %}
              <div class="accordion-item" style="background:transparent;border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:hidden;margin-bottom:10px;">
                <h2 class="accordion-header" id="h_{{ g|replace(' ','_') }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                          data-bs-target="#c_{{ g|replace(' ','_') }}">
                    <span style="font-weight:950;letter-spacing:.10em;">{{ g }}</span>
                    <span class="ms-2 text-muted">({{ arr|length }})</span>
                  </button>
                </h2>
                <div id="c_{{ g|replace(' ','_') }}" class="accordion-collapse collapse" data-bs-parent="#accGroups">
                  <div class="accordion-body" style="background:rgba(0,0,0,.18);">
                    {% for e in arr %}
                      <div class="py-2" style="border-bottom:1px dashed rgba(255,255,255,.10);">
                        <div class="d-flex align-items-center gap-2">
                          <span class="vr-drag-item badge bg-dark border"
                                draggable="true"
                                data-kind="ej"
                                data-id="{{ e.id }}"
                                data-name="{{ e.nombre|e }}"
                                title="Arrastrar">
                            <i class="bi bi-grip-vertical"></i>
                          </span>
                          <div style="font-weight:900;">{{ e.nombre }}</div>
                        </div>
                        <div class="text-muted" style="font-size:.92rem;">{{ e.categoria or '' }}</div>
                        {% if e.video_url %}
                          <div class="mt-2">
                            <video controls preload="metadata" style="width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);">
                              <source src="{{ e.video_url }}" type="video/mp4">
                            </video>
                          </div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

      </div>
    </div>

  </div>

  {% endif %}
</div>

<!-- Modal preview ejercicio -->
<div class="modal fade" id="ejPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light border border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="ejPreviewTitle">Ejercicio</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="ejPreviewBody">
        <div class="text-muted">Seleccion√° un ejercicio para previsualizar.</div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- SortableJS (solo front, no cambia arquitectura) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>

<script>
/* ============================================================
   ‚úÖ EXPAND / COLLAPSE D√çA (sin romper nada)
============================================================ */
function expandDay(ev, iso){
  ev.preventDefault();
  ev.stopPropagation();

  document.querySelectorAll('.vr-day-card.is-active').forEach(el => {
    el.classList.remove('is-active');
    el.classList.add('vr-day-collapsed');
    const closeBtn = el.querySelector('[data-close-btn]');
    if(closeBtn) closeBtn.classList.add('d-none');
  });

  const card = document.querySelector(`.vr-day-card[data-day="${CSS.escape(iso)}"]`);
  if(!card) return;

  card.classList.add('is-active');
  card.classList.remove('vr-day-collapsed');

  const closeBtn = card.querySelector('[data-close-btn]');
  if(closeBtn) closeBtn.classList.remove('d-none');

  const editor = card.querySelector('.vr-day-editor');
  if(editor){
    setTimeout(() => editor.scrollIntoView({behavior:'smooth', block:'start'}), 80);
  }
}

function collapseDay(ev){
  ev.preventDefault();
  ev.stopPropagation();
  const card = ev.target.closest('.vr-day-card');
  if(!card) return;
  card.classList.remove('is-active');
  card.classList.add('vr-day-collapsed');
  const closeBtn = card.querySelector('[data-close-btn]');
  if(closeBtn) closeBtn.classList.add('d-none');
}

/* click en header abre */
document.addEventListener('click', (e) => {
  const header = e.target.closest('.vr-day-clickable');
  if(!header) return;
  const card = header.closest('.vr-day-card');
  if(!card) return;
  if(e.target.closest('button, a, input, select, textarea')) return;
  if(card.classList.contains('is-active')) return;
  const iso = card.getAttribute('data-day');
  expandDay(e, iso);
});

/**
 * OBJETIVO: drag & drop SIN tocar backend.
 * Guardamos warmup/finisher como textarea con l√≠neas tipo:
 *  FUERZA:RUTINA:12
 *  TABATA:RUTINA:5
 *  STRETCH:RUTINA:7
 *  EJ:34
 *  NOTE:algo
 *  FREE:algo
 */

function syncBlockUI(dayId, i){
  const sel = document.getElementById(`${dayId}_b${i}_type`);
  const val = (sel.value || "").toUpperCase();

  const rutWrap = document.getElementById(`${dayId}_b${i}_rutina_wrap`);
  const txtWrap = document.getElementById(`${dayId}_b${i}_text_wrap`);
  const ejWrap  = document.getElementById(`${dayId}_b${i}_ej_wrap`);
  const badge   = document.getElementById(`${dayId}_b${i}_badge`);

  badge.textContent = val || "‚Äî";
  badge.className = "badge " + (
    val === "TABATA"  ? "bg-danger" :
    val === "FUERZA"  ? "bg-info" :
    val === "STRETCH" ? "bg-success" :
    val === "EJ"      ? "bg-warning text-dark" :
    val === "RUN"     ? "bg-success" :
    val === "BIKE"    ? "bg-warning text-dark" :
    val === "SWIM"    ? "bg-primary" :
    val === "FREE"    ? "bg-secondary" :
    val === "NOTE"    ? "bg-light text-dark" : "bg-dark"
  );

  rutWrap.style.display = "none";
  txtWrap.style.display = "none";
  ejWrap.style.display  = "none";

  if(val === "TABATA" || val === "FUERZA" || val === "STRETCH"){
    rutWrap.style.display = "";
  } else if(val === "EJ"){
    ejWrap.style.display = "";
  } else if(val){
    txtWrap.style.display = "";
  }
}

function extractRutinaId(line){
  const s = String(line||"").trim();
  const up = s.toUpperCase().replaceAll(" ", "");
  if(up.includes("RUTINA:")){
    const after = up.split("RUTINA:")[1] || "";
    const n = parseInt(after, 10);
    return Number.isFinite(n) ? String(n) : "";
  }
  const n2 = parseInt(s, 10);
  return Number.isFinite(n2) ? String(n2) : "";
}

function extractEjId(line){
  const s = String(line||"").trim();
  const up = s.toUpperCase().replaceAll(" ", "");
  if(up.startsWith("EJ:")){
    const after = up.split("EJ:")[1] || "";
    const n = parseInt(after, 10);
    return Number.isFinite(n) ? String(n) : "";
  }
  if(up.startsWith("EJERCICIO:")){
    const after = up.split("EJERCICIO:")[1] || "";
    const n = parseInt(after, 10);
    return Number.isFinite(n) ? String(n) : "";
  }
  const n2 = parseInt(s, 10);
  return Number.isFinite(n2) ? String(n2) : "";
}

function parseMainToBlocks(mainText){
  const lines = String(mainText||"").split("\n").map(x => x.trim()).filter(Boolean);
  const out = [];
  for(const line of lines){
    const up = line.toUpperCase();
    if(up.startsWith("TABATA:")){
      out.push({type:"TABATA", rutina: extractRutinaId(line), text:"", ej:""}); continue;
    }
    if(up.startsWith("FUERZA:")){
      out.push({type:"FUERZA", rutina: extractRutinaId(line), text:"", ej:""}); continue;
    }
    if(up.startsWith("STRETCH:") || up.startsWith("ESTIRAMIENTOS:")){
      out.push({type:"STRETCH", rutina: extractRutinaId(line), text:"", ej:""}); continue;
    }
    if(up.startsWith("EJ:") || up.startsWith("EJERCICIO:")){
      out.push({type:"EJ", rutina:"", text:"", ej: extractEjId(line)}); continue;
    }
    if(up.startsWith("RUN:")){
      out.push({type:"RUN", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""}); continue;
    }
    if(up.startsWith("BIKE:")){
      out.push({type:"BIKE", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""}); continue;
    }
    if(up.startsWith("SWIM:") || up.startsWith("NATACION:") || up.startsWith("NATACI√ìN:")){
      out.push({type:"SWIM", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""}); continue;
    }
    if(up.startsWith("FREE:")){
      out.push({type:"FREE", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""}); continue;
    }
    if(up.startsWith("NOTE:") || up.startsWith("NOTA:")){
      out.push({type:"NOTE", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""}); continue;
    }

    const rid = extractRutinaId(line);
    if(rid){
      out.push({type:"FUERZA", rutina: rid, text:"", ej:""});
    }else{
      out.push({type:"FREE", rutina:"", text: line, ej:""});
    }
  }
  return out.slice(0,4);
}

function fillFromMain(dayId){
  const mainEl = document.getElementById(`${dayId}_main`);
  const main = (mainEl && mainEl.value) ? mainEl.value : "";
  const blocks = parseMainToBlocks(main);

  for(let i=1; i<=4; i++){
    const b = blocks[i-1] || {type:"", rutina:"", text:"", ej:""};

    const typeEl = document.getElementById(`${dayId}_b${i}_type`);
    const rutEl  = document.getElementById(`${dayId}_b${i}_rutina`);
    const txtEl  = document.getElementById(`${dayId}_b${i}_text`);

    const ejSelect = document.getElementById(`${dayId}_b${i}_ej_select`);
    const ejText   = document.getElementById(`${dayId}_b${i}_ej_text`);

    typeEl.value = b.type || "";
    if(rutEl) rutEl.value = b.rutina || "";
    if(txtEl) txtEl.value = b.text || "";
    if(ejText) ejText.value = b.ej || "";
    if(ejSelect) ejSelect.value = b.ej || "";

    syncBlockUI(dayId, i);
  }
}

function syncEjToText(dayId, i){
  const ejSelect = document.getElementById(`${dayId}_b${i}_ej_select`);
  const ejText   = document.getElementById(`${dayId}_b${i}_ej_text`);
  if(!ejSelect || !ejText) return;
  ejText.value = ejSelect.value || "";
}

function openEjPreview(dayId, i){
  const ejText   = document.getElementById(`${dayId}_b${i}_ej_text`);
  const ejSelect = document.getElementById(`${dayId}_b${i}_ej_select`);
  const id = (ejText && ejText.value) ? ejText.value.trim() : (ejSelect && ejSelect.value ? ejSelect.value : "");
  const title = document.getElementById("ejPreviewTitle");
  const body  = document.getElementById("ejPreviewBody");
  const modalEl = document.getElementById("ejPreviewModal");

  if(!id){
    title.textContent = "Ejercicio";
    body.innerHTML = `<div class="text-muted">Seleccion√° un ejercicio primero.</div>`;
    new bootstrap.Modal(modalEl).show();
    return;
  }

  let name = "";
  if(ejSelect){
    const opt = ejSelect.querySelector(`option[value="${CSS.escape(id)}"]`);
    if(opt) name = opt.textContent || "";
  }

  title.textContent = name ? `EJ ${id} ¬∑ ${name}` : `EJ ${id}`;
  body.innerHTML = `
    <div class="text-soft">Este bloque se guardar√° como:</div>
    <div class="mt-2"><span class="badge bg-dark border">EJ:${id}</span></div>
    <div class="text-muted small mt-3">El video y la descripci√≥n se ver√°n en el perfil del atleta.</div>
  `;

  new bootstrap.Modal(modalEl).show();
}

/* =========================
   Warmup/Cooldown UI (bloques)
========================= */

function toggleRaw(dayId, zone){
  const raw = document.getElementById(`${dayId}_${zone}_raw`);
  if(!raw) return;
  raw.classList.toggle("d-none");
}

function zoneLineFromItem(item){
  if(item.kind === "rutina"){
    const t = (item.type || "FUERZA").toUpperCase();
    return `${t}:RUTINA:${item.id}`;
  }
  if(item.kind === "ej"){
    return `EJ:${item.id}`;
  }
  if(item.kind === "note"){
    return `NOTE:${(item.text||"").trim()}`;
  }
  return "";
}

function parseZoneLines(text){
  const lines = String(text||"").split("\n").map(x => x.trim()).filter(Boolean);
  const items = [];
  for(const line of lines){
    const up = line.toUpperCase();
    if(up.startsWith("EJ:") || up.startsWith("EJERCICIO:")){
      items.push({kind:"ej", id: extractEjId(line), name:"Ejercicio"});
      continue;
    }
    if(up.startsWith("TABATA:") || up.startsWith("FUERZA:") || up.startsWith("STRETCH:") || up.startsWith("ESTIRAMIENTOS:")){
      const t = up.startsWith("TABATA:") ? "TABATA" : (up.startsWith("STRETCH:") || up.startsWith("ESTIRAMIENTOS:")) ? "STRETCH" : "FUERZA";
      items.push({kind:"rutina", type:t, id: extractRutinaId(line), name:"Rutina"});
      continue;
    }
    if(up.startsWith("NOTE:") || up.startsWith("NOTA:")){
      items.push({kind:"note", text: line.split(":",2)[1]?.trim() || ""});
      continue;
    }
    if(up.startsWith("FREE:")){
      items.push({kind:"note", text: line.split(":",2)[1]?.trim() || ""});
      continue;
    }
    items.push({kind:"note", text: line});
  }
  return items;
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function renderZoneItem(dayId, zone, item){
  const el = document.createElement("div");
  el.className = "vr-zone-item";
  el.setAttribute("data-kind", item.kind);

  if(item.kind === "rutina"){
    el.setAttribute("data-id", item.id || "");
    el.setAttribute("data-type", (item.type || "FUERZA").toUpperCase());
    const t = (item.type || "FUERZA").toUpperCase();
    el.innerHTML = `
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-dark border"><i class="bi bi-grip-vertical"></i></span>
          <span class="badge ${t==='TABATA'?'bg-danger':t==='STRETCH'?'bg-success':'bg-info'}" style="font-weight:900;">${t}</span>
          <span class="text-soft" style="font-weight:900;">Rutina #${item.id}</span>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-sm btn-outline-light" onclick="cycleRutinaType(this)"><i class="bi bi-arrow-repeat"></i></button>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeZoneItem(this)"><i class="bi bi-x-lg"></i></button>
        </div>
      </div>
    `;
  } else if(item.kind === "ej"){
    el.setAttribute("data-id", item.id || "");
    el.innerHTML = `
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-dark border"><i class="bi bi-grip-vertical"></i></span>
          <span class="badge bg-warning text-dark" style="font-weight:900;">EJ</span>
          <span class="text-soft" style="font-weight:900;">Ejercicio #${item.id}</span>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeZoneItem(this)"><i class="bi bi-x-lg"></i></button>
      </div>
    `;
  } else {
    const txt = (item.text || "").trim();
    el.setAttribute("data-text", txt);
    el.innerHTML = `
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div class="d-flex align-items-center gap-2">
          <span class="badge bg-dark border"><i class="bi bi-grip-vertical"></i></span>
          <span class="badge bg-light text-dark" style="font-weight:900;">NOTE</span>
          <span class="text-soft">${escapeHtml(txt || "‚Äî")}</span>
        </div>
        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeZoneItem(this)"><i class="bi bi-x-lg"></i></button>
      </div>
    `;
  }

  el.setAttribute("data-day", dayId);
  el.setAttribute("data-zone", zone);
  return el;
}

function removeZoneItem(btn){
  const item = btn.closest(".vr-zone-item");
  if(!item) return;
  const dayId = item.getAttribute("data-day");
  const zone  = item.getAttribute("data-zone");
  item.remove();
  syncZoneToTextarea(dayId, zone);
  updateZoneHint(dayId, zone);
}

function cycleRutinaType(btn){
  const item = btn.closest(".vr-zone-item");
  if(!item) return;
  const cur = (item.getAttribute("data-type") || "FUERZA").toUpperCase();
  const next = cur === "FUERZA" ? "TABATA" : (cur === "TABATA" ? "STRETCH" : "FUERZA");
  item.setAttribute("data-type", next);

  const badge = item.querySelector(".badge.bg-info, .badge.bg-danger, .badge.bg-success");
  if(badge){
    badge.textContent = next;
    badge.className = "badge " + (next==='TABATA'?'bg-danger':(next==='STRETCH'?'bg-success':'bg-info'));
    badge.style.fontWeight = "900";
  }

  const dayId = item.getAttribute("data-day");
  const zone  = item.getAttribute("data-zone");
  syncZoneToTextarea(dayId, zone);
}

function addNoteToZone(dayId, zone){
  const z = document.getElementById(`${dayId}_${zone}_list`);
  if(!z) return;
  const txt = prompt("Nota / comentario:");
  if(txt === null) return;
  const item = renderZoneItem(dayId, zone, {kind:"note", text: txt});
  z.appendChild(item);
  syncZoneToTextarea(dayId, zone);
  updateZoneHint(dayId, zone);
}

function syncZoneToTextarea(dayId, zone){
  const list = document.getElementById(`${dayId}_${zone}_list`);
  const raw  = document.getElementById(`${dayId}_${zone}_raw`);
  const sub  = document.getElementById(`${dayId}_${zone}_submit`);
  if(!list || !sub) return;

  const items = Array.from(list.querySelectorAll(".vr-zone-item")).map(el => {
    const kind = el.getAttribute("data-kind") || "note";
    if(kind === "rutina"){
      return {kind:"rutina", id: el.getAttribute("data-id"), type: el.getAttribute("data-type") || "FUERZA"};
    }
    if(kind === "ej"){
      return {kind:"ej", id: el.getAttribute("data-id")};
    }
    return {kind:"note", text: el.getAttribute("data-text") || ""};
  });

  const lines = items.map(zoneLineFromItem).filter(Boolean);
  sub.value = lines.join("\n");
  if(raw) raw.value = sub.value;
}

function hydrateZoneFromTextarea(dayId, zone){
  const sub  = document.getElementById(`${dayId}_${zone}_submit`);
  const list = document.getElementById(`${dayId}_${zone}_list`);
  const hint = document.querySelector(`#${dayId}_${zone}_zone .vr-dropzone-hint`);
  if(!sub || !list) return;

  list.innerHTML = "";
  const items = parseZoneLines(sub.value || "");
  for(const it of items){
    list.appendChild(renderZoneItem(dayId, zone, it));
  }
  if(hint){
    hint.style.display = (items.length ? "none" : "");
  }
}

function updateZoneHint(dayId, zone){
  const list = document.getElementById(`${dayId}_${zone}_list`);
  const hint = document.querySelector(`#${dayId}_${zone}_zone .vr-dropzone-hint`);
  if(!list || !hint) return;
  hint.style.display = (list.querySelectorAll(".vr-zone-item").length ? "none" : "");
}

/* =========================
   Drag from banco (HTML5 drag)
========================= */

let VR_DRAG = null;

function handleDragStart(e){
  const t = e.currentTarget;
  VR_DRAG = {
    kind: t.getAttribute("data-kind"),
    id: t.getAttribute("data-id"),
    name: t.getAttribute("data-name") || "",
    type: t.getAttribute("data-type") || "FUERZA"
  };
  try{ e.dataTransfer.setData("text/plain", JSON.stringify(VR_DRAG)); }catch(err){}
  e.dataTransfer.effectAllowed = "copy";
}

function getDragPayload(e){
  if(VR_DRAG) return VR_DRAG;
  try{
    const s = e.dataTransfer.getData("text/plain");
    return s ? JSON.parse(s) : null;
  }catch(err){
    return null;
  }
}

function dropIntoZone(e, dayId, zone){
  e.preventDefault();
  const payload = getDragPayload(e);
  if(!payload) return;

  const list = document.getElementById(`${dayId}_${zone}_list`);
  if(!list) return;

  if(payload.kind === "rutina"){
    list.appendChild(renderZoneItem(dayId, zone, {kind:"rutina", id: payload.id, type: payload.type || "FUERZA"}));
  } else if(payload.kind === "ej"){
    list.appendChild(renderZoneItem(dayId, zone, {kind:"ej", id: payload.id}));
  } else {
    list.appendChild(renderZoneItem(dayId, zone, {kind:"note", text: payload.name || ""}));
  }

  syncZoneToTextarea(dayId, zone);
  updateZoneHint(dayId, zone);
}

function dropIntoBlock(e, dayId, blockN){
  e.preventDefault();
  const payload = getDragPayload(e);
  if(!payload) return;

  if(payload.kind === "rutina"){
    const typeEl = document.getElementById(`${dayId}_b${blockN}_type`);
    const rutEl  = document.getElementById(`${dayId}_b${blockN}_rutina`);
    if(typeEl) typeEl.value = "FUERZA";
    if(rutEl) rutEl.value = payload.id || "";
    syncBlockUI(dayId, blockN);
  } else if(payload.kind === "ej"){
    const typeEl = document.getElementById(`${dayId}_b${blockN}_type`);
    const ejSel  = document.getElementById(`${dayId}_b${blockN}_ej_select`);
    const ejTxt  = document.getElementById(`${dayId}_b${blockN}_ej_text`);
    if(typeEl) typeEl.value = "EJ";
    if(ejSel) ejSel.value = payload.id || "";
    if(ejTxt) ejTxt.value = payload.id || "";
    syncBlockUI(dayId, blockN);
  }
}

/* =========================
   Init all
========================= */
(function initAll(){
  const selects = document.querySelectorAll("select[id$='_type']");
  selects.forEach(sel => {
    const m = sel.id.match(/^(day_\d+)_b(\d+)_type$/);
    if(m){
      syncBlockUI(m[1], parseInt(m[2],10));
    }
  });

  document.querySelectorAll(".vr-drag-item").forEach(el => {
    el.addEventListener("dragstart", handleDragStart);
  });

  document.querySelectorAll(".vr-dropzone").forEach(zoneEl => {
    const dayId = zoneEl.getAttribute("data-day");
    const zone  = zoneEl.getAttribute("data-zone");
    const disabled = zoneEl.getAttribute("data-disabled") === "1";
    if(!dayId || !zone || disabled) return;

    hydrateZoneFromTextarea(dayId, zone);
    updateZoneHint(dayId, zone);

    zoneEl.addEventListener("dragover", (e)=>{ e.preventDefault(); });
    zoneEl.addEventListener("drop", (e)=> dropIntoZone(e, dayId, zone));

    const list = document.getElementById(`${dayId}_${zone}_list`);
    if(list){
      new Sortable(list, {
        animation: 150,
        handle: ".bi-grip-vertical",
        onEnd: () => {
          syncZoneToTextarea(dayId, zone);
          updateZoneHint(dayId, zone);
        }
      });
    }

    const raw = document.getElementById(`${dayId}_${zone}_raw`);
    if(raw){
      raw.addEventListener("input", ()=>{
        const sub = document.getElementById(`${dayId}_${zone}_submit`);
        if(sub) sub.value = raw.value;
        hydrateZoneFromTextarea(dayId, zone);
        updateZoneHint(dayId, zone);
      });
    }
  });

  document.querySelectorAll(".vr-block-wrap").forEach(blockEl => {
    const dayId = blockEl.getAttribute("data-day");
    const bn = parseInt(blockEl.getAttribute("data-block") || "0", 10);
    const disabled = blockEl.getAttribute("data-disabled") === "1";
    if(!dayId || !bn || disabled) return;

    blockEl.addEventListener("dragover", (e)=>{ e.preventDefault(); });
    blockEl.addEventListener("drop", (e)=> dropIntoBlock(e, dayId, bn));
  });
})();
</script>

<style>
/* =========================
   Dropzone (tu estilo original)
========================= */
.vr-dropzone{
  border:1px dashed rgba(255,255,255,.18);
  border-radius:14px;
  padding:10px;
  background: rgba(0,0,0,.14);
}
.vr-dropzone:hover{ border-color: rgba(13,202,240,.55); }
.vr-dropzone-hint{
  color: rgba(255,255,255,.55);
  font-size: .92rem;
  font-weight: 700;
  letter-spacing: .06em;
  margin-bottom: 8px;
}
.vr-zone-list{ display:flex; flex-direction:column; gap:8px; }
.vr-zone-item{
  border:1px solid rgba(255,255,255,.10);
  border-radius:14px;
  padding:10px;
  background: rgba(0,0,0,.18);
}
.vr-drop-badge{ font-weight: 900; letter-spacing: .08em; }
.vr-drag-item{ cursor: grab; }
.vr-drag-item:active{ cursor: grabbing; }

/* =========================
   ‚úÖ 7 d√≠as + expand premium
========================= */
.vr-days-grid-7{
  display:grid;
  grid-template-columns: repeat(7, minmax(0, 1fr));
  gap: 14px;
}
@media (max-width: 1400px){ .vr-days-grid-7{ grid-template-columns: repeat(4, minmax(0, 1fr)); } }
@media (max-width: 1100px){ .vr-days-grid-7{ grid-template-columns: repeat(2, minmax(0, 1fr)); } }
@media (max-width: 780px){  .vr-days-grid-7{ grid-template-columns: 1fr; } }

.vr-day-card{
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.06);
  padding: 14px;
  overflow: hidden;
}

.vr-day-lines{
  max-width:260px;
  text-align:right;
  opacity:.9;
}

.vr-day-editor{
  display:none;
  margin-top: 12px;
  padding-top: 12px;
  border-top: 1px solid rgba(255,255,255,.10);
}

.vr-day-card.is-active{
  grid-column: 1 / -1;
  border-color: rgba(34,211,238,.35);
  box-shadow: 0 0 0 2px rgba(34,211,238,.14), 0 20px 60px rgba(0,0,0,.55);
  background: rgba(255,255,255,.07);
}
.vr-day-card.is-active .vr-day-editor{ display:block; }

.vr-day-clickable{ cursor: pointer; }
.vr-day-clickable:active{ transform: scale(.998); }
</style>
{% endblock %}
