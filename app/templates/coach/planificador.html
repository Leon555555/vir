{% extends "layout.html" %}
{% block title %}Planificador ‚Äî {{ atleta.nombre if atleta else 'Coach' }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- HEADER -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <div>
      <div class="section-title">üìÖ PLANIFICADOR</div>
      {% if atleta %}
        <div class="text-soft">Atleta: <strong class="text-light">{{ atleta.nombre }}</strong> ¬∑ Semana: <strong>{{ semana_str }}</strong></div>
      {% else %}
        <div class="text-soft">No hay atleta seleccionado</div>
      {% endif %}
    </div>

    <div class="d-flex gap-2 align-items-center">
      <a class="btn btn-outline-info btn-sm" href="{{ url_for('main.dashboard_entrenador') }}">
        ‚Üê Dashboard
      </a>

      {% if atleta %}
      <form method="post"
            action="{{ url_for('main.coach_copiar_semana', user_id=atleta.id) }}"
            onsubmit="return confirm('¬øCopiar toda esta semana a la siguiente?');">
        <input type="hidden" name="center" value="{{ center.isoformat() }}">
        <button class="btn btn-outline-warning btn-sm">
          üìã Copiar semana ‚Üí siguiente
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  <div class="row g-3">

    <!-- LEFT: SEMANA -->
    <div class="col-lg-7">
      {% if not atleta %}
        <div class="alert alert-warning">No hay atletas disponibles.</div>
      {% else %}
        <div class="row g-3">
          {% for f in fechas %}
            {% set plan = planes[f] %}
            <div class="col-md-6">
              <div class="card glass lift h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <strong>{{ f.strftime('%a %d/%m')|upper }}</strong>
                  <span class="badge bg-info">{{ (plan.plan_type or 'Descanso')|capitalize }}</span>
                </div>

                <div class="card-body">
                  {% if plan.puede_entrenar == 'no' %}
                    <div class="alert alert-warning py-2 mb-2">
                      üö´ El atleta marc√≥: <strong>No puedo entrenar</strong>
                      {% if plan.comentario_atleta %}
                        <div class="small text-muted mt-1">{{ plan.comentario_atleta }}</div>
                      {% endif %}
                    </div>
                  {% endif %}

                  <form method="post" action="{{ url_for('main.save_day') }}">
                    <input type="hidden" name="user_id" value="{{ atleta.id }}">
                    <input type="hidden" name="fecha" value="{{ f.isoformat() }}">

                    <div class="mb-2">
                      <label class="form-label small text-muted mb-1">Tipo</label>
                      {% set t = (plan.plan_type or 'Descanso') %}
                      <select name="plan_type" class="form-select form-select-sm">
                        <option value="Descanso" {% if t=='Descanso' %}selected{% endif %}>Descanso</option>
                        <option value="Fuerza" {% if t=='Fuerza' %}selected{% endif %}>Fuerza</option>
                        <option value="Run" {% if t=='Run' %}selected{% endif %}>Run</option>
                        <option value="Bike" {% if t=='Bike' %}selected{% endif %}>Bike</option>
                        <option value="Swim" {% if t=='Swim' %}selected{% endif %}>Swim</option>
                      </select>
                    </div>

                    <div class="mb-2">
                      <label class="form-label small text-muted mb-1">Calentamiento</label>
                      <input name="warmup" class="form-control form-control-sm" value="{{ plan.warmup or '' }}"
                             placeholder="Ej: movilidad + skipping...">
                    </div>

                    <!-- BLOQUES (4) -->
                    <div class="mb-2">
                      <label class="form-label small text-muted mb-1">Bloques (TABATA / FUERZA / RUN / BIKE / SWIM / FREE / NOTE)</label>

                      {% for i in range(1,5) %}
                      <div class="row g-2 mb-2">
                        <div class="col-4">
                          <select class="form-select form-select-sm" name="b{{i}}_type">
                            <option value="">‚Äî</option>
                            <option value="TABATA">TABATA</option>
                            <option value="FUERZA">FUERZA</option>
                            <option value="RUN">RUN</option>
                            <option value="BIKE">BIKE</option>
                            <option value="SWIM">SWIM</option>
                            <option value="FREE">FREE</option>
                            <option value="NOTE">NOTE</option>
                          </select>
                        </div>

                        <div class="col-4">
                          <select class="form-select form-select-sm" name="b{{i}}_rutina">
                            <option value="">Rutina (si aplica)</option>
                            {% for r in rutinas %}
                              <option value="{{ r.id }}">{{ r.nombre }}{% if r.tipo %} ({{ r.tipo }}){% endif %}</option>
                            {% endfor %}
                          </select>
                        </div>

                        <div class="col-4">
                          <input class="form-control form-control-sm" name="b{{i}}_text" placeholder="Texto (si aplica)">
                        </div>
                      </div>
                      {% endfor %}

                      <div class="form-text text-muted">
                        TIP: TABATA y FUERZA usan rutina. RUN/BIKE/SWIM/FREE/NOTE usan texto.
                      </div>
                    </div>

                    <div class="mb-2">
                      <label class="form-label small text-muted mb-1">Finisher</label>
                      <input name="finisher" class="form-control form-control-sm" value="{{ plan.finisher or '' }}"
                             placeholder="Ej: core 8'...">
                    </div>

                    <div class="row g-2">
                      <div class="col-6">
                        <label class="form-label small text-muted mb-1">Score</label>
                        <input type="number" name="propuesto_score" class="form-control form-control-sm"
                               value="{{ plan.propuesto_score or 0 }}">
                      </div>
                      <div class="col-6 d-flex align-items-end">
                        <button type="submit" class="btn btn-info w-100 btn-sm">
                          üíæ Guardar d√≠a
                        </button>
                      </div>
                    </div>

                    <!-- fallback legacy main (por si quer√©s pegar texto manual) -->
                    <div class="mt-3">
                      <label class="form-label small text-muted mb-1">Main (legacy opcional)</label>
                      <textarea name="main" class="form-control form-control-sm" rows="2"
                                placeholder="Si no us√°s bloques, pod√©s pegar main ac√°.">{{ plan.main or '' }}</textarea>
                    </div>

                  </form>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- RIGHT: BANCO POR GRUPO MUSCULAR -->
    <div class="col-lg-5">
      <div class="card glass">
        <div class="card-header d-flex justify-content-between align-items-center">
          <strong>üèãÔ∏è Banco de ejercicios (por m√∫sculo)</strong>
          <span class="badge bg-secondary">
            {% if ejercicios_por_grupo %}
              {{ ejercicios_por_grupo|length }} grupos
            {% else %}
              0
            {% endif %}
          </span>
        </div>

        <div class="card-body">
          <div class="accordion" id="accMuscles">
            {% for g in muscle_groups_order %}
              {% set items = ejercicios_por_grupo.get(g) if ejercicios_por_grupo else None %}
              {% if items %}
                <div class="accordion-item bg-transparent border-secondary mb-2">
                  <h2 class="accordion-header" id="h{{ loop.index }}">
                    <button class="accordion-button collapsed bg-dark text-light"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#c{{ loop.index }}"
                            aria-expanded="false"
                            aria-controls="c{{ loop.index }}">
                      {{ g }} <span class="ms-2 badge bg-info">{{ items|length }}</span>
                    </button>
                  </h2>
                  <div id="c{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="h{{ loop.index }}" data-bs-parent="#accMuscles">
                    <div class="accordion-body bg-dark">

                      {% for e in items %}
                        <div class="card bg-black border-secondary mb-2">
                          <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-start gap-2">
                              <div>
                                <div class="fw-bold text-light">{{ e.nombre }}</div>
                                <div class="small text-muted">{{ e.categoria }}</div>
                                {% if e.descripcion %}
                                  <div class="small text-soft mt-1">{{ e.descripcion }}</div>
                                {% endif %}
                              </div>

                              {% if e.video_url %}
                                <button class="btn btn-outline-info btn-sm"
                                        type="button"
                                        data-video="{{ e.video_url }}"
                                        data-title="{{ e.nombre }}"
                                        onclick="openVideo(this)">
                                  ‚ñ∂ Ver
                                </button>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      {% endfor %}

                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}

            {% if not ejercicios_por_grupo %}
              <div class="text-muted">No hay ejercicios cargados.</div>
            {% endif %}
          </div>
        </div>

        <div class="card-footer text-muted small">
          Tip: La agrupaci√≥n sale de <code>Ejercicio.categoria</code> (texto libre). Si pon√©s ‚ÄúPecho‚Äù/‚ÄúEspalda‚Äù/‚ÄúHombro‚Äù‚Ä¶ se ordena solo.
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL VIDEO -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-light" id="videoTitle">Video</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <video id="videoPlayer" controls playsinline style="width:100%;border-radius:14px;"></video>
      </div>
    </div>
  </div>
</div>

<script>
  function openVideo(btn){
    const url = btn.getAttribute("data-video") || "";
    const title = btn.getAttribute("data-title") || "Video";
    const player = document.getElementById("videoPlayer");
    const titleEl = document.getElementById("videoTitle");

    titleEl.textContent = title;
    player.src = url;

    const modal = new bootstrap.Modal(document.getElementById("videoModal"));
    modal.show();
  }
</script>
{% endblock %}
