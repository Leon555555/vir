{% extends "layout.html" %}
{% block title %}Planificador ‚Äî VR Training{% endblock %}

{% block content %}
<div class="vr-page">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <div class="section-title" style="letter-spacing:.18em;font-weight:950;">PLANIFICADOR</div>
      <div class="text-soft text-muted">Semana ¬∑ Bloques ¬∑ Rutinas ¬∑ Disponibilidad</div>
    </div>

    <div class="d-flex gap-2 flex-wrap align-items-center">
      <a class="btn btn-outline-light" href="{{ url_for('main.dashboard_entrenador') }}">
        <i class="bi bi-arrow-left"></i> Panel
      </a>
    </div>
  </div>

  <!-- Selector atleta + semana -->
  <div class="card glass p-3 p-md-4 mb-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <form method="get" class="d-flex gap-2 flex-wrap align-items-center">
        <input type="hidden" name="center" value="{{ center.isoformat() }}">

        <div style="min-width:240px;">
          <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">ATLETA</label>
          <select class="form-select" name="user_id" onchange="this.form.submit()">
            {% for u in atletas %}
              <option value="{{ u.id }}" {% if atleta and u.id==atleta.id %}selected{% endif %}>
                {{ u.nombre }} {% if u.grupo %}¬∑ {{ u.grupo }}{% endif %}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">SEMANA</label>
          <div class="d-flex gap-2">
            <input type="date" class="form-control" name="center" value="{{ center.isoformat() }}">
            <button class="btn btn-outline-info" type="submit">Ir</button>
          </div>
        </div>
      </form>

      <div class="d-flex gap-2 flex-wrap">
        {% if atleta %}
          <a class="btn btn-outline-info"
             href="{{ url_for('main.coach_planificador', user_id=atleta.id, center=prev_center.isoformat()) }}">
            ‚Üê Semana
          </a>

          <a class="btn btn-outline-info"
             href="{{ url_for('main.coach_planificador', user_id=atleta.id, center=next_center.isoformat()) }}">
            Semana ‚Üí
          </a>

          <form method="post" action="{{ url_for('main.coach_copiar_semana', user_id=atleta.id) }}" class="m-0">
            <input type="hidden" name="center" value="{{ center.isoformat() }}">
            <button class="btn btn-info" type="submit">
              <i class="bi bi-files"></i> Copiar a la siguiente
            </button>
          </form>
        {% endif %}
      </div>
    </div>

    {% if atleta %}
      <div class="text-muted mt-2">
        <span style="font-weight:900;letter-spacing:.10em;">SEMANA:</span> {{ semana_str }}
      </div>
    {% endif %}
  </div>

  {% if not atleta %}
    <div class="card glass p-4">
      <div class="text-muted">No hay atleta seleccionado.</div>
    </div>
  {% else %}

  <div class="vr-plani-grid">

    <!-- IZQUIERDA: d√≠as -->
    <div>

      <div class="vr-days-grid">
        {% for f in fechas %}
          {% set p = planes[f] %}
          {% set blocked = ((p.puede_entrenar or 'si') == 'no') %}
          {% set cmt = (p.comentario_atleta or '') %}
          {% set day_id = "day_" ~ f.isoformat().replace('-','') %}

          <div class="vr-day-card">

            <div class="vr-day-title">
              <div>
                <div style="font-weight:950;letter-spacing:.10em;">
                  {{ f.strftime('%A %d/%m')|upper }}
                </div>
                <div class="text-muted" style="font-weight:800;">
                  {% if blocked %}
                    <i class="bi bi-slash-circle text-danger"></i> No puede entrenar
                    {% if cmt %}¬∑ {{ cmt }}{% endif %}
                  {% else %}
                    OK
                  {% endif %}
                </div>
              </div>

              <div class="d-flex gap-2 align-items-center">
                <span class="badge bg-secondary" style="font-weight:900;">
                  {{ p.plan_type or 'Descanso' }}
                </span>
              </div>
            </div>

            <form method="post" action="{{ url_for('main.save_day') }}" class="vr-day-body">
              <input type="hidden" name="user_id" value="{{ atleta.id }}">
              <input type="hidden" name="fecha" value="{{ f.isoformat() }}">

              <div class="row g-2">
                <div class="col-12">
                  <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">TIPO</label>
                  <select class="form-select" name="plan_type" {% if blocked %}disabled{% endif %}>
                    {% set cur = (p.plan_type or 'Descanso')|lower %}
                    <option value="Descanso" {% if cur=='descanso' %}selected{% endif %}>Descanso</option>
                    <option value="Fuerza" {% if cur=='fuerza' %}selected{% endif %}>Fuerza</option>
                    <option value="Run" {% if cur=='run' %}selected{% endif %}>Run</option>
                    <option value="Pista" {% if cur=='pista' %}selected{% endif %}>Pista</option>
                    <option value="Bike" {% if cur=='bike' %}selected{% endif %}>Bike</option>
                    <option value="Swim" {% if cur=='swim' or cur in ['natacion','nataci√≥n'] %}selected{% endif %}>Swim</option>
                  </select>
                </div>

                <div class="col-12">
                  <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">WARMUP</label>
                  <textarea class="form-control" name="warmup" rows="2" {% if blocked %}disabled{% endif %}>{{ p.warmup or '' }}</textarea>
                </div>

                <!-- =========================
                     ‚úÖ BLOQUES 1..4
                     b{i}_type / b{i}_rutina / b{i}_text
                     + UI extra para EJ (ejercicio suelto)
                ========================== -->
                <div class="col-12">
                  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="text-muted" style="font-weight:950;letter-spacing:.14em;text-transform:uppercase;">
                      Principal (hasta 4 bloques)
                    </div>
                    <button class="btn btn-sm btn-outline-light" type="button"
                            onclick="fillFromMain('{{ day_id }}')" {% if blocked %}disabled{% endif %}>
                      <i class="bi bi-magic"></i> Autocargar desde Main
                    </button>
                  </div>

                  <input type="hidden" name="main" id="{{ day_id }}_main" value="{{ p.main or '' }}">

                  {% for i in range(1,5) %}
                    <div class="mt-2 p-2" style="border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(0,0,0,.18);">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted" style="font-weight:950;letter-spacing:.12em;">BLOQUE {{ i }}</div>
                        <span class="badge bg-dark" id="{{ day_id }}_b{{i}}_badge">‚Äî</span>
                      </div>

                      <div class="row g-2 mt-1">
                        <div class="col-md-4">
                          <label class="text-muted" style="font-weight:900;">Tipo</label>
                          <select class="form-select"
                                  name="b{{i}}_type"
                                  id="{{ day_id }}_b{{i}}_type"
                                  onchange="syncBlockUI('{{ day_id }}', {{ i }})"
                                  {% if blocked %}disabled{% endif %}>
                            <option value="">(vac√≠o)</option>
                            <option value="TABATA">TABATA</option>
                            <option value="FUERZA">FUERZA</option>
                            <option value="STRETCH">STRETCH</option>
                            <option value="EJ">EJ (ejercicio suelto)</option>
                            <option value="RUN">RUN</option>
                            <option value="BIKE">BIKE</option>
                            <option value="SWIM">SWIM</option>
                            <option value="FREE">FREE</option>
                            <option value="NOTE">NOTE</option>
                          </select>
                        </div>

                        <!-- Rutina (TABATA/FUERZA/STRETCH) -->
                        <div class="col-md-4" id="{{ day_id }}_b{{i}}_rutina_wrap">
                          <label class="text-muted" style="font-weight:900;">Rutina</label>
                          <select class="form-select" name="b{{i}}_rutina" id="{{ day_id }}_b{{i}}_rutina"
                                  {% if blocked %}disabled{% endif %}>
                            <option value="">(seleccionar)</option>
                            {% for r in rutinas %}
                              <option value="{{ r.id }}">{{ r.nombre }}</option>
                            {% endfor %}
                          </select>
                        </div>

                        <!-- Texto (RUN/BIKE/SWIM/FREE/NOTE) -->
                        <div class="col-md-8" id="{{ day_id }}_b{{i}}_text_wrap">
                          <label class="text-muted" style="font-weight:900;">Texto</label>
                          <input class="form-control" name="b{{i}}_text" id="{{ day_id }}_b{{i}}_text"
                                 placeholder="Ej: 10km suave / 6x400 / 60' Z2 / t√©cnica / comentario"
                                 {% if blocked %}disabled{% endif %}>
                        </div>

                        <!-- Ejercicio suelto (EJ) -->
                        <div class="col-md-8" id="{{ day_id }}_b{{i}}_ej_wrap">
                          <label class="text-muted" style="font-weight:900;">Ejercicio (Banco)</label>

                          <!-- selector -->
                          <select class="form-select"
                                  id="{{ day_id }}_b{{i}}_ej_select"
                                  onchange="syncEjToText('{{ day_id }}', {{ i }})"
                                  {% if blocked %}disabled{% endif %}>
                            <option value="">(seleccionar ejercicio)</option>
                            {% for g in muscle_groups_order %}
                              {% set arr = ejercicios_por_grupo.get(g, []) %}
                              {% if arr and arr|length %}
                                <optgroup label="{{ g }}">
                                  {% for e in arr %}
                                    <option value="{{ e.id }}">{{ e.nombre }}</option>
                                  {% endfor %}
                                </optgroup>
                              {% endif %}
                            {% endfor %}
                          </select>

                          <!-- guardamos el id en b{i}_text (porque routes.py espera text para EJ) -->
                          <div class="d-flex gap-2 mt-2">
                            <input class="form-control"
                                   name="b{{i}}_text"
                                   id="{{ day_id }}_b{{i}}_ej_text"
                                   placeholder="ID ejercicio (auto) ¬∑ ej: 123"
                                   {% if blocked %}disabled{% endif %}>
                            <button class="btn btn-outline-light" type="button"
                                    onclick="openEjPreview('{{ day_id }}', {{ i }})" {% if blocked %}disabled{% endif %}>
                              <i class="bi bi-eye"></i>
                            </button>
                          </div>

                          <div class="text-muted small mt-1">
                            Se guarda como <span class="badge bg-dark border">EJ:&lt;id&gt;</span> (video y descripci√≥n aparecen en el perfil del atleta).
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>

                <div class="col-12">
                  <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">ENFRIAMIENTO</label>
                  <textarea class="form-control" name="finisher" rows="2" {% if blocked %}disabled{% endif %}>{{ p.finisher or '' }}</textarea>
                </div>

                <div class="col-12">
                  <label class="text-muted" style="font-weight:900;letter-spacing:.10em;">SCORE (opcional)</label>
                  <input class="form-control" name="propuesto_score" value="{{ p.propuesto_score or 0 }}" {% if blocked %}disabled{% endif %}>
                </div>

                <div class="col-12 d-grid">
                  <button class="btn btn-primary" type="submit" {% if blocked %}disabled{% endif %}>
                    üíæ Guardar d√≠a
                  </button>
                </div>

              </div>
            </form>

            {% if blocked %}
              <div class="text-muted mt-2" style="font-size:.92rem;">
                Este d√≠a est√° bloqueado por el atleta. Si quer√©s replanificar, pedile que lo desbloquee desde su perfil.
              </div>
            {% endif %}

          </div>
        {% endfor %}
      </div>

    </div>

    <!-- DERECHA: sidebar -->
    <div class="vr-sidebar">
      <div class="card glass p-3 p-md-4">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <div style="font-weight:950;letter-spacing:.14em;text-transform:uppercase;">Banco</div>
            <div class="text-muted" style="font-size:.95rem;">Rutinas + Ejercicios agrupados</div>
          </div>
          <a class="btn btn-sm btn-outline-info" href="{{ url_for('main.dashboard_entrenador') }}">
            <i class="bi bi-boxes"></i> Gestionar
          </a>
        </div>

        <hr>

        <div class="text-muted" style="font-weight:950;letter-spacing:.14em;text-transform:uppercase;">Rutinas</div>
        <div class="mt-2" style="max-height:260px; overflow:auto;">
          {% for r in rutinas %}
            <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom:1px dashed rgba(255,255,255,.10);">
              <div style="font-weight:900;">{{ r.nombre }}</div>
              <a class="btn btn-sm btn-outline-light" href="{{ url_for('main.rutina_builder', rutina_id=r.id) }}">
                Builder
              </a>
            </div>
          {% endfor %}
        </div>

        <hr>

        <div class="text-muted" style="font-weight:950;letter-spacing:.14em;text-transform:uppercase;">Ejercicios (por grupo)</div>

        <div class="accordion mt-2" id="accGroups">
          {% for g in muscle_groups_order %}
            {% set arr = ejercicios_por_grupo.get(g, []) %}
            {% if arr and arr|length %}
              <div class="accordion-item" style="background:transparent;border:1px solid rgba(255,255,255,.10);border-radius:14px;overflow:hidden;margin-bottom:10px;">
                <h2 class="accordion-header" id="h_{{ g|replace(' ','_') }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                          data-bs-target="#c_{{ g|replace(' ','_') }}">
                    <span style="font-weight:950;letter-spacing:.10em;">{{ g }}</span>
                    <span class="ms-2 text-muted">({{ arr|length }})</span>
                  </button>
                </h2>
                <div id="c_{{ g|replace(' ','_') }}" class="accordion-collapse collapse" data-bs-parent="#accGroups">
                  <div class="accordion-body" style="background:rgba(0,0,0,.18);">
                    {% for e in arr %}
                      <div class="py-2" style="border-bottom:1px dashed rgba(255,255,255,.10);">
                        <div style="font-weight:900;">{{ e.nombre }}</div>
                        <div class="text-muted" style="font-size:.92rem;">{{ e.categoria or '' }}</div>
                        {% if e.video_url %}
                          <div class="mt-2">
                            <video controls preload="metadata" style="width:100%;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);">
                              <source src="{{ e.video_url }}" type="video/mp4">
                            </video>
                          </div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

      </div>
    </div>

  </div>

  {% endif %}
</div>

<!-- Modal preview ejercicio -->
<div class="modal fade" id="ejPreviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-dark text-light border border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="ejPreviewTitle">Ejercicio</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="ejPreviewBody">
        <div class="text-muted">Seleccion√° un ejercicio para previsualizar.</div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/**
 * BLOQUES:
 *  - TABATA / FUERZA / STRETCH => rutina
 *  - EJ => ejercicio suelto (guardamos ID en b{i}_text)
 *  - RUN/BIKE/SWIM/FREE/NOTE => texto
 *
 * Bot√≥n Autocargar desde Main soporta:
 *  TABATA:RUTINA:12
 *  FUERZA:RUTINA:12
 *  STRETCH:RUTINA:12   o ESTIRAMIENTOS:RUTINA:12
 *  EJ:34 o EJERCICIO:34
 *  RUN:...
 *  BIKE:...
 *  SWIM:...
 *  FREE:...
 *  NOTE:...
 */

function syncBlockUI(dayId, i){
  const sel = document.getElementById(`${dayId}_b${i}_type`);
  const val = (sel.value || "").toUpperCase();

  const rutWrap = document.getElementById(`${dayId}_b${i}_rutina_wrap`);
  const txtWrap = document.getElementById(`${dayId}_b${i}_text_wrap`);
  const ejWrap  = document.getElementById(`${dayId}_b${i}_ej_wrap`);
  const badge   = document.getElementById(`${dayId}_b${i}_badge`);

  badge.textContent = val || "‚Äî";
  badge.className = "badge " + (
    val === "TABATA"  ? "bg-danger" :
    val === "FUERZA"  ? "bg-info" :
    val === "STRETCH" ? "bg-success" :
    val === "EJ"      ? "bg-warning text-dark" :
    val === "RUN"     ? "bg-success" :
    val === "BIKE"    ? "bg-warning text-dark" :
    val === "SWIM"    ? "bg-primary" :
    val === "FREE"    ? "bg-secondary" :
    val === "NOTE"    ? "bg-light text-dark" : "bg-dark"
  );

  // hide all by default
  rutWrap.style.display = "none";
  txtWrap.style.display = "none";
  ejWrap.style.display  = "none";

  if(val === "TABATA" || val === "FUERZA" || val === "STRETCH"){
    rutWrap.style.display = "";
  } else if(val === "EJ"){
    ejWrap.style.display = "";
  } else if(val){
    txtWrap.style.display = "";
  }
}

function extractRutinaId(line){
  const s = String(line||"").trim();
  const up = s.toUpperCase().replaceAll(" ", "");

  if(up.includes("RUTINA:")){
    const after = up.split("RUTINA:")[1] || "";
    const n = parseInt(after, 10);
    return Number.isFinite(n) ? String(n) : "";
  }
  const n2 = parseInt(s, 10);
  return Number.isFinite(n2) ? String(n2) : "";
}

function extractEjId(line){
  const s = String(line||"").trim();
  const up = s.toUpperCase().replaceAll(" ", "");

  if(up.startsWith("EJ:")){
    const after = up.split("EJ:")[1] || "";
    const n = parseInt(after, 10);
    return Number.isFinite(n) ? String(n) : "";
  }
  if(up.startsWith("EJERCICIO:")){
    const after = up.split("EJERCICIO:")[1] || "";
    const n = parseInt(after, 10);
    return Number.isFinite(n) ? String(n) : "";
  }
  const n2 = parseInt(s, 10);
  return Number.isFinite(n2) ? String(n2) : "";
}

function parseMainToBlocks(mainText){
  const lines = String(mainText||"").split("\n").map(x => x.trim()).filter(Boolean);
  const out = [];

  for(const line of lines){
    const up = line.toUpperCase();

    if(up.startsWith("TABATA:")){
      out.push({type:"TABATA", rutina: extractRutinaId(line), text:"", ej:""});
      continue;
    }
    if(up.startsWith("FUERZA:")){
      out.push({type:"FUERZA", rutina: extractRutinaId(line), text:"", ej:""});
      continue;
    }
    if(up.startsWith("STRETCH:") || up.startsWith("ESTIRAMIENTOS:")){
      out.push({type:"STRETCH", rutina: extractRutinaId(line), text:"", ej:""});
      continue;
    }
    if(up.startsWith("EJ:") || up.startsWith("EJERCICIO:")){
      out.push({type:"EJ", rutina:"", text:"", ej: extractEjId(line)});
      continue;
    }

    if(up.startsWith("RUN:")){
      out.push({type:"RUN", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""});
      continue;
    }
    if(up.startsWith("BIKE:")){
      out.push({type:"BIKE", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""});
      continue;
    }
    if(up.startsWith("SWIM:") || up.startsWith("NATACION:") || up.startsWith("NATACI√ìN:")){
      out.push({type:"SWIM", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""});
      continue;
    }
    if(up.startsWith("FREE:")){
      out.push({type:"FREE", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""});
      continue;
    }
    if(up.startsWith("NOTE:") || up.startsWith("NOTA:")){
      out.push({type:"NOTE", rutina:"", text: line.split(":",2)[1]?.trim() || "", ej:""});
      continue;
    }

    // legacy: "RUTINA:12" o "12" => fuerza
    const rid = extractRutinaId(line);
    if(rid){
      out.push({type:"FUERZA", rutina: rid, text:"", ej:""});
    }else{
      out.push({type:"FREE", rutina:"", text: line, ej:""});
    }
  }

  return out.slice(0,4);
}

function fillFromMain(dayId){
  const mainEl = document.getElementById(`${dayId}_main`);
  const main = (mainEl && mainEl.value) ? mainEl.value : "";
  const blocks = parseMainToBlocks(main);

  for(let i=1; i<=4; i++){
    const b = blocks[i-1] || {type:"", rutina:"", text:"", ej:""};

    const typeEl = document.getElementById(`${dayId}_b${i}_type`);
    const rutEl  = document.getElementById(`${dayId}_b${i}_rutina`);
    const txtEl  = document.getElementById(`${dayId}_b${i}_text`);

    // EJ UI
    const ejSelect = document.getElementById(`${dayId}_b${i}_ej_select`);
    const ejText   = document.getElementById(`${dayId}_b${i}_ej_text`);

    typeEl.value = b.type || "";

    if(rutEl) rutEl.value = b.rutina || "";
    if(txtEl) txtEl.value = b.text || "";

    if(ejText) ejText.value = b.ej || "";
    if(ejSelect){
      ejSelect.value = b.ej || "";
    }

    syncBlockUI(dayId, i);
  }
}

function syncEjToText(dayId, i){
  const ejSelect = document.getElementById(`${dayId}_b${i}_ej_select`);
  const ejText   = document.getElementById(`${dayId}_b${i}_ej_text`);
  if(!ejSelect || !ejText) return;
  ejText.value = ejSelect.value || "";
}

function openEjPreview(dayId, i){
  const ejText   = document.getElementById(`${dayId}_b${i}_ej_text`);
  const ejSelect = document.getElementById(`${dayId}_b${i}_ej_select`);
  const id = (ejText && ejText.value) ? ejText.value.trim() : (ejSelect && ejSelect.value ? ejSelect.value : "");
  const title = document.getElementById("ejPreviewTitle");
  const body  = document.getElementById("ejPreviewBody");
  const modalEl = document.getElementById("ejPreviewModal");

  if(!id){
    title.textContent = "Ejercicio";
    body.innerHTML = `<div class="text-muted">Seleccion√° un ejercicio primero.</div>`;
    new bootstrap.Modal(modalEl).show();
    return;
  }

  // Preview ‚Äúliviano‚Äù: mostramos el nombre del option si existe
  let name = "";
  if(ejSelect){
    const opt = ejSelect.querySelector(`option[value="${CSS.escape(id)}"]`);
    if(opt) name = opt.textContent || "";
  }

  title.textContent = name ? `EJ ${id} ¬∑ ${name}` : `EJ ${id}`;
  body.innerHTML = `
    <div class="text-soft">Este bloque se guardar√° como:</div>
    <div class="mt-2"><span class="badge bg-dark border">EJ:${id}</span></div>
    <div class="text-muted small mt-3">El video y la descripci√≥n se ver√°n en el perfil del atleta.</div>
  `;

  new bootstrap.Modal(modalEl).show();
}

(function initAll(){
  const selects = document.querySelectorAll("select[id$='_type']");
  selects.forEach(sel => {
    const m = sel.id.match(/^(day_\d+)_b(\d+)_type$/);
    if(m){
      syncBlockUI(m[1], parseInt(m[2],10));
    }
  });
})();
</script>
{% endblock %}
