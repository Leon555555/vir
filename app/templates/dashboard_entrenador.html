{% extends "layout.html" %}
{% block title %}Planificador ‚Äî VR Training{% endblock %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <div class="section-title">PLANIFICADOR</div>
      <div class="text-soft">Semana ¬∑ Asignaci√≥n de bloques ¬∑ Rutinas</div>
      {% if atleta %}
        <div class="text-muted mt-1">Atleta seleccionado: <strong class="text-light">{{ atleta.nombre }}</strong></div>
      {% endif %}
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-light" href="{{ url_for('main.dashboard_entrenador') }}">
        <i class="bi bi-grid"></i> Panel entrenador
      </a>
    </div>
  </div>

  <div class="card glass p-3 p-md-4 mb-3">
    <div class="row g-2 align-items-end">

      <div class="col-md-5">
        <label class="text-muted mb-1">Atleta</label>
        <form method="GET" class="d-flex gap-2">
          <select class="form-select" name="user_id" onchange="this.form.submit()">
            {% for a in atletas %}
              <option value="{{ a.id }}" {% if atleta and a.id==atleta.id %}selected{% endif %}>
                {{ a.nombre }}{% if a.grupo %} ¬∑ {{ a.grupo }}{% endif %}
              </option>
            {% endfor %}
          </select>

          <input type="date" class="form-control" name="center" value="{{ center.isoformat() }}">
          <button class="btn btn-outline-info" type="submit"><i class="bi bi-arrow-right-circle"></i> Ir</button>
        </form>
      </div>

      <div class="col-md-7">
        <div class="glass p-3" style="border-radius:16px;">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
              <div class="mini-title">SEMANA</div>
              <div class="text-strong" style="font-weight:900;">{{ semana_str }}</div>
            </div>
            <div class="text-muted" style="font-weight:800;">
              Tip: para varios tabatas escrib√≠ en ‚ÄúMain‚Äù l√≠neas tipo:
              <span class="badge bg-secondary">TABATA:RUTINA:12</span>
              <span class="badge bg-secondary">RUN: 8km Z2</span>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  {% if not atleta %}
    <div class="alert alert-warning">No hay atletas cargados.</div>
  {% else %}

  <div class="row g-3">
    {% for f in fechas %}
      {% set p = planes[f] %}
      {% set blocked = ((p.puede_entrenar or 'si') == 'no') %}

      <div class="col-12 col-lg-6">
        <div class="card glass p-3 lift {% if blocked %}border border-danger{% endif %}">
          <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
              <div class="text-muted" style="letter-spacing:.18em;text-transform:uppercase;">
                {{ f.strftime('%A %d/%m')|upper }}
              </div>
              <div class="d-flex align-items-center gap-2 mt-1">
                <span class="badge {% if blocked %}bg-danger{% else %}bg-secondary{% endif %}">
                  {% if blocked %}BLOQUEADO{% else %}{{ p.plan_type or '‚Äî' }}{% endif %}
                </span>
                {% if p.comentario_atleta %}
                  <span class="badge bg-dark">üó£ {{ p.comentario_atleta }}</span>
                {% endif %}
              </div>
            </div>

            <div class="text-muted" style="font-weight:900;">
              Score: <span class="text-light">{{ p.propuesto_score or 0 }}</span>
            </div>
          </div>

          <form method="POST" action="{{ url_for('main.save_day') }}" class="mt-3">
            <input type="hidden" name="user_id" value="{{ atleta.id }}">
            <input type="hidden" name="fecha" value="{{ f.isoformat() }}">

            <div class="row g-2">
              <div class="col-md-4">
                <label class="text-muted mb-1">Tipo</label>
                <select class="form-select" name="plan_type">
                  {% set t = (p.plan_type or 'Descanso') %}
                  <option {% if t=='Descanso' %}selected{% endif %}>Descanso</option>
                  <option {% if t=='Fuerza' %}selected{% endif %}>Fuerza</option>
                  <option {% if t=='Run' %}selected{% endif %}>Run</option>
                  <option {% if t=='Free' %}selected{% endif %}>Free</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="text-muted mb-1">Rutina (si es Fuerza)</label>
                <select class="form-select" name="rutina_select">
                  <option value="">‚Äî</option>
                  {% for r in rutinas %}
                    <option value="RUTINA:{{ r.id }}" {% if (p.main or '') == ('RUTINA:' ~ r.id) %}selected{% endif %}>
                      #{{ r.id }} ¬∑ {{ r.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-4">
                <label class="text-muted mb-1">Score</label>
                <input type="number" class="form-control" name="propuesto_score" value="{{ p.propuesto_score or 0 }}">
              </div>

              <div class="col-12">
                <label class="text-muted mb-1">Warmup</label>
                <input class="form-control" name="warmup" value="{{ p.warmup or '' }}" placeholder="Ej: movilidad + activaci√≥n 10'">
              </div>

              <div class="col-12">
                <label class="text-muted mb-1">Main (bloques por l√≠neas)</label>
                <textarea class="form-control" name="main" rows="4"
                  placeholder="Ej:
TABATA:RUTINA:12
TABATA:RUTINA:18
RUN: 8km Z2 + 6x100m">{{ p.main or '' }}</textarea>

                <div class="text-muted mt-2" style="font-size:.92rem;">
                  ‚úÖ Para varios tabatas: una l√≠nea por tabata.  
                  ‚úÖ Run/Free: usa <strong>RUN:</strong> o <strong>FREE:</strong>.
                </div>
              </div>

              <div class="col-12">
                <label class="text-muted mb-1">Finisher</label>
                <input class="form-control" name="finisher" value="{{ p.finisher or '' }}" placeholder="Ej: respiraci√≥n + estiramientos 8'">
              </div>

            </div>

            <div class="d-grid mt-3">
              <button class="btn btn-info" type="submit">
                üíæ Guardar d√≠a
              </button>
            </div>

            {% if blocked %}
              <div class="text-danger mt-2" style="font-weight:900;">
                üö´ Atleta bloque√≥ el d√≠a (no puede entrenar).
              </div>
            {% endif %}
          </form>
        </div>
      </div>

    {% endfor %}
  </div>

  {% endif %}

</div>
{% endblock %}
