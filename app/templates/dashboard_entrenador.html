{% extends "layout.html" %}
{% block title %}Planificador{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <div class="section-title">PLANIFICADOR</div>
    <div class="text-soft">Semana ¬∑ bloques mixtos (Tabata/Fuerza/Run/Bike/Swim)</div>
    {% if semana_str %}<div class="text-muted mt-1" style="font-weight:900;">{{ semana_str }}</div>{% endif %}
  </div>
  <a class="btn btn-outline-light" href="{{ url_for('main.dashboard_entrenador') }}">
    <i class="bi bi-arrow-left"></i> Volver
  </a>
</div>

{% if not atleta %}
  <div class="alert alert-warning">No hay atleta seleccionado.</div>
{% else %}

<div class="card glass lift mb-3">
  <div class="card-body d-flex justify-content-between align-items-center flex-wrap gap-2">
    <form method="get" action="{{ url_for('main.coach_planificador') }}" class="d-flex gap-2 flex-wrap align-items-center">
      <select class="form-select" name="user_id" style="min-width:260px;">
        {% for a in atletas %}
          <option value="{{ a.id }}" {% if atleta and a.id == atleta.id %}selected{% endif %}>{{ a.nombre }} ({{ a.email }})</option>
        {% endfor %}
      </select>

      <input type="date" class="form-control" name="center" value="{{ center.isoformat() }}" style="min-width:190px;">
      <button class="btn btn-info"><i class="bi bi-search"></i> Ver semana</button>
    </form>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-info" href="{{ url_for('main.perfil_usuario', user_id=atleta.id, view='week') }}">
        Ver perfil atleta
      </a>
    </div>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-5">

    <div class="card glass lift">
      <div class="card-header">
        <strong>‚úçÔ∏è Editar d√≠a</strong>
        <div class="text-muted" style="font-size:.95rem;">Eleg√≠ un d√≠a de la semana para cargar el plan (hasta 4 bloques).</div>
      </div>

      <div class="card-body">
        <div class="mb-2">
          <label class="form-label text-muted">D√≠a</label>
          <select class="form-select" id="daySelect">
            {% for d in fechas %}
              <option value="{{ d.isoformat() }}">{{ d.strftime('%a %d/%m') }}</option>
            {% endfor %}
          </select>
        </div>

        <form method="post" action="{{ url_for('main.save_day') }}" id="dayForm">
          <input type="hidden" name="user_id" value="{{ atleta.id }}">
          <input type="hidden" name="fecha" id="fechaInput" value="{{ fechas[0].isoformat() }}">

          <div class="mb-2">
            <label class="form-label text-muted">Plan type (general)</label>
            <select class="form-select" name="plan_type" id="planType">
              <option value="Descanso">Descanso</option>
              <option value="Fuerza">Fuerza</option>
              <option value="Run">Run</option>
              <option value="Bike">Bike</option>
              <option value="Swim">Swim</option>
              <option value="Mixto">Mixto</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label text-muted">Warmup</label>
            <textarea class="form-control" name="warmup" id="warmup" rows="2"></textarea>
          </div>

          <!-- =========================
               4 BLOQUES
          ========================== -->
          <div class="card glass" style="border-radius:16px; padding:12px; border:1px solid rgba(255,255,255,.10);">
            <div style="font-weight:900; margin-bottom:6px;">üß± Bloques (hasta 4)</div>
            <div class="text-muted" style="font-size:.9rem; margin-bottom:10px;">
              Tabata/Fuerza usa Rutina. Run/Bike/Swim/Free/Note usa texto.
            </div>

            {% for i in [1,2,3,4] %}
            <div class="mb-2" style="border-top:1px solid rgba(255,255,255,.10); padding-top:10px;">
              <div class="d-flex justify-content-between align-items-center">
                <div style="font-weight:900;">Bloque {{ i }}</div>
                <button type="button" class="btn btn-sm btn-outline-light" onclick="clearBlock({{ i }})">Limpiar</button>
              </div>

              <div class="row g-2 mt-1">
                <div class="col-4">
                  <select class="form-select" name="b{{i}}_type" id="b{{i}}_type" onchange="toggleBlockInputs({{i}})">
                    <option value="">‚Äî</option>
                    <option value="TABATA">TABATA</option>
                    <option value="FUERZA">FUERZA</option>
                    <option value="RUN">RUN</option>
                    <option value="BIKE">BIKE</option>
                    <option value="SWIM">SWIM</option>
                    <option value="FREE">FREE</option>
                    <option value="NOTE">NOTE</option>
                  </select>
                </div>

                <div class="col-8" id="b{{i}}_rutina_wrap" style="display:none;">
                  <select class="form-select" name="b{{i}}_rutina" id="b{{i}}_rutina">
                    <option value="">‚Äî Rutina ‚Äî</option>
                    {% for r in rutinas %}
                      <option value="{{ r.id }}">#{{ r.id }} ¬∑ {{ r.nombre }}</option>
                    {% endfor %}
                  </select>
                </div>

                <div class="col-12" id="b{{i}}_text_wrap" style="display:none;">
                  <input class="form-control" name="b{{i}}_text" id="b{{i}}_text" placeholder="Ej: 8x400 r:1'30 / 45' Z2 / T√©cnica nataci√≥n...">
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <div class="mt-2">
            <label class="form-label text-muted">Finisher</label>
            <textarea class="form-control" name="finisher" id="finisher" rows="2"></textarea>
          </div>

          <input type="hidden" name="main" id="mainLegacy" value="">

          <div class="d-grid mt-3">
            <button class="btn btn-info">
              <i class="bi bi-check2-circle"></i> Guardar d√≠a
            </button>
          </div>

        </form>

        <div class="text-muted mt-3" style="font-size:.9rem;">
          ‚úÖ Guarda bloques en <code>plan.main</code> como l√≠neas. Ej:
          <div><code>TABATA:RUTINA:5</code></div>
          <div><code>FUERZA:RUTINA:12</code></div>
          <div><code>RUN:45' Z2 + 6x20"</code></div>
        </div>
      </div>
    </div>

  </div>

  <div class="col-lg-7">
    <div class="card glass lift">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>üìÖ Semana (click para ver)</strong>
        <span class="text-muted" style="font-weight:900;">{{ atleta.nombre }}</span>
      </div>
      <div class="card-body">
        <div class="row g-2">
          {% for d in fechas %}
            {% set p = planes.get(d) %}
            <div class="col-6 col-xl-4">
              <div class="card glass" style="border-radius:16px; cursor:pointer;"
                   onclick="loadDay('{{ d.isoformat() }}')">
                <div class="card-body" style="padding:12px;">
                  <div style="font-weight:900;">{{ d.strftime('%a %d/%m') }}</div>
                  <div class="text-muted" style="font-size:.9rem;">
                    {{ (p.plan_type or '‚Äî') }}
                  </div>
                  <div class="mt-2" style="font-size:.9rem;">
                    {% if p and p.main %}
                      <div class="text-muted" style="white-space:pre-line; opacity:.85;">{{ p.main }}</div>
                    {% else %}
                      <div class="text-muted">Sin bloques</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  const PLANES = {
    {% for d in fechas %}
      "{{ d.isoformat() }}": {
        plan_type: "{{ (planes.get(d).plan_type if planes.get(d) else '')|e }}",
        warmup: `{{ (planes.get(d).warmup if planes.get(d) else '')|e }}`,
        main: `{{ (planes.get(d).main if planes.get(d) else '')|e }}`,
        finisher: `{{ (planes.get(d).finisher if planes.get(d) else '')|e }}`
      },
    {% endfor %}
  };

  function isRutinaType(t){
    return (t === "TABATA" || t === "FUERZA");
  }

  function toggleBlockInputs(i){
    const t = (document.getElementById(`b${i}_type`).value || "").toUpperCase();
    const rw = document.getElementById(`b${i}_rutina_wrap`);
    const tw = document.getElementById(`b${i}_text_wrap`);
    if(isRutinaType(t)){
      rw.style.display = "block";
      tw.style.display = "none";
    } else if(t){
      rw.style.display = "none";
      tw.style.display = "block";
    } else {
      rw.style.display = "none";
      tw.style.display = "none";
    }
  }

  function clearBlock(i){
    document.getElementById(`b${i}_type`).value = "";
    document.getElementById(`b${i}_rutina`).value = "";
    document.getElementById(`b${i}_text`).value = "";
    toggleBlockInputs(i);
  }

  function parseMainToBlocks(mainText){
    const lines = (mainText || "").split("\n").map(s => s.trim()).filter(Boolean);
    const blocks = [];
    for(const line of lines){
      const up = line.toUpperCase();
      const idx = line.indexOf(":");
      if(idx > 0){
        const t = up.slice(0, idx).trim();
        const payload = line.slice(idx+1).trim();
        blocks.push({type: t, payload});
      } else {
        blocks.push({type:"FREE", payload: line});
      }
    }
    return blocks.slice(0,4);
  }

  function fillBlocksFromMain(mainText){
    for(let i=1;i<=4;i++) clearBlock(i);
    const blocks = parseMainToBlocks(mainText);

    blocks.forEach((b, n) => {
      const i = n+1;
      const t = (b.type || "").toUpperCase();
      document.getElementById(`b${i}_type`).value = t;

      if(isRutinaType(t)){
        // payload esperado: RUTINA:ID
        let rid = "";
        const p = (b.payload || "");
        const pUp = p.toUpperCase().replace(" ", "");
        if(pUp.startsWith("RUTINA:")){
          rid = pUp.split("RUTINA:", 2)[1] || "";
        } else {
          rid = p;
        }
        document.getElementById(`b${i}_rutina`).value = rid;
      } else {
        document.getElementById(`b${i}_text`).value = b.payload || "";
      }

      toggleBlockInputs(i);
    });
  }

  function loadDay(iso){
    document.getElementById("fechaInput").value = iso;
    document.getElementById("daySelect").value = iso;

    const p = PLANES[iso] || {};
    document.getElementById("planType").value = p.plan_type || "Descanso";
    document.getElementById("warmup").value = p.warmup || "";
    document.getElementById("finisher").value = p.finisher || "";
    fillBlocksFromMain(p.main || "");
  }

  document.getElementById("daySelect").addEventListener("change", (e)=>{
    loadDay(e.target.value);
  });

  // init
  loadDay(document.getElementById("daySelect").value);
</script>

{% endif %}
{% endblock %}
