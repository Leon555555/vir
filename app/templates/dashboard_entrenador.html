{% extends "layout.html" %}
{% block title %}Dashboard Entrenador â€” VR Training{% endblock %}

{% block content %}
<div class="container mt-4">

  <h2 class="text-light mb-1">ðŸ“… Planificador â€” {{ atleta.nombre if atleta else "â€”" }}</h2>
  {% if atleta %}
    <div class="text-muted mb-3">Semana: {{ semana_str }}</div>
  {% endif %}

  <!-- selector atleta -->
  <form method="GET" class="row g-2 mb-4">
    <div class="col-md-5">
      <select class="form-select" name="user_id">
        {% for a in atletas %}
          <option value="{{ a.id }}" {% if atleta and a.id==atleta.id %}selected{% endif %}>
            {{ a.nombre }} ({{ a.email }})
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <input class="form-control" type="date" name="center" value="{{ center.isoformat() if center else '' }}">
    </div>
    <div class="col-md-2">
      <button class="btn btn-info w-100" type="submit">Ver semana</button>
    </div>
  </form>

  {% if atleta %}
  <div class="row g-3">
    {% for f in fechas %}
      {% set plan = planes[f] %}
      {% set fecha_id = f.isoformat() %}
      <div class="col-md-6 col-lg-4">
        <form method="POST" action="{{ url_for('main.save_day') }}"
              class="card p-3"
              style="background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;">

          <input type="hidden" name="user_id" value="{{ atleta.id }}">
          <input type="hidden" name="fecha" value="{{ fecha_id }}">

          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong class="text-light">{{ f.strftime('%a %d/%m')|upper }}</strong>
            <span class="badge bg-secondary" id="badge-{{ fecha_id }}">{{ plan.plan_type }}</span>
          </div>

          <!-- SELECT TIPO -->
          <select class="form-select mb-3"
                  name="plan_type"
                  id="planType-{{ fecha_id }}"
                  onchange="onPlanTypeChange('{{ fecha_id }}')">
            <option value="Descanso" {% if plan.plan_type=='Descanso' %}selected{% endif %}>Descanso</option>
            <option value="Fuerza" {% if plan.plan_type=='Fuerza' %}selected{% endif %}>Fuerza</option>
            <option value="Run" {% if plan.plan_type=='Run' %}selected{% endif %}>Run</option>
            <option value="Bike" {% if plan.plan_type=='Bike' %}selected{% endif %}>Bike</option>
            <option value="Natacion" {% if plan.plan_type=='Natacion' %}selected{% endif %}>NataciÃ³n</option>
          </select>

          <!-- NO FUERZA: 3 botones -->
          <div id="enduranceBox-{{ fecha_id }}" class="endurance-box hidden">
            <div class="mini-tabs">
              <button type="button" class="mini-tab active"
                      data-fecha="{{ fecha_id }}" data-target="warmup"
                      onclick="switchMiniTab('{{ fecha_id }}','warmup')">ActivaciÃ³n</button>
              <button type="button" class="mini-tab"
                      data-fecha="{{ fecha_id }}" data-target="main"
                      onclick="switchMiniTab('{{ fecha_id }}','main')">Bloque principal</button>
              <button type="button" class="mini-tab"
                      data-fecha="{{ fecha_id }}" data-target="finisher"
                      onclick="switchMiniTab('{{ fecha_id }}','finisher')">Enfriamiento</button>
            </div>

            <textarea class="form-control mini-area"
                      id="warmup-{{ fecha_id }}"
                      name="warmup"
                      placeholder="Ej: movilidad + skipping...">{{ plan.warmup or "" }}</textarea>

            <textarea class="form-control mini-area hidden"
                      id="main-{{ fecha_id }}"
                      name="main"
                      placeholder="Ej: 3x1000 a 5'10'' rec 2'...">{{ plan.main or "" }}</textarea>

            <textarea class="form-control mini-area hidden"
                      id="finisher-{{ fecha_id }}"
                      name="finisher"
                      placeholder="Ej: 10' suave + estirar">{{ plan.finisher or "" }}</textarea>
          </div>

          <!-- FUERZA: selector rutina -->
          <div id="strengthBox-{{ fecha_id }}" class="strength-box hidden">
            <select class="form-select mb-2" name="rutina_select" id="rutinaSel-{{ fecha_id }}">
              <option value="">â€” Sin rutina â€”</option>
              {% for r in rutinas %}
                <option value="RUTINA:{{ r.id }}" {% if plan.main == ("RUTINA:" ~ r.id) %}selected{% endif %}>
                  {{ r.nombre }}
                </option>
              {% endfor %}
            </select>

            <div class="small text-muted text-center" style="letter-spacing:.12em;">RUTINA:ID</div>

            <textarea class="form-control mini-area mt-2" name="warmup" placeholder="Warmup (opcional)">{{ plan.warmup or "" }}</textarea>
            <textarea class="form-control mini-area mt-2" name="finisher" placeholder="Finisher (opcional)">{{ plan.finisher or "" }}</textarea>
          </div>

          <div class="d-flex gap-2 mt-3">
            <input class="form-control" type="number" name="propuesto_score" value="{{ plan.propuesto_score or 0 }}" />
            <button class="btn btn-primary w-100" type="submit">ðŸ’¾ Guardar dÃ­a</button>
          </div>

        </form>
      </div>
    {% endfor %}
  </div>
  {% endif %}

</div>

<style>
.hidden{display:none !important;}
.endurance-box,.strength-box{
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  padding: 12px;
}
.mini-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.mini-tab{
  border-radius:999px;padding:6px 10px;font-size:.82rem;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.10);
  color:#fff;
}
.mini-tab.active{
  background: rgba(34,211,238,.16);
  border-color: rgba(34,211,238,.28);
}
.mini-area{
  min-height: 92px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.10);
  color:#fff;
  border-radius: 12px;
  margin-top: 8px;
}
</style>

{% endblock %}

{% block extra_js %}
<script>
function normalizeType(v){ return (v || "").toLowerCase().trim(); }

function onPlanTypeChange(fecha){
  const sel = document.getElementById(`planType-${fecha}`);
  if (!sel) return;

  const type = normalizeType(sel.value);

  const endurance = document.getElementById(`enduranceBox-${fecha}`);
  const strength = document.getElementById(`strengthBox-${fecha}`);
  const badge = document.getElementById(`badge-${fecha}`);

  if (badge) badge.textContent = sel.value;

  if (type === "fuerza") {
    endurance?.classList.add("hidden");
    strength?.classList.remove("hidden");
    return;
  }

  if (type === "descanso") {
    endurance?.classList.add("hidden");
    strength?.classList.add("hidden");
    return;
  }

  strength?.classList.add("hidden");
  endurance?.classList.remove("hidden");
  switchMiniTab(fecha, "warmup");
}

function switchMiniTab(fecha, which){
  const tabs = document.querySelectorAll(`.mini-tab[data-fecha="${fecha}"]`);
  tabs.forEach(t => t.classList.toggle("active", t.dataset.target === which));

  ["warmup","main","finisher"].forEach(k=>{
    const el = document.getElementById(`${k}-${fecha}`);
    if (!el) return;
    el.classList.toggle("hidden", k !== which);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll("[id^='planType-']").forEach(sel=>{
    const fecha = sel.id.replace("planType-","");
    onPlanTypeChange(fecha);
  });
});
</script>
{% endblock %}
