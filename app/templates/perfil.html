{% extends "layout.html" %}
{% block title %}{{ user.nombre }} — VR Training{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
{% endblock %}

{% block content %}

<div class="perfil-container">

  <!-- HEADER -->
  <div class="perfil-header text-center mb-5">
    <img src="{{ url_for('static', filename='logo_blanco_vr_training.png') }}"
         class="perfil-logo">

    <h2 class="perfil-nombre">{{ user.nombre }}</h2>
    <p class="perfil-sub info">
      {{ user.email }} • Grupo: {{ user.grupo or '—' }}
    </p>
  </div>

  <!-- BOTONES -->
  <div class="perfil-botones mb-4 text-center">
    {% include "partials/botones_toggle.html" %}
  </div>


  <!-- ========================= -->
  <!-- SEMANA -->
  <!-- ========================= -->
  <div class="perfil-card mb-5">

    <h5 class="perfil-titulo mb-4">
      <i class="bi bi-calendar-week text-info me-2"></i>{{ semana_str }}
    </h5>

    <div class="week-grid">
      {% for f in fechas %}
      {% set plan = planes[f] %}
      {% set tipo = (plan.plan_type or 'descanso')|lower %}
      {% set idx = loop.index %}

      <div class="day-card day-{{ tipo }}"
           data-bs-toggle="modal"
           data-bs-target="#modal{{ idx }}">

        <!-- HEADER DEL DÍA -->
        <div class="day-header">
          <div class="d-flex align-items-center">
            <img src="{{ url_for('static', filename='icons/' ~ tipo ~ '.png') }}" class="day-icon">
            <strong>{{ f.strftime('%a')|upper }} {{ f.day }}</strong>
          </div>
          <span class="badge badge-{{ tipo }}">{{ plan.plan_type|capitalize }}</span>
        </div>

        <!-- CUERPO -->
        <div class="day-body">
          <div><strong>Calentamiento:</strong> {{ plan.warmup or '—' }}</div>
          <div><strong>Bloque:</strong> {{ plan.main or '—' }}</div>
          <div><strong>Final:</strong> {{ plan.finisher or '—' }}</div>
        </div>

        <!-- FEEDBACK -->
        {% if plan.puede_entrenar == 'no' %}
        <div class="estado estado-no">NO puede entrenar</div>

        {% elif plan.puede_entrenar == 'si' %}
        <div class="estado estado-ok">OK para entrenar</div>
        {% endif %}
      </div>

      {% endfor %}
    </div>
  </div>



  <!-- ========================= -->
  <!-- GRÁFICO -->
  <!-- ========================= -->
  <div id="boxGrafico" class="collapse">
    <div class="perfil-card mb-5">
      <h5 class="perfil-titulo mb-3">
        <i class="bi bi-graph-up-arrow text-info me-2"></i>Propuesto vs Realizado
      </h5>
      <div style="height:260px;">
        <canvas id="graficoProgreso"></canvas>
      </div>
    </div>
  </div>



  <!-- ========================= -->
  <!-- CALENDARIO MENSUAL -->
  <!-- ========================= -->
  <div id="boxMes" class="collapse">
    <div class="perfil-card mb-5">

      <h5 class="perfil-titulo mb-3">
        <i class="bi bi-calendar3-range me-2 text-info"></i>
        Calendario mensual — {{ hoy.strftime('%B %Y')|capitalize }}
      </h5>

      <div class="calendar-grid">
        {% for f in dias_mes %}
        {% set plan_mes = planes_mes.get(f) %}
        {% set tipo_mes = (plan_mes.plan_type|lower) if plan_mes else 'descanso' %}

        <div class="calendar-day day-{{ tipo_mes }}
             {% if plan_mes and plan_mes.puede_entrenar == 'no' %} dia-no-entrena{% endif %}">

          <div class="date-number">{{ f.day }}</div>

          {% if plan_mes %}
          <div class="plan-type">{{ plan_mes.plan_type|capitalize }}</div>

          {% if plan_mes.puede_entrenar == 'no' %}
            <span class="estado estado-no-small">No puede entrenar</span>

          {% elif plan_mes.puede_entrenar == 'si' %}
            <span class="estado estado-ok-small">OK</span>
          {% endif %}

          {% else %}
          <div class="plan-empty">—</div>
          {% endif %}
        </div>
        {% endfor %}
      </div>

    </div>
  </div>


  <!-- RUTINAS -->
  {% include "components/rutinas.html" %}

  <!-- MODALES -->
  {% include "components/modales.html" %}

</div>

{% endblock %}


{% block extra_js %}

<!-- GRAFICO -->
<script>
new Chart(document.getElementById("graficoProgreso"), {
  type: "line",
  data: {
    labels: {{ labels|tojson }},
    datasets: [
      {
        label: "Propuesto",
        data: {{ propuesto|tojson }},
        borderColor: "#22d3ee",
        borderWidth: 2,
        tension: 0.4
      },
      {
        label: "Realizado",
        data: {{ realizado|tojson }},
        borderColor: "#00bfff",
        borderWidth: 2,
        tension: 0.4
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { labels: { color: "#ccc" } } },
    scales: {
      x: { ticks: { color: "#aaa" } },
      y: { ticks: { color: "#aaa" } }
    }
  }
});
</script>

<script>
document.getElementById("btnToggleGrafico").onclick =
  () => document.querySelector("#boxGrafico").classList.toggle("show");

document.getElementById("btnToggleMes").onclick =
  () => document.querySelector("#boxMes").classList.toggle("show");
</script>

{% endblock %}
