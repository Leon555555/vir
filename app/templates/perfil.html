{% extends "layout.html" %}
{% block title %}Perfil ‚Äî VR Training{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-3">
      <div class="vr-avatar">
        <i class="bi bi-person-fill text-info"></i>
      </div>

      <div>
        <h2 class="text-light mb-0">{{ user.nombre }}</h2>
        <div class="text-muted">{{ user.email }}</div>

        <div class="mt-2">
          {% if strava_account %}
            <span class="badge bg-success">üü† Strava conectado</span>
          {% else %}
            <a href="{{ url_for('strava.connect') }}" class="btn btn-sm btn-outline-warning">
              üîó Conectar con Strava
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="d-flex gap-2 align-items-center flex-wrap">
      <div class="mini-stat">
        <div class="mini-title">RACHA</div>
        <div class="mini-value">üî• {{ streak }}</div>
      </div>
      <div class="mini-stat">
        <div class="mini-title">SEMANA</div>
        <div class="mini-value">‚úÖ {{ week_done }} / {{ week_goal }}</div>
        <div class="progress mt-2">
          {% set pct = 0 if week_goal==0 else (week_done*100//week_goal) %}
          <div class="progress-bar" style="width: {{ pct }}%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="d-flex gap-2 flex-wrap mb-3">
    <a class="btn btn-sm {% if view=='today' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='today') }}">Hoy</a>

    <a class="btn btn-sm {% if view=='week' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=center.isoformat()) }}">Semana</a>

    <a class="btn btn-sm {% if view=='month' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='month', center=center.isoformat()) }}">Mes</a>

    <a class="btn btn-sm {% if view=='progress' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='progress', center=center.isoformat()) }}">Progreso</a>
  </div>

  {% if view == 'today' %}
    <div class="card glass p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <div>
          <div class="text-muted vr-kicker" style="letter-spacing:.18em;text-transform:uppercase;">HOY</div>
          <div class="d-flex align-items-center gap-2">
            <div class="fs-4 fw-bold">{{ hoy.strftime('%A %d/%m')|upper }}</div>
            <span class="badge bg-secondary">{{ plan_hoy.plan_type }}</span>
          </div>
          <div class="text-muted mt-1">Entr√° y marc√° lo que hiciste.</div>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-info" type="button" onclick="openDay('{{ hoy.isoformat() }}')">
            ‚ñ∂ Empezar
          </button>

          <a class="btn btn-outline-light"
             href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=hoy.isoformat()) }}">
            Ver semana
          </a>
        </div>
      </div>
    </div>
  {% endif %}

  {% if view == 'week' %}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h4 class="text-light mb-0">Semana</h4>
        <div class="text-muted">{{ semana_str }}</div>
      </div>

      <form method="GET" class="d-flex gap-2">
        <input type="hidden" name="view" value="week">
        <input type="date" class="form-control" name="center" value="{{ center.isoformat() }}">
        <button class="btn btn-outline-info" type="submit">Ir</button>
      </form>
    </div>

    <div class="row g-3">
      {% for f in fechas %}
        {% set p = planes[f] %}
        {% set done = (f in done_week) %}
        <div class="col-md-6 col-lg-4">
          <div class="card glass p-3 lift">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold" style="letter-spacing:.08em;">{{ f.strftime('%a %d/%m')|upper }}</div>
              <span class="badge {% if done %}bg-success{% else %}bg-secondary{% endif %}">
                {% if done %}HECHO{% else %}{{ p.plan_type }}{% endif %}
              </span>
            </div>

            <div class="text-muted" style="font-size:.95rem;">
              {% if (p.plan_type or '').lower() == 'descanso' %}
                Descanso / recuperaci√≥n.
              {% else %}
                {{ p.warmup or '‚Äî' }}
              {% endif %}
            </div>

            <div class="d-grid mt-3">
              <button class="btn btn-outline-info" type="button" onclick="openDay('{{ f.isoformat() }}')">
                Ver detalle
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if view == 'month' %}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h4 class="text-light mb-0">Mes</h4>
        <div class="text-muted">{{ month_label }}</div>
      </div>

      <form method="GET" class="d-flex gap-2">
        <input type="hidden" name="view" value="month">
        <input type="month" class="form-control" name="center" value="{{ center.strftime('%Y-%m') }}">
        <button class="btn btn-outline-info" type="submit">Ir</button>
      </form>
    </div>

    <div class="card glass p-3 p-md-4">
      <div class="month-grid">
        <div class="month-head">L</div><div class="month-head">M</div><div class="month-head">X</div>
        <div class="month-head">J</div><div class="month-head">V</div><div class="month-head">S</div><div class="month-head">D</div>

        {% for w in month_grid %}
          {% for d in w %}
            {% if d %}
              {% set pm = planes_mes[d] %}
              {% set blocked = ((pm.puede_entrenar or 'si') == 'no') %}
              <div class="month-cell {% if blocked %}blocked{% endif %}"
                   data-date="{{ d.isoformat() }}"
                   onclick="openDay('{{ d.isoformat() }}')">
                <div class="daynum">{{ d.day }}</div>
              </div>
            {% else %}
              <div class="month-cell empty"></div>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if view == 'progress' %}
    <div class="card glass p-3 p-md-4">
      <div class="mb-2">
        <h4 class="text-light mb-0">Tus progresos</h4>
        <div class="text-muted">Semana actual ¬∑ Objetivo vs completado</div>
      </div>

      <div class="glass p-3 mt-2" style="border-radius:18px;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="mini-title">CONSISTENCIA</div>
          <div class="text-muted" style="font-weight:900;">
            {% set pct = 0 if week_goal==0 else (week_done*100//week_goal) %}
            {{ pct }}%
          </div>
        </div>

        <div class="vr-bars">
          {% for i in range(7) %}
            <div class="vr-bar">
              <div class="vr-bar-fill" style="height: {{ 100 if i < week_done else 0 }}%;"></div>
            </div>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between mt-2 vr-days">
          <span>L</span><span>M</span><span>X</span>
          <span>J</span><span>V</span><span>S</span><span>D</span>
        </div>
      </div>
    </div>
  {% endif %}

</div>

<!-- Modal D√≠a -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-xl">
    <div class="modal-content day-modal">
      <div class="modal-header">
        <div>
          <div class="text-muted" id="dayModalDate" style="letter-spacing:.18em;text-transform:uppercase;"></div>
          <div class="d-flex align-items-center gap-2">
            <h5 class="modal-title mb-0" id="dayModalTitle">Detalle</h5>
            <span class="badge bg-secondary" id="dayModalType">‚Äî</span>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <div class="row g-3">

          <div class="col-lg-5">
            <div class="card glass p-3 h-100">
              <div class="fw-bold mb-2">Plan</div>

              <div class="plan-row">
                <div class="plan-k">Activaci√≥n</div>
                <div class="plan-v" id="planWarmup">‚Äî</div>
              </div>

              <div class="plan-row">
                <div class="plan-k plan-k-small">Bloque principal</div>
                <div class="plan-v" id="planMain">‚Äî</div>
              </div>

              <div class="plan-row">
                <div class="plan-k">Enfriamiento</div>
                <div class="plan-v" id="planFinisher">‚Äî</div>
              </div>

              <div class="mt-3 glass p-3" style="border-radius:16px;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="mini-title">DISPONIBILIDAD</div>
                  <span id="availBadge" class="badge bg-secondary">‚Äî</span>
                </div>

                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="noPuedoToggle">
                  <label class="form-check-label text-muted" for="noPuedoToggle">No puedo entrenar este d√≠a</label>
                </div>

                <textarea class="form-control mt-2" id="noPuedoText"
                          placeholder="Ej: viaje / lesi√≥n / trabajo / etc (corto)"></textarea>

                <button class="btn btn-outline-danger w-100 mt-2" type="button" onclick="saveAvailability()">
                  Guardar bloqueo
                </button>

                <div class="text-muted mt-2" style="font-size:.9rem;">
                  Si bloque√°s el d√≠a, el coach lo ver√° en rojo y no planifica.
                </div>
              </div>

            </div>
          </div>

          <div class="col-lg-7">
            <div class="card glass p-3">
              <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                <div class="fw-bold" id="rightTitle">Lo realizado</div>

                <div class="form-check form-switch m-0">
                  <input class="form-check-input" type="checkbox" id="didTrain">
                  <label class="form-check-label text-muted" for="didTrain">Hoy entren√©</label>
                </div>
              </div>

              <!-- TABATA -->
              <div id="tabataBlock" class="glass p-3 mb-3" style="border-radius:18px; display:none;">

                <!-- PREVIEW (lista + bot√≥n) -->
                <div id="tabataPreview" style="display:none;">
                  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                    <div>
                      <div class="mini-title" style="letter-spacing:.14em;">TABATA</div>
                      <div class="text-strong" id="tabataTitlePreview" style="font-weight:900;">‚Äî</div>
                      <div class="text-muted" id="tabataMetaPreview" style="font-weight:800;">‚Äî</div>
                    </div>
                    <div class="text-strong" style="font-weight:900; font-size:1.25rem;">
                      <span id="tabataTotalPreview">‚Äî</span>
                    </div>
                  </div>

                  <div class="mt-3 glass p-3" style="border-radius:16px;">
                    <div class="fw-bold mb-2" style="letter-spacing:.10em;text-transform:uppercase;">Lista de ejercicios</div>
                    <div id="tabataListPreview" class="d-grid" style="gap:10px;"></div>
                  </div>

                  <div class="d-grid mt-3">
                    <button class="btn btn-info" type="button" onclick="tabataStartFromPreview()">
                      ‚ñ∂ EMPEZAR TABATA
                    </button>
                  </div>

                  <div class="text-muted mt-2" style="font-size:.9rem;">
                    Al empezar: reproduce cada video en bucle durante todo el tiempo de trabajo.
                    Beeps en los √∫ltimos 3s (trabajo y descanso).
                  </div>
                </div>

                <!-- PLAYER (reloj + fase + video/reloj descanso) -->
                <div id="tabataPlayer" style="display:none;">
                  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                      <div class="mini-title" style="letter-spacing:.14em;">TABATA</div>
                      <div class="text-strong" id="tabataTitle" style="font-weight:900;">‚Äî</div>
                      <div class="text-muted" id="tabataPhase" style="font-weight:800;">‚Äî</div>
                    </div>

                    <div class="text-strong" style="font-weight:900; font-size:1.25rem;">
                      <span id="tabataTimer">00:00</span>
                    </div>
                  </div>

                  <div class="mt-3" id="tabataVisual">
                    <video id="tabataVideo" class="w-100" controls playsinline webkit-playsinline preload="metadata"
                           style="border-radius:16px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.35); min-height:240px; object-fit:cover;">
                    </video>
                  </div>

                  <div class="d-flex gap-2 mt-3 flex-wrap">
                    <button class="btn btn-outline-info btn-sm" type="button" onclick="tabataPlay()">‚ñ∂ Play</button>
                    <button class="btn btn-outline-light btn-sm" type="button" onclick="tabataPause()">‚è∏ Pausa</button>
                    <button class="btn btn-outline-warning btn-sm" type="button" onclick="tabataNext()">‚è≠ Siguiente</button>
                    <button class="btn btn-outline-danger btn-sm" type="button" onclick="tabataStop()">‚èπ Stop</button>
                  </div>

                  <div class="text-muted mt-2" style="font-size:.9rem;">
                    En descanso aparece reloj + cuenta atr√°s.
                  </div>
                </div>

              </div>

              <div id="strengthItems" class="row g-3"></div>

              <div class="mt-3">
                <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap">
                  <div class="section-title">Gui√≥n</div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-info btn-sm" type="button" onclick="genSessionScript()">
                      ‚ú® Generar
                    </button>
                  </div>
                </div>
                <div id="scriptBox" class="glass p-3 mt-2"
                     style="border-radius:16px; white-space:pre-wrap; line-height:1.35; font-size:.98rem;">
                  <div class="text-muted">Toc√° ‚ÄúGenerar‚Äù para ver el gui√≥n del d√≠a.</div>
                </div>
              </div>

              <div class="mt-3">
                <div class="text-muted mb-2" style="letter-spacing:.14em;text-transform:uppercase;">Qu√© hiciste</div>

                <textarea class="form-control mb-2" id="doneWarmup" placeholder="Activaci√≥n realizada..."></textarea>
                <textarea class="form-control mb-2" id="doneMain" placeholder="Bloque principal realizado..."></textarea>
                <textarea class="form-control mb-2" id="doneFinisher" placeholder="Enfriamiento realizada..."></textarea>

                <button class="btn btn-primary w-100 mt-2" onclick="saveLog()">
                  üíæ Guardar
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.day-modal{ background: radial-gradient(circle at 50% 20%, #111 0%, #000 90%) !important; color: rgba(255,255,255,.92);}
.day-modal .modal-body{ background: transparent; }

.plan-row{ padding: 12px 10px; border: 1px solid rgba(255,255,255,.10); border-radius: 16px; background: rgba(255,255,255,.03); margin-bottom: 10px;}
.plan-k{ font-weight: 900; letter-spacing: .08em; text-transform: uppercase; color: rgba(255,255,255,.78); font-size: .82rem;}
.plan-k-small{ font-size:.72rem; opacity:.78; }
.plan-v{ margin-top: 6px; font-size: 1.05rem; font-weight: 700; color: rgba(255,255,255,.94); }

.exercise-card{ border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); border-radius: 18px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.35);}
.exercise-head{ padding: 10px 12px; display:flex; justify-content: space-between; align-items:flex-start; gap:10px;}
.exercise-name{ font-weight: 900; font-size: 1.02rem; color: rgba(255,255,255,.96); }
.exercise-meta{ font-size:.92rem; color: rgba(255,255,255,.80); }
.exercise-video{ padding: 10px 12px 12px; }
.exercise-video video{ width:100%; border-radius: 16px; border: 1px solid rgba(255,255,255,.18); background: rgba(0,0,0,.35); min-height: 220px; object-fit: cover; }

.done-pill{ display:flex; align-items:center; gap:8px;}
.done-pill .form-check-label{ color: rgba(255,255,255,.70); font-weight: 800; }

.month-head{ color: rgba(255,255,255,.72) !important; }
.month-cell{ background: rgba(0,0,0,.42) !important; }
.month-cell .daynum{ color: rgba(255,255,255,.92) !important; }

.month-cell.blocked{ background: rgba(255, 59, 48, 0.18) !important; border: 1px solid rgba(255, 59, 48, 0.55) !important; box-shadow: 0 0 0 1px rgba(255,59,48,0.15) inset; }
.month-cell.blocked .daynum{ color: rgba(255,255,255,.95) !important; }

.vr-days span{ color: rgba(255,255,255,.78); font-weight: 900; letter-spacing:.08em;}
</style>
{% endblock %}

{% block extra_js %}
<script>
let DAY_MODAL = null;
let CURRENT_DAY = null;
let CURRENT_USER = {{ user.id }};
let CURRENT_ITEMS = [];

// Seguridad: si bootstrap no existe, que explote claro
if(typeof bootstrap === "undefined"){
  console.error("Bootstrap JS no est√° cargado. Revis√° layout.html");
}

/* =========================
   BEEPS (√∫ltimos 3 segundos)
========================= */
let AUDIO_CTX = null;

function ensureAudio(){
  if(!AUDIO_CTX){
    const AC = window.AudioContext || window.webkitAudioContext;
    AUDIO_CTX = AC ? new AC() : null;
  }
  if(AUDIO_CTX && AUDIO_CTX.state === "suspended"){
    AUDIO_CTX.resume().catch(()=>{});
  }
}

function beep(freq=880, ms=120, gain=0.12){
  if(!AUDIO_CTX) return;

  const t0 = AUDIO_CTX.currentTime;
  const osc = AUDIO_CTX.createOscillator();
  const g = AUDIO_CTX.createGain();

  osc.type = "sine";
  osc.frequency.setValueAtTime(freq, t0);

  g.gain.setValueAtTime(0.0001, t0);
  g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, t0 + ms/1000);

  osc.connect(g);
  g.connect(AUDIO_CTX.destination);

  osc.start(t0);
  osc.stop(t0 + ms/1000 + 0.02);
}

function play3sBeep(t){
  if(t === 3) beep(880, 120, 0.12);   // pi
  if(t === 2) beep(988, 120, 0.12);   // pii
  if(t === 1) beep(1108, 160, 0.14);  // ppiii
}

/* =========================
   TABATA PLAYER
========================= */
let TABATA = {
  active: false,
  phase: "idle",
  idx: 0,
  set: 1,
  t: 0,
  interval: null,
  items: [],
  cfg: null
};

function fmt(s){
  s = Math.max(0, Math.floor(s||0));
  const m = String(Math.floor(s/60)).padStart(2,"0");
  const ss = String(s%60).padStart(2,"0");
  return `${m}:${ss}`;
}
function tabataUI(title, phase){
  const elT = document.getElementById("tabataTitle");
  const elP = document.getElementById("tabataPhase");
  if(elT) elT.textContent = title || "TABATA";
  if(elP) elP.textContent = phase || "";
}
function tabataSetTimer(seconds){
  const el = document.getElementById("tabataTimer");
  if(el) el.textContent = fmt(seconds);
}
function tabataClearInterval(){
  if(TABATA.interval){
    clearInterval(TABATA.interval);
    TABATA.interval = null;
  }
}
function showTabataClock(seconds){
  const vis = document.getElementById("tabataVisual");
  if(!vis) return;
  vis.innerHTML = `
    <div class="glass p-4" style="border-radius:16px; text-align:center;">
      <div style="font-size:54px; margin-bottom:8px;">‚è±Ô∏è</div>
      <div class="text-strong" style="font-weight:900; font-size:1.6rem;">RECUPERACI√ìN</div>
      <div class="text-muted" style="margin-top:6px;">${fmt(seconds)}</div>
    </div>
  `;
}
function ensureTabataVideo(){
  const vis = document.getElementById("tabataVisual");
  if(!vis) return;
  if(!document.getElementById("tabataVideo")){
    vis.innerHTML = `
      <video id="tabataVideo" class="w-100" controls playsinline webkit-playsinline preload="metadata"
        style="border-radius:16px; border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.35); min-height:240px; object-fit:cover;">
      </video>
    `;
  }
}

/* ==========
   PREVIEW UI
========== */
function renderTabataPreview(){
  const prev = document.getElementById("tabataPreview");
  const player = document.getElementById("tabataPlayer");
  const list = document.getElementById("tabataListPreview");
  const title = document.getElementById("tabataTitlePreview");
  const meta = document.getElementById("tabataMetaPreview");
  const total = document.getElementById("tabataTotalPreview");

  if(!prev || !player || !list) return;

  prev.style.display = "";
  player.style.display = "none";

  const cfg = TABATA.cfg || {};
  const rounds = cfg.rounds ?? (TABATA.items?.length || 0);
  const sets = cfg.sets ?? 1;
  const work = cfg.work ?? 40;
  const rest = cfg.rest ?? 20;

  if(title) title.textContent = (cfg.title || "Tabata");
  if(meta) meta.textContent = `${work}s trabajo ¬∑ ${rest}s descanso ¬∑ ${rounds} ejercicios ¬∑ ${sets} set(s)`;
  if(total) total.textContent = `${TABATA.items.length} ejercicios`;

  list.innerHTML = "";
  TABATA.items.forEach((it, i) => {
    const div = document.createElement("div");
    div.className = "glass p-2";
    div.style.borderRadius = "14px";
    div.innerHTML = `
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-bold">${i+1}. ${escapeHtml(it.nombre || "Ejercicio")}</div>
        <div class="text-muted" style="font-weight:900;">${work}s</div>
      </div>
    `;
    list.appendChild(div);
  });
}

function tabataStartFromPreview(){
  // ‚úÖ gesto de usuario: habilita audio (iOS) y beeps
  ensureAudio();

  const prev = document.getElementById("tabataPreview");
  const player = document.getElementById("tabataPlayer");
  if(prev) prev.style.display = "none";
  if(player) player.style.display = "";

  tabataStop();                 // resetea bien
  TABATA.phase = "count_in";
  TABATA.t = (TABATA.cfg?.count_in ?? 3);
  tabataPlay();
}

/* ==========
   CONTROLES
========== */
function tabataStop(){
  TABATA.active = false;
  TABATA.phase = "idle";
  TABATA.idx = 0;
  TABATA.set = 1;
  TABATA.t = 0;
  tabataClearInterval();
  tabataUI("TABATA", "Detenido");
  tabataSetTimer(0);

  const v = document.getElementById("tabataVideo");
  if(v){
    v.loop = false;
    try{ v.pause(); }catch(e){}
    v.removeAttribute("src");
    v.load();
  }
}
function tabataPlay(){
  if(!TABATA.cfg || !TABATA.items.length) return;
  if(TABATA.active) return;
  TABATA.active = true;
  if(TABATA.phase === "idle"){
    TABATA.phase = "count_in";
    TABATA.t = TABATA.cfg.count_in ?? 3;
  }
  tabataTickStart();
}
function tabataPause(){
  TABATA.active = false;
  tabataClearInterval();
  const v = document.getElementById("tabataVideo");
  if(v){
    v.loop = false;
    try{ v.pause(); }catch(e){}
  }
}

function tabataApplyWork(){
  const it = TABATA.items[TABATA.idx];
  const name = it?.nombre || "Ejercicio";
  tabataUI(`Ejercicio ${TABATA.idx + 1} ¬∑ ${name}`, "TRABAJO");

  ensureTabataVideo();
  const v = document.getElementById("tabataVideo");
  const src = it?.video_src || "";

  // ‚úÖ LOOP: si el video dura 5s y trabajo 40s, se repite hasta completar
  if(v) v.loop = true;

  if(v && src){
    if(v.src !== src){
      v.src = src;
      v.load();
    }
    setTimeout(()=>{ try{ v.play(); }catch(e){} }, 120);
  }
  tabataSetTimer(TABATA.t);
}

function tabataApplyRest(label){
  // ‚úÖ corta loop del video al salir de TRABAJO
  const v = document.getElementById("tabataVideo");
  if(v){ v.loop = false; }

  tabataUI("RECUPERACI√ìN", label || "DESCANSO");
  tabataSetTimer(TABATA.t);
  showTabataClock(TABATA.t);
  if(v){ try{ v.pause(); }catch(e){} }
}

function tabataAdvance(){
  if(TABATA.phase === "count_in"){
    TABATA.phase = "work";
    TABATA.t = TABATA.cfg.work ?? 40;
    TABATA.idx = 0;
    tabataApplyWork();
    return;
  }
  if(TABATA.phase === "work"){
    TABATA.phase = "rest";
    TABATA.t = TABATA.cfg.rest ?? 20;
    tabataApplyRest("DESCANSO");
    return;
  }
  if(TABATA.phase === "rest"){
    TABATA.idx += 1;
    const rounds = TABATA.cfg.rounds ?? TABATA.items.length;
    const sets = TABATA.cfg.sets ?? 1;

    if(TABATA.idx >= rounds){
      TABATA.idx = 0;
      TABATA.set += 1;

      if(TABATA.set > sets){
        TABATA.phase = "finisher";
        TABATA.t = TABATA.cfg.finisher_rest ?? 60;
        tabataApplyRest("FINAL");
        return;
      }
      TABATA.phase = "between_sets";
      TABATA.t = TABATA.cfg.rest_between_sets ?? 60;
      tabataApplyRest(`SET ${TABATA.set - 1} COMPLETO`);
      return;
    }

    TABATA.phase = "work";
    TABATA.t = TABATA.cfg.work ?? 40;
    tabataApplyWork();
    return;
  }
  if(TABATA.phase === "between_sets"){
    TABATA.phase = "work";
    TABATA.t = TABATA.cfg.work ?? 40;
    tabataApplyWork();
    return;
  }
  if(TABATA.phase === "finisher"){
    tabataUI("TABATA", "‚úÖ FINALIZADO");
    tabataStop();
    return;
  }
}

function tabataTickStart(){
  tabataClearInterval();

  if(TABATA.phase === "count_in"){
    tabataUI("TABATA", "EMPIEZA EN...");
    tabataSetTimer(TABATA.t);
    showTabataClock(TABATA.t);
  }else if(TABATA.phase === "work"){
    tabataApplyWork();
  }else{
    tabataApplyRest("RECUPERACI√ìN");
  }

  TABATA.interval = setInterval(()=>{
    if(!TABATA.active) return;

    TABATA.t -= 1;

    // ‚úÖ BEEPS: √∫ltimos 3 segundos en trabajo y descanso (y en cualquier fase activa)
    if(TABATA.t === 3 || TABATA.t === 2 || TABATA.t === 1){
      play3sBeep(TABATA.t);
    }

    tabataSetTimer(TABATA.t);

    if(TABATA.phase !== "work"){
      showTabataClock(TABATA.t);
    }

    if(TABATA.t <= 0){
      tabataAdvance();
    }
  }, 1000);
}

function tabataNext(){
  if(!TABATA.cfg || !TABATA.items.length) return;

  TABATA.phase = "work";
  TABATA.t = TABATA.cfg.work ?? 40;
  TABATA.idx = (TABATA.idx + 1) % TABATA.items.length;

  tabataApplyWork();
  tabataTickStart();
}

/* =========================
   HELPERS
========================= */
function posterDataUrl(title){
  const safe = (title || "VR TRAINING").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="1280" height="720">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#0b0f12"/>
        <stop offset="1" stop-color="#050608"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#g)"/>
    <rect x="40" y="40" width="1200" height="640" rx="36" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.16)"/>
    <circle cx="640" cy="360" r="62" fill="rgba(34,211,238,0.18)" stroke="rgba(34,211,238,0.45)" stroke-width="6"/>
    <polygon points="625,330 625,390 680,360" fill="rgba(255,255,255,0.85)"/>
    <text x="80" y="130" font-size="46" fill="rgba(255,255,255,0.92)" font-family="Arial" font-weight="700">${safe}</text>
    <text x="80" y="180" font-size="26" fill="rgba(255,255,255,0.60)" font-family="Arial">VR Training</text>
  </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function setAvailUI(puede, comentario){
  const toggle = document.getElementById("noPuedoToggle");
  const text = document.getElementById("noPuedoText");
  const badge = document.getElementById("availBadge");

  const blocked = (puede === "no");
  toggle.checked = blocked;
  text.value = comentario || "";

  if(blocked){
    badge.className = "badge bg-danger";
    badge.textContent = "NO PUEDE";
  }else{
    badge.className = "badge bg-success";
    badge.textContent = "OK";
  }
}

function openDay(isoDate){
  CURRENT_DAY = isoDate;

  if(typeof bootstrap === "undefined"){
    alert("Bootstrap JS no carg√≥. Revis√° layout.html (bootstrap.bundle.min.js).");
    return;
  }
  if(!DAY_MODAL){
    DAY_MODAL = new bootstrap.Modal(document.getElementById("dayModal"));
  }

  document.getElementById("dayModalDate").textContent = isoDate;
  document.getElementById("dayModalTitle").textContent = "Cargando...";
  document.getElementById("dayModalType").textContent = "‚Äî";
  document.getElementById("strengthItems").innerHTML = "";
  document.getElementById("scriptBox").innerHTML = `<div class="text-muted">Toc√° ‚ÄúGenerar‚Äù para ver el gui√≥n del d√≠a.</div>`;

  tabataStop();
  document.getElementById("tabataBlock").style.display = "none";
  const prev = document.getElementById("tabataPreview");
  const player = document.getElementById("tabataPlayer");
  if(prev) prev.style.display = "none";
  if(player) player.style.display = "none";
  setAvailUI("si", "");

  fetch(`/api/day_detail?user_id=${CURRENT_USER}&fecha=${encodeURIComponent(isoDate)}`)
    .then(r => r.json())
    .then(data => {
      if(!data.ok) throw new Error(data.error || "Error");
      const p = data.plan || {};

      document.getElementById("dayModalTitle").textContent = (data.rutina?.nombre ? data.rutina.nombre : "Detalle del d√≠a");
      document.getElementById("dayModalType").textContent = p.plan_type || "‚Äî";

      document.getElementById("planWarmup").textContent = p.warmup || "‚Äî";
      document.getElementById("planMain").textContent = p.main || "‚Äî";
      document.getElementById("planFinisher").textContent = p.finisher || "‚Äî";

      setAvailUI(p.puede_entrenar || "si", p.comentario_atleta || "");

      document.getElementById("didTrain").checked = !!data.log?.did_train;
      document.getElementById("doneWarmup").value = data.log?.warmup_done || "";
      document.getElementById("doneMain").value = data.log?.main_done || "";
      document.getElementById("doneFinisher").value = data.log?.finisher_done || "";

      CURRENT_ITEMS = Array.isArray(data.items) ? data.items : [];
      const doneIds = new Set(Array.isArray(data.checks) ? data.checks : []);
      renderStrength(CURRENT_ITEMS, doneIds);

      const tabBlock = document.getElementById("tabataBlock");
      if(data.is_tabata && data.tabata_cfg && Array.isArray(data.items) && data.items.length){
        tabBlock.style.display = "";
        TABATA.cfg = data.tabata_cfg;
        TABATA.items = data.items;

        // üî• muestra preview con lista + bot√≥n empezar (no auto-start)
        renderTabataPreview();
      }else{
        tabBlock.style.display = "none";
        tabataStop();
      }

      DAY_MODAL.show();
    })
    .catch(err => {
      console.error(err);
      alert("Error cargando el d√≠a: " + err.message);
    });
}

function renderStrength(items, doneIds){
  const wrap = document.getElementById("strengthItems");
  wrap.innerHTML = "";
  if(!items.length) return;

  items.forEach(it => {
    const col = document.createElement("div");
    col.className = "col-12";

    const checked = doneIds.has(it.id) ? "checked" : "";
    const vidSrc = it.video_src || "";
    const poster = posterDataUrl(it.nombre);

    col.innerHTML = `
      <div class="exercise-card">
        <div class="exercise-head">
          <div>
            <div class="exercise-name">${escapeHtml(it.nombre || "Ejercicio")}</div>
            <div class="exercise-meta">
              ${escapeHtml(it.series || "")}${it.series ? " ¬∑ " : ""}${escapeHtml(it.reps || "")}
              ${it.descanso ? (" ¬∑ Desc " + escapeHtml(it.descanso)) : ""}
            </div>
          </div>

          <div class="done-pill">
            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" ${checked}
                     onchange="toggleItem(${it.id}, this.checked)">
            </div>
            <div class="text-muted" style="font-weight:900;letter-spacing:.08em;">HECHO</div>
          </div>
        </div>

        <div class="exercise-video">
          ${vidSrc ? `
            <video controls playsinline webkit-playsinline preload="metadata" poster="${poster}">
              <source src="${vidSrc}" type="video/mp4">
            </video>
          ` : `<div class="text-muted">Sin video</div>`}
        </div>
      </div>
    `;
    wrap.appendChild(col);
  });
}

function toggleItem(itemId, done){
  const form = new FormData();
  form.append("user_id", String(CURRENT_USER));
  form.append("fecha", String(CURRENT_DAY));
  form.append("item_id", String(itemId));
  form.append("done", done ? "1" : "0");

  fetch("/athlete/check_item", { method:"POST", body: form })
    .then(r => r.json())
    .then(j => { if(!j.ok) throw new Error(j.error || "Error"); })
    .catch(err => { console.error(err); alert("Error guardando check: " + err.message); });
}

function saveLog(){
  const payload = {
    user_id: CURRENT_USER,
    fecha: CURRENT_DAY,
    did_train: document.getElementById("didTrain").checked,
    warmup_done: document.getElementById("doneWarmup").value || "",
    main_done: document.getElementById("doneMain").value || "",
    finisher_done: document.getElementById("doneFinisher").value || ""
  };

  fetch("/athlete/save_log", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(j => { if(!j.ok) throw new Error(j.error || "Error"); alert("‚úÖ Guardado"); })
  .catch(err => { console.error(err); alert("Error guardando: " + err.message); });
}

async function saveAvailability(){
  const noPuedo = document.getElementById("noPuedoToggle").checked;
  const comentario = document.getElementById("noPuedoText").value || "";

  const payload = { user_id: CURRENT_USER, fecha: CURRENT_DAY, no_puedo: noPuedo, comentario };

  try{
    const res = await fetch("/athlete/save_availability", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || "Error");

    setAvailUI(noPuedo ? "no" : "si", comentario);

    const cell = document.querySelector(`.month-cell[data-date="${CSS.escape(CURRENT_DAY)}"]`);
    if(cell){
      if(noPuedo) cell.classList.add("blocked");
      else cell.classList.remove("blocked");
    }

    alert("‚úÖ Guardado");
  }catch(err){
    console.error(err);
    alert("Error guardando disponibilidad: " + err.message);
  }
}

async function genSessionScript(){
  const box = document.getElementById("scriptBox");
  box.innerHTML = `<div class="text-muted">Generando gui√≥n...</div>`;

  try{
    const res = await fetch("/ai/session_script", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ user_id: CURRENT_USER, fecha: CURRENT_DAY })
    });
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "Error");
    box.textContent = data.script || "‚Äî";
  }catch(err){
    box.innerHTML = `<div class="text-muted">Error: ${err.message}</div>`;
  }
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
{% endblock %}
