{% extends "layout.html" %}
{% block title %}Urban Athletics | Perfil{% endblock %}

{% block content %}
<style>
  body { background-color: #0f1115; color: #fff; font-family: 'Poppins', sans-serif; }
  h3, h4, h5 { font-weight: 700; }
  .card-ua {
    background: linear-gradient(145deg, #1a1d22, #121418);
    border: 1px solid #23262b;
    border-radius: 18px;
    box-shadow: 0 0 25px rgba(0,0,0,0.3);
    padding: 20px;
  }
  .ua-accent { color: #00e0ff; }
  .ua-orange { color: #ff3c00; }
  .ua-progress { background: #222; height: 12px; border-radius: 10px; overflow: hidden; }
  .ua-progress-bar { background: linear-gradient(90deg, #ff3c00, #ff9100); height: 100%; border-radius: 10px; }
  .ua-btn { background: linear-gradient(90deg, #ff3c00, #ff9100); border: none; color: #fff; border-radius: 12px; padding: 8px 18px; font-weight: 600; }
  .ua-btn-outline { border: 1px solid #ff3c00; color: #ff3c00; background: transparent; border-radius: 12px; padding: 8px 18px; font-weight: 600; }
  .card-mini { background: linear-gradient(120deg, #1c1f25, #15171b); border: 1px solid #2c2f35; border-radius: 14px; padding: 15px 18px; transition: all 0.3s; }
  .card-mini:hover { transform: scale(1.02); }
  .grad-orange { background: linear-gradient(135deg, #ff3c00, #ff9100); }
  .grad-blue { background: linear-gradient(135deg, #00c3ff, #0066ff); }
  .calendar-day { border: 1px solid #2a2d33; min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 10px; margin: 4px; transition: all 0.2s; }
  .calendar-day:hover { background-color: #1b1f25; cursor: pointer; }
  .video-card iframe { border-radius: 14px; }
</style>

<div class="container py-4">

  <!-- HEADER -->
  <div class="card-ua mb-4 d-flex flex-wrap justify-content-between align-items-center">
    <div class="d-flex align-items-center mb-3 mb-md-0">
      <img src="https://i.pravatar.cc/140?img=57" class="rounded-circle me-3" width="100" height="100">
      <div>
        <h3 class="mb-0">{{ atleta.nombre }}</h3>
        <p class="text-secondary mb-0">{{ atleta.email }}</p>
        <small class="text-muted">Miembro desde 2024 · Urban Athletics 🏃</small>
      </div>
    </div>
    <div>
      <button id="btnEditar" class="ua-btn-outline me-2">✏️ Editar perfil</button>
      <a href="{{ url_for('main.logout') }}" class="ua-btn">Cerrar sesión</a>
    </div>
  </div>

  <!-- DATOS PERSONALES -->
  <div id="formPerfil" class="collapse mb-4 card-ua">
    <h5 class="ua-accent mb-3">🏋️ Datos personales</h5>
    <form id="perfilForm">
      <input type="hidden" name="id" value="{{ atleta.id }}">
      <div class="row g-3">
        <div class="col-md-2"><input class="form-control" name="edad" type="number" placeholder="Edad" value="{{ atleta.edad }}"></div>
        <div class="col-md-2"><input class="form-control" name="altura" type="number" placeholder="Altura (cm)" value="{{ atleta.altura }}"></div>
        <div class="col-md-2"><input class="form-control" name="peso" type="number" placeholder="Peso (kg)" value="{{ atleta.peso }}"></div>
        <div class="col-md-3"><input class="form-control" name="telefono" type="text" placeholder="Teléfono" value="{{ atleta.telefono }}"></div>
        <div class="col-md-3"><input class="form-control" name="email" type="email" placeholder="Email" value="{{ atleta.email }}"></div>
      </div>
      <button type="submit" class="ua-btn mt-3">Guardar cambios</button>
    </form>
  </div>

  <!-- SECCIÓN 1: ÚLTIMO / PRÓXIMO ENTRENAMIENTO -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card-mini grad-blue text-white">
        <h5>Último entrenamiento</h5>
        {% if entrenamientos_mes %}
          {% set last = entrenamientos_mes[-1] %}
          <p class="mb-0 fw-bold">{{ last.tipo }} - {{ last.fecha.strftime('%d/%m/%Y') }}</p>
          <small>{{ last.detalle }}</small>
        {% else %}
          <small>No hay entrenamientos recientes.</small>
        {% endif %}
      </div>
    </div>
    <div class="col-md-6">
      <div class="card-mini grad-orange text-white">
        <h5>Próximo entrenamiento</h5>
        {% set next = None %}
        {% for e in entrenamientos_mes %}
          {% if next is none and e.fecha.date() > hoy and not e.bloqueado %}
            {% set next = e %}
          {% endif %}
        {% endfor %}
        {% if next %}
          <p class="mb-0 fw-bold">{{ next.tipo }} - {{ next.fecha.strftime('%d/%m/%Y') }}</p>
          <small>{{ next.detalle }}</small>
        {% else %}
          <small>No hay próximos entrenamientos planificados.</small>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- SECCIÓN 2: CALENDARIO -->
  <div class="card-ua mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5>📅 {{ mes_label }}</h5>
      <button id="toggleMes" class="ua-btn-outline">Ver mes completo</button>
    </div>
    {% for semana in semanas %}
      <div class="d-flex justify-content-between flex-wrap semana {% if not semana.es_actual %}d-none{% endif %}">
        {% for dia in semana.dias %}
          {% if dia != 0 %}
          <div class="calendar-day text-center text-white" data-dia="{{ dia }}">
            <strong>{{ dia }}</strong>
            <div class="mt-2">
              {% set dia_str = "%02d"|format(dia) %}
              {% set encontrado = False %}
              {% for e in entrenamientos_mes %}
                {% if e.fecha.strftime('%d') == dia_str %}
                  {% set encontrado = True %}
                  {% if e.bloqueado %}<div class="text-muted">🔒</div>
                  {% elif e.tipo == "Run" %}<div>🏃</div>
                  {% elif e.tipo == "Fuerza" %}<div>🏋️</div>
                  {% elif e.tipo == "Estiramientos" %}<div>🤸</div>
                  {% endif %}
                {% endif %}
              {% endfor %}
              {% if not encontrado %}
                <button class="btn btn-sm btn-outline-light btn-agendar mt-1" data-dia="{{ dia }}">＋</button>
                <button class="btn btn-sm btn-outline-danger btn-bloquear mt-1" data-dia="{{ dia }}">⛔</button>
              {% endif %}
            </div>
          </div>
          {% endif %}
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <!-- SECCIÓN 3: PROGRESO + GRÁFICO + RESUMEN SEMANAL -->
  <div class="card-ua mb-4">
    <h5 class="mb-2">📊 Tu progreso mensual</h5>
    <div class="ua-progress mb-2">
      <div class="ua-progress-bar" style="width: {{ progreso|round(0) }}%;"></div>
    </div>
    <p class="text-muted">{{ progreso|round(1) }}% completado</p>
    <canvas id="graficoRendimiento" height="80"></canvas>

    <!-- RESUMEN SEMANAL -->
    <div class="mt-4 text-center">
      <h5 class="ua-accent mb-2">🏁 Resumen semanal</h5>
      <p class="mb-0">Entrenamientos: <strong>{{ resumen.semanales }}</strong> |
        Minutos totales: <strong>{{ resumen.minutos }}</strong> |
        Kilómetros: <strong>{{ resumen.km }}</strong></p>
    </div>
  </div>

  <!-- SECCIÓN 4: VIDEOS -->
  <div class="card-ua mb-5">
    <h5 class="ua-accent mb-3">🎥 Entrenamientos Online</h5>
    <div class="row g-3">
      <div class="col-md-4 video-card"><iframe width="100%" height="200" src="https://www.youtube.com/embed/UBMk30rjy0o" allowfullscreen></iframe></div>
      <div class="col-md-4 video-card"><iframe width="100%" height="200" src="https://www.youtube.com/embed/2MoGxae-zyo" allowfullscreen></iframe></div>
      <div class="col-md-4 video-card"><iframe width="100%" height="200" src="https://www.youtube.com/embed/I_izvAbhExY" allowfullscreen></iframe></div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', ()=>{
  // Chart dinámico
  const ctx=document.getElementById('graficoRendimiento');
  new Chart(ctx,{type:'bar',
    data:{
      labels:['Lun','Mar','Mié','Jue','Vie','Sáb','Dom'],
      datasets:[{label:'Minutos entrenados',
      data:[45,30,0,60,0,90,20],
      backgroundColor:['#ff3c00','#ff3c00','#00e0ff','#ff3c00','#00e0ff','#ff9100','#ff3c00']}]
    },
    options:{scales:{y:{beginAtZero:true}},plugins:{legend:{display:false}}}
  });

  const perfilForm=document.getElementById('perfilForm');
  const btnEditar=document.getElementById('btnEditar');
  btnEditar.addEventListener('click',()=>new bootstrap.Collapse(document.getElementById('formPerfil')).toggle());
  perfilForm.addEventListener('submit',async e=>{
    e.preventDefault();
    const data=Object.fromEntries(new FormData(perfilForm).entries());
    const r=await fetch('/guardar_perfil',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
    const j=await r.json();alert(j.msg);
  });
  document.getElementById('toggleMes').addEventListener('click',()=>{
    document.querySelectorAll('.semana').forEach(s=>s.classList.toggle('d-none'));
  });
});
</script>
{% endblock %}
