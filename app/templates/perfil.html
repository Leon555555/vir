{% extends "layout.html" %}
{% block title %}Perfil de {{ user.nombre }} ‚Äî VR Training{% endblock %}

{% block content %}
<div class="perfil-container">

  <!-- HEADER -->
  <div class="text-center mb-4">
    <img src="{{ url_for('static', filename='logo_blanco_vr_training.png') }}" class="perfil-logo" alt="VR Training">
    <h2 class="perfil-nombre mt-2">{{ user.nombre }}</h2>
    <div class="perfil-sub">
      {{ user.email }} ‚Ä¢ Grupo: {{ user.grupo or '‚Äî' }}
    </div>
  </div>

  <!-- TABS -->
  <ul class="nav nav-tabs nav-vr-tabs justify-content-center mb-4" id="perfilTabs">
    <li class="nav-item"><button class="nav-link active" data-tab="semana">üìÖ Semana</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="calendario">üóìÔ∏è Calendario</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="progreso">üìà Progreso</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="rutinas">üèãÔ∏è Rutinas</button></li>
  </ul>

  <!-- TAB SEMANA -->
  <section id="tab-semana" class="vr-tab active">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-light mb-3">{{ semana_str }}</h5>

      <div class="week-grid">
        {% for f in fechas %}
          {% set plan = planes[f] %}
          {% set tipo = (plan.plan_type or 'descanso')|lower %}
          {% set rutina = rutina_by_day.get(f) %}
          {% set items = items_by_day.get(f, []) %}
          {% set plan_label = (plan.plan_type or 'Descanso') %}
          {% set collapse_id = "dayDetails_" ~ f.strftime("%Y%m%d") %}

          <div class="day-card day-{{ tipo }} js-day-card" data-target="{{ collapse_id }}">

            <!-- HEADER (pro + chevron) -->
            <div class="day-header">
              <div class="d-flex justify-content-between align-items-center">
                <strong>{{ f.strftime('%a')|upper }} {{ f.day }}</strong>
                <span class="badge badge-{{ tipo }}">{{ plan_label|capitalize }}</span>
              </div>
              <div class="day-subrow">
                <div class="day-subtext">
                  {% if rutina %}
                    <div class="text-info small">
                      <strong>Rutina:</strong> {{ rutina.nombre }}
                    </div>
                    <div class="text-muted small">
                      {% if items and items|length > 0 %}
                        {{ items|length }} ejercicios
                      {% else %}
                        Sin ejercicios
                      {% endif %}
                    </div>
                  {% else %}
                    <div class="small text-muted">Sin rutina asignada.</div>
                  {% endif %}
                </div>

                <div class="day-chevron" aria-hidden="true">‚ñº</div>
              </div>
            </div>

            <!-- DETALLE (animado) -->
            <div id="{{ collapse_id }}" class="day-details" style="max-height:0; overflow:hidden;">
              <div class="day-details-inner">

                {% if rutina %}
                  {% if items and items|length > 0 %}
                    {% for it in items %}
                      <div class="exercise-card">
                        <div class="d-flex justify-content-between align-items-center">
                          <div class="small"><strong>{{ it.nombre }}</strong></div>

                          {% set is_done = (f, it.id) in done_set %}
                          <button type="button"
                                  class="btn btn-sm {% if is_done %}btn-success{% else %}btn-outline-info{% endif %} js-no-toggle"
                                  onclick="toggleDone('{{ f.strftime('%Y-%m-%d') }}', {{ it.id }}, {{ 0 if is_done else 1 }}, this)">
                            {% if is_done %}‚úÖ Realizado{% else %}Marcar realizado{% endif %}
                          </button>
                        </div>

                        {% if it.series or it.reps or it.descanso %}
                          <div class="text-muted small mt-1">
                            {% if it.series %}Series: {{ it.series }}{% endif %}
                            {% if it.reps %} ‚Ä¢ Reps: {{ it.reps }}{% endif %}
                            {% if it.descanso %} ‚Ä¢ Descanso: {{ it.descanso }}{% endif %}
                          </div>
                        {% endif %}

                        {% if it.video_url %}
                          <video class="w-100 rounded mt-2 js-no-toggle" controls preload="metadata" style="max-height:220px;">
                            <source src="{{ url_for('static', filename=it.video_url) }}" type="video/mp4">
                          </video>
                        {% endif %}

                        {% if it.nota %}
                          <div class="small text-secondary mt-1">{{ it.nota }}</div>
                        {% endif %}
                      </div>
                    {% endfor %}
                  {% else %}
                    <div class="pro-panel">
                      <div class="panel-title">Rutina</div>
                      <div class="panel-body">Esta rutina todav√≠a no tiene ejercicios cargados.</div>
                    </div>
                  {% endif %}

                {% else %}
                  <!-- D√≠a sin rutina: warmup/main/finisher con look PRO -->
                  <div class="pro-panel">
                    {% if plan.warmup %}
                      <div class="panel-block">
                        <div class="panel-title">Warmup</div>
                        <div class="panel-body">{{ plan.warmup }}</div>
                      </div>
                    {% endif %}

                    {% if plan.main %}
                      <div class="panel-block">
                        <div class="panel-title">Entrenamiento</div>
                        <div class="panel-body">{{ plan.main }}</div>
                      </div>
                    {% endif %}

                    {% if plan.finisher %}
                      <div class="panel-block">
                        <div class="panel-title">Finisher</div>
                        <div class="panel-body">{{ plan.finisher }}</div>
                      </div>
                    {% endif %}

                    {% if not plan.warmup and not plan.main and not plan.finisher %}
                      <div class="panel-block">
                        <div class="panel-title">Detalle</div>
                        <div class="panel-body">No hay descripci√≥n cargada para este d√≠a.</div>
                      </div>
                    {% endif %}
                  </div>
                {% endif %}

              </div>
            </div>

          </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- TAB CALENDARIO -->
  <section id="tab-calendario" class="vr-tab">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-info mb-3">Calendario ‚Äî {{ hoy.strftime('%B %Y')|capitalize }}</h5>
      <div class="calendar-grid">
        {% for f in dias_mes %}
          {% set plan_mes = planes_mes.get(f) %}
          {% set tipo_mes = (plan_mes.plan_type|lower) if plan_mes and plan_mes.plan_type else 'descanso' %}
          <div class="calendar-day day-{{ tipo_mes }}">
            <div class="cal-header">
              <span class="cal-day-num">{{ f.day }}</span>
              <span class="cal-weekday">{{ f.strftime('%a')|upper }}</span>
            </div>
            {% if plan_mes %}
              <div class="event-pill event-{{ tipo_mes }}">
                <span class="event-text">{{ (plan_mes.plan_type or 'Descanso')|capitalize }}</span>
              </div>
            {% else %}
              <span class="plan-empty mt-2">Sin plan</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- TAB PROGRESO -->
  <section id="tab-progreso" class="vr-tab">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-light mb-3">Progreso</h5>
      <div class="text-muted">Aqu√≠ luego metemos el gr√°fico (cuando quieras lo enchufamos).</div>
    </div>
  </section>

  <!-- TAB RUTINAS -->
  <section id="tab-rutinas" class="vr-tab">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-light mb-3">Rutinas disponibles</h5>
      <div class="row g-3">
        {% for r in rutinas %}
          <div class="col-md-6 col-lg-4">
            <div class="p-3 rounded" style="background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08);">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>{{ r.nombre }}</strong>
                  {% if r.tipo %}<span class="badge bg-info text-dark ms-2">{{ r.tipo }}</span>{% endif %}
                  {% if r.descripcion %}<div class="small text-muted mt-1">{{ r.descripcion }}</div>{% endif %}
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div class="text-muted">No hay rutinas todav√≠a.</div>
        {% endfor %}
      </div>
    </div>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<style>
/* ====== Semana: look PRO sin romper tu CSS actual ====== */
.day-header { cursor: pointer; }
.day-subrow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-top:8px;
}
.day-chevron{
  font-size: 12px;
  opacity: .75;
  transform: rotate(0deg);
  transition: transform .18s ease, opacity .18s ease;
  user-select:none;
}
.js-day-card.is-open .day-chevron{
  transform: rotate(180deg);
  opacity: 1;
}

.day-details-inner{
  padding-top: 12px;
}

.exercise-card{
  padding: 10px;
  border-radius: 12px;
  margin-bottom: 10px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.08);
}

.pro-panel{
  border-radius: 14px;
  background: rgba(255,255,255,.035);
  border: 1px solid rgba(255,255,255,.09);
  padding: 12px;
}
.panel-block{ margin-bottom: 10px; }
.panel-block:last-child{ margin-bottom: 0; }

.panel-title{
  display:inline-block;
  font-size: 12px;
  font-weight: 700;
  letter-spacing: .4px;
  text-transform: uppercase;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(0,255,255,.10);
  border: 1px solid rgba(0,255,255,.18);
  color: rgba(200,255,255,.95);
  margin-bottom: 6px;
}
.panel-body{
  font-size: 14px;
  line-height: 1.35;
  color: rgba(255,255,255,.92);
  white-space: pre-line;
}

/* Transici√≥n suave al abrir/cerrar */
.day-details{
  transition: max-height .22s ease;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Tabs
  const tabs = document.querySelectorAll(".nav-vr-tabs .nav-link");
  const sections = {
    semana: document.getElementById("tab-semana"),
    calendario: document.getElementById("tab-calendario"),
    progreso: document.getElementById("tab-progreso"),
    rutinas: document.getElementById("tab-rutinas"),
  };

  function activateTab(name) {
    tabs.forEach(btn => btn.classList.toggle("active", btn.dataset.tab === name));
    Object.entries(sections).forEach(([key, sec]) => sec.classList.toggle("active", key === name));
  }

  tabs.forEach(btn => btn.addEventListener("click", () => activateTab(btn.dataset.tab)));
  activateTab("semana");

  // ‚úÖ Toggle PRO con animaci√≥n + chevron
  document.querySelectorAll(".js-day-card").forEach(card => {
    card.addEventListener("click", (e) => {
      if (e.target.closest(".js-no-toggle")) return;

      const targetId = card.getAttribute("data-target");
      if (!targetId) return;
      const panel = document.getElementById(targetId);
      if (!panel) return;

      const isOpen = card.classList.contains("is-open");

      // cerrar
      if (isOpen) {
        card.classList.remove("is-open");
        panel.style.maxHeight = "0px";
        return;
      }

      // abrir
      card.classList.add("is-open");
      // primero reset para medir bien
      panel.style.maxHeight = "0px";
      // siguiente tick: altura real
      requestAnimationFrame(() => {
        panel.style.maxHeight = (panel.scrollHeight + 10) + "px";
      });
    });
  });
});

// Endpoint espera JSON
async function toggleDone(fechaISO, itemId, doneValue, btn) {
  try {
    const res = await fetch("{{ url_for('main.athlete_check_item') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fecha: fechaISO,
        item_id: itemId,
        done: doneValue ? true : false
      })
    });

    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Error");

    if (doneValue) {
      btn.classList.remove("btn-outline-info");
      btn.classList.add("btn-success");
      btn.textContent = "‚úÖ Realizado";
      btn.setAttribute("onclick", `toggleDone('${fechaISO}', ${itemId}, 0, this)`);
    } else {
      btn.classList.remove("btn-success");
      btn.classList.add("btn-outline-info");
      btn.textContent = "Marcar realizado";
      btn.setAttribute("onclick", `toggleDone('${fechaISO}', ${itemId}, 1, this)`);
    }
  } catch (e) {
    alert("No se pudo guardar: " + e.message);
  }
}
</script>
{% endblock %}
