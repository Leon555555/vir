{% extends "layout.html" %}
{% block title %}Perfil de {{ user.nombre }} ‚Äî VR Training{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}

<div class="perfil-container">

  <!-- ====================== -->
  <!-- HEADER DEL ATLETA -->
  <!-- ====================== -->
  <div class="text-center mb-4">
    <img src="{{ url_for('static', filename='logo_blanco_vr_training.png') }}"
         class="perfil-logo"
         alt="VR Training logo">
    <h2 class="perfil-nombre mt-2">{{ user.nombre }}</h2>
    <div class="perfil-sub">
      {{ user.email }} ‚Ä¢ Grupo: {{ user.grupo or '‚Äî' }}
    </div>
  </div>

  <!-- ====================== -->
  <!-- TABS NAV (MyWellness style) -->
  <!-- ====================== -->
  <ul class="nav nav-tabs nav-vr-tabs justify-content-center mb-4" id="perfilTabs">
    <li class="nav-item">
      <button class="nav-link active" data-tab="semana">
        <i class="bi bi-calendar-week me-1"></i> Semana
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-tab="calendario">
        <i class="bi bi-calendar3-range me-1"></i> Calendario
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-tab="progreso">
        <i class="bi bi-graph-up-arrow me-1"></i> Progreso
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" data-tab="comentarios">
        <i class="bi bi-chat-dots me-1"></i> Comentarios
      </button>
    </li>
  </ul>

  <!-- ====================== -->
  <!-- TAB: SEMANA ACTUAL -->
  <!-- ====================== -->
  <section id="tab-semana" class="vr-tab active">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-light mb-3">
        <i class="bi bi-calendar-week text-info me-2"></i>{{ semana_str }}
      </h5>

      <div class="week-grid">
        {% for f in fechas %}
          {% set plan = planes[f] %}
          {% set tipo = (plan.plan_type or 'descanso')|lower %}
          {% set idx = loop.index %}

          <div class="day-card day-{{ tipo }}"
               data-bs-toggle="modal"
               data-bs-target="#modal{{ idx }}">

            <div class="d-flex justify-content-between mb-1">
              <strong>{{ f.strftime('%a')|upper }} {{ f.day }}</strong>
              <span class="badge badge-{{ tipo }}">{{ plan.plan_type|capitalize }}</span>
            </div>

            <div class="small">
              <div><strong>Calentamiento:</strong> {{ plan.warmup or '‚Äî' }}</div>
              <div><strong>Bloque:</strong> {{ plan.main or '‚Äî' }}</div>
              <div><strong>Final:</strong> {{ plan.finisher or '‚Äî' }}</div>
            </div>

            {% if plan.puede_entrenar == 'no' %}
              <div class="badge bg-danger w-100 mt-2">NO puede entrenar</div>
            {% elif plan.puede_entrenar == 'si' %}
              <div class="badge bg-success w-100 mt-2">OK para entrenar</div>
            {% endif %}

            {# ==== BOT√ìN VER RUTINA EN V√çDEO (si el nombre coincide) ==== #}
            {% if plan.main %}
              {% set rutina_match = None %}
              {% for r in rutinas %}
                {% if r.nombre == plan.main %}
                  {% set rutina_match = r %}
                {% endif %}
              {% endfor %}
              {% if rutina_match %}
                <a href="{{ url_for('main.rutina_view', rutina_id=rutina_match.id) }}"
                   class="btn btn-sm btn-outline-info w-100 mt-2"
                   onclick="event.stopPropagation();">
                  üé• Ver rutina en v√≠deo
                </a>
              {% endif %}
            {% endif %}

            {# ==== BOT√ìN REALIZADO (solo atleta due√±o) ==== #}
            {% if current_user.id == user.id %}
              {% if (plan.realizado_score or 0) == 0 %}
                <form method="post"
                      action="{{ url_for('main.marcar_realizado') }}"
                      class="mt-2"
                      onclick="event.stopPropagation();">
                  <input type="hidden" name="user_id" value="{{ user.id }}">
                  <input type="hidden" name="fecha" value="{{ f.strftime('%Y-%m-%d') }}">
                  <button type="submit" class="btn btn-success btn-sm w-100">
                    ‚úÖ Realizado
                  </button>
                </form>
              {% else %}
                <div class="badge bg-success w-100 mt-2">
                  ‚úÖ Entrenamiento realizado
                </div>
              {% endif %}
            {% endif %}

          </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- ====================== -->
  <!-- TAB: CALENDARIO MENSUAL -->
  <!-- ====================== -->
  <section id="tab-calendario" class="vr-tab">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">

      <h5 class="text-info mb-3">
        <i class="bi bi-calendar3-range me-2"></i>
        Calendario mensual ‚Äî {{ hoy.strftime('%B %Y')|capitalize }}
      </h5>

      <div class="calendar-grid">
        {% for f in dias_mes %}
          {% set plan_mes = planes_mes.get(f) %}
          {% set tipo_mes = (plan_mes.plan_type|lower) if plan_mes else 'descanso' %}

          <div class="calendar-day day-{{ tipo_mes }}">
            <div class="cal-header">
              <span class="cal-day-num">{{ f.day }}</span>
              <span class="cal-weekday">{{ f.strftime('%a')|upper }}</span>
            </div>

            {% if plan_mes %}
              <div class="event-pill event-{{ tipo_mes }}">
                <span class="event-icon">
                  {% if tipo_mes == 'fuerza' %}
                    <i class="bi bi-barbell"></i>
                  {% elif tipo_mes == 'pista' %}
                    <i class="bi bi-speedometer2"></i>
                  {% elif tipo_mes == 'bike' %}
                    <i class="bi bi-bicycle"></i>
                  {% elif tipo_mes == 'natacion' %}
                    <i class="bi bi-droplet"></i>
                  {% else %}
                    <i class="bi bi-moon-stars"></i>
                  {% endif %}
                </span>
                <span class="event-text">{{ plan_mes.plan_type|capitalize }}</span>
              </div>

              {% if plan_mes.puede_entrenar %}
                <div class="event-pill {% if plan_mes.puede_entrenar=='no' %}event-state-no{% else %}event-state-ok{% endif %}">
                  <span class="event-text">
                    {% if plan_mes.puede_entrenar == 'no' %}No puede entrenar{% else %}OK para entrenar{% endif %}
                  </span>
                </div>
              {% endif %}

              {% if plan_mes.dificultad %}
                <div class="event-pill event-diff event-diff-{{ plan_mes.dificultad }}">
                  <span class="event-text">
                    {% if plan_mes.dificultad == 'facil' %}F√°cil
                    {% elif plan_mes.dificultad == 'media' %}Media
                    {% elif plan_mes.dificultad == 'dura' %}Dura
                    {% endif %}
                  </span>
                </div>
              {% endif %}

              {% if plan_mes.comentario_atleta %}
                <div class="event-pill event-comment">
                  <span class="event-icon"><i class="bi bi-chat-dots"></i></span>
                  <span class="event-text">Comentario del atleta</span>
                </div>
              {% endif %}
            {% else %}
              <span class="plan-empty mt-2">Sin plan</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- ====================== -->
  <!-- TAB: PROGRESO -->
  <!-- ====================== -->
  <section id="tab-progreso" class="vr-tab">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-light mb-3">
        <i class="bi bi-graph-up-arrow text-info me-2"></i>Propuesto vs Realizado
      </h5>

      <div style="height:240px;">
        <canvas id="graficoProgreso"></canvas>
      </div>
    </div>
  </section>

  <!-- ====================== -->
  <!-- TAB: COMENTARIOS -->
  <!-- ====================== -->
  <section id="tab-comentarios" class="vr-tab">
    <div class="card bg-black border-0 shadow-lg mb-4 p-4">
      <h5 class="text-info mb-3">
        <i class="bi bi-chat-left-text me-2"></i>Comentarios
      </h5>
      <p class="text-secondary">Pr√≥ximamente aqu√≠ podr√°s ver feedback.</p>
    </div>
  </section>

  <!-- ====================== -->
  <!-- RUTINAS (COMPONENTE OPCIONAL) -->
  <!-- ====================== -->
  {# Si tienes componente, lo dejamos #}
  {# {% include "components/rutinas.html" %} #}

</div>

{# Si tienes modales definidos aparte, los puedes seguir incluyendo #}
{# {% include "components/modales.html" %} #}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const tabs = document.querySelectorAll(".nav-vr-tabs .nav-link");
  const sections = {
    semana: document.getElementById("tab-semana"),
    calendario: document.getElementById("tab-calendario"),
    progreso: document.getElementById("tab-progreso"),
    comentarios: document.getElementById("tab-comentarios")
  };

  function activateTab(name) {
    tabs.forEach(btn =>
      btn.classList.toggle("active", btn.dataset.tab === name)
    );
    Object.entries(sections).forEach(([key, sec]) =>
      sec.classList.toggle("active", key === name)
    );
  }

  tabs.forEach(btn =>
    btn.addEventListener("click", () => activateTab(btn.dataset.tab))
  );

  activateTab("semana");
});
</script>
{% endblock %}
