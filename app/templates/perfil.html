{% extends "layout.html" %}
{% block title %}Perfil de {{ user.nombre }}{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root{
    --bg:#0c0e10; --panel:#14171a; --panel2:#1a1f24;
    --txt:#e9ecef; --muted:#9aa4ad; --brand:#e63946; --ok:#2ec4b6;
    --blue:#1976d2; --red:#d7263d; --ring:rgba(230,57,70,.15);
  }
  body{background:var(--bg); color:var(--txt); font-family:"Poppins",system-ui,sans-serif;}
  .wrap{max-width:1100px; margin:24px auto; padding:0 16px;}
  .top{
    display:flex; align-items:center; justify-content:space-between;
    background:linear-gradient(135deg, #171b20 0%, #121417 60%);
    border-radius:18px; padding:22px 28px; box-shadow:0 12px 30px rgba(0,0,0,.35);
    position:relative; overflow:hidden;
  }
  .top::after{
    content:""; position:absolute; right:-60px; top:-60px; width:160px; height:160px;
    background: radial-gradient(closest-side, var(--ring), transparent);
    border-radius:50%;
  }
  .id h2{margin:0 0 6px 0; font-size:28px; font-weight:800;}
  .id small{color:var(--muted)}
  .avatar{font-size:60px; filter:drop-shadow(0 8px 18px rgba(0,0,0,.4))}
  .cards{display:grid; grid-template-columns:1fr 1fr; gap:18px; margin:22px 0;}
  .card{
    border-radius:16px; padding:18px 20px; box-shadow:0 10px 24px rgba(0,0,0,.35);
    background:var(--panel);
  }
  .card.blue{background:linear-gradient(145deg, #0f315a, #0c2749);}
  .card.red{background:linear-gradient(145deg, #5a1117, #3a0b0f);}
  .card h4{margin:0 0 6px 0; font-weight:800}
  .card p, .card small{margin:0; color:#d8dee4}
  .line{height:1px; background:#2a2f34; margin:20px 0}

  /* Calendario horizontal */
  .week{
    background:var(--panel2); border-radius:16px; padding:18px; box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  .week-head{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px}
  .week-title{font-weight:700}
  .btn-month{border:1px solid #3a424a; color:#fff; background:transparent; padding:6px 12px; border-radius:10px}
  .days{display:grid; grid-template-columns:repeat(7,1fr); gap:12px}
  .day{
    background:#101317; border:1px solid #20262c; border-radius:12px; padding:10px; text-align:center;
    position:relative; transition:.2s transform;
  }
  .day:hover{transform:translateY(-2px)}
  .day .dnum{font-size:18px; font-weight:800}
  .day .w{font-size:12px; color:var(--muted)}
  .dot{width:8px; height:8px; border-radius:50%; background:var(--ok); margin:6px auto 0 auto; opacity:.85}
  .day.today{outline:2px solid var(--brand)}
  .btn-mini{margin-top:8px; font-size:12px; padding:2px 8px; border-radius:8px; border:1px solid #2a3036; background:#161b20; color:#fff}
  .btn-mini:hover{background:#1b2228}

  /* Progreso / gr√°fico */
  .chart{
    background:var(--panel2); border-radius:16px; padding:18px; margin-top:18px;
    box-shadow:0 10px 24px rgba(0,0,0,.35);
  }
  .chart h4{margin:0 0 12px 0; font-weight:800}
  .kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:14px; margin-top:14px}
  .kpi{background:#101317; border:1px solid #1f262c; border-radius:12px; padding:12px 14px; text-align:center}
  .kpi h6{margin:0; font-size:12px; color:var(--muted)}
  .kpi p{margin:4px 0 0 0; font-size:20px; font-weight:800; color:var(--brand)}

  /* Sesiones fuerza */
  .strength{background:var(--panel2); border-radius:16px; padding:18px; margin-top:18px; box-shadow:0 10px 24px rgba(0,0,0,.35);}
  .s-item{background:#101317; border:1px solid #1f262c; border-radius:12px; padding:12px 14px; margin-bottom:10px}
  .s-item h6{margin:0 0 4px 0; color:#f5b000; font-weight:700}
  .s-item small{color:var(--muted)}
</style>

<div class="wrap">

  <!-- CABECERA -->
  <div class="top">
    <div class="id">
      <h2>{{ user.nombre }}</h2>
      <small>{{ user.email }} &nbsp;‚Ä¢&nbsp; Grupo: <strong>{{ user.grupo or "‚Äî" }}</strong></small>
    </div>
    <div class="avatar">üèÉ‚Äç‚ôÇÔ∏è</div>
  </div>

  <!-- TARJETAS -->
  <div class="cards">
    <div class="card blue">
      <h4>√öltimo entrenamiento</h4>
      {% if ultima %}
        <p><strong>{{ ultima.tipo }}</strong> ‚Äî {{ ultima.fecha.strftime('%d/%m/%Y') }}</p>
        <small>{{ ultima.descripcion or '‚Äî' }}</small>
      {% else %}
        <p>No hay entrenamientos anteriores.</p>
      {% endif %}
    </div>
    <div class="card red">
      <h4>Pr√≥ximo entrenamiento</h4>
      {% if proxima %}
        <p><strong>{{ proxima.tipo }}</strong> ‚Äî {{ proxima.fecha.strftime('%d/%m/%Y') }}</p>
        <small>{{ proxima.descripcion or '‚Äî' }}</small>
      {% else %}
        <p>No hay pr√≥ximos entrenamientos planificados.</p>
      {% endif %}
    </div>
  </div>

  <!-- CALENDARIO SEMANAL -->
  <div class="week">
    <div class="week-head">
      <div class="week-title">Octubre 2025</div>
      <a class="btn-month" href="{{ user.calendario_url or '#' }}" target="_blank">Ver mes completo</a>
    </div>
    <div class="days">
      {% for d in semana %}
      <div class="day {% if d.hoy %}today{% endif %}">
        <div class="dnum">{{ d.fecha.day }}</div>
        <div class="w">{{ ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"][loop.index0] }}</div>
        {% if d.tiene_sesion %}<div class="dot" title="Sesi√≥n planificada"></div>{% endif %}
        <button class="btn-mini" title="Ver detalles">+</button>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- PROGRESO / GR√ÅFICO -->
  <div class="chart">
    <h4>Tu progreso semanal</h4>
    <canvas id="progressChart" height="80"></canvas>
    <div class="kpis">
      <div class="kpi"><h6>Cumplimiento</h6><p>{{ cumplimiento }}%</p></div>
      <div class="kpi"><h6>Sesiones esta semana</h6><p>{{ semana|selectattr('tiene_sesion')|list|length }}</p></div>
      <div class="kpi"><h6>Siguiente sesi√≥n</h6><p>{{ proxima.fecha.strftime('%d/%m') if proxima else "‚Äî" }}</p></div>
    </div>
  </div>

  <!-- SESIONES DE FUERZA PROPUESTAS -->
  <div class="strength">
    <h4>Sesiones de fuerza propuestas</h4>
    {% set fuerzas = sesiones|selectattr('tipo','equalto','Fuerza')|list %}
    {% if fuerzas %}
      {% for s in fuerzas %}
      <div class="s-item">
        <h6>{{ s.tipo }} ‚Äî {{ s.fecha.strftime('%d/%m/%Y') }}</h6>
        <small>{{ s.descripcion or "Sin notas" }}{% if s.duracion %} ¬∑ {{ s.duracion }} min{% endif %}{% if s.intensidad %} ¬∑ {{ s.intensidad }}{% endif %}</small>
      </div>
      {% endfor %}
    {% else %}
      <div class="s-item"><small>No hay sesiones de fuerza cargadas a√∫n.</small></div>
    {% endif %}
  </div>

  {% if current_user.email == "viru@vir.app" %}
  <div style="margin-top:16px">
    <a class="btn btn-outline-light" href="{{ url_for('main.sesiones_atleta', atleta_id=user.id) }}">‚ûï Gestionar sesiones</a>
  </div>
  {% endif %}

</div>

<script>
  // Gr√°fico de progreso (dummy basado en d√≠as con sesi√≥n)
  const labels = ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"];
  const data = {{ semana|map(attribute='tiene_sesion')|list|tojson }};
  // transformar booleanos a 0/1 * 100
  const series = data.map(x => x ? 100 : 20);
  new Chart(document.getElementById("progressChart"), {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Progreso diario",
        data: series,
        backgroundColor: "rgba(230,57,70,.55)",
        borderColor: "#e63946",
        borderWidth: 1,
        borderRadius: 8
      }]
    },
    options: {
      responsive:true,
      plugins:{ legend:{ display:false }},
      scales:{
        y:{ suggestedMin:0, suggestedMax:100, ticks:{ color:"#cbd5e1" }, grid:{ color:"#26303a" }},
        x:{ ticks:{ color:"#cbd5e1" }, grid:{ display:false }}
      }
    }
  });
</script>
{% endblock %}
