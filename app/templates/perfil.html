{% extends "layout.html" %}
{% block title %}Perfil ‚Äî VR Training{% endblock %}

{% block content %}
<div class="container">

  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h2 class="mb-0 text-light">üë§ {{ user.nombre }}</h2>
      <div class="text-muted">{{ user.email }}</div>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <div class="mini-stat">
        <div class="mini-title">Racha</div>
        <div class="mini-value">üî• {{ streak }}</div>
      </div>
      <div class="mini-stat">
        <div class="mini-title">Semana</div>
        <div class="mini-value">‚úÖ {{ week_done }} / {{ week_goal }}</div>
      </div>
    </div>
  </div>

  <!-- NAV -->
  <div class="card glass p-2 mb-3">
    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-sm {% if view=='today' %}btn-info{% else %}btn-outline-info{% endif %}"
         href="{{ url_for('main.perfil_usuario', user_id=user.id, view='today', center=hoy.isoformat()) }}">Hoy</a>

      <a class="btn btn-sm {% if view=='week' %}btn-info{% else %}btn-outline-info{% endif %}"
         href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=hoy.isoformat()) }}">Semana</a>

      <a class="btn btn-sm {% if view=='month' %}btn-info{% else %}btn-outline-info{% endif %}"
         href="{{ url_for('main.perfil_usuario', user_id=user.id, view='month', center=center.isoformat()) }}">Mes</a>

      <a class="btn btn-sm {% if view=='progress' %}btn-info{% else %}btn-outline-info{% endif %}"
         href="{{ url_for('main.perfil_usuario', user_id=user.id, view='progress', center=center.isoformat()) }}">Progreso</a>
    </div>
  </div>

  {% if view == 'today' %}
    <div class="card glass p-3 mb-4">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="text-muted" style="letter-spacing:.12em;">HOY</div>
          <div class="d-flex align-items-center gap-2">
            <h4 class="mb-0 text-light">{{ hoy.strftime('%A %d/%m')|upper }}</h4>
            <span class="badge bg-secondary">{{ plan_hoy.plan_type }}</span>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-info"
                  onclick="openDayDetail('{{ user.id }}','{{ hoy.isoformat() }}')">
            ‚ñ∂ Empezar
          </button>
          <a class="btn btn-outline-light"
             href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=hoy.isoformat()) }}">
            Ver semana
          </a>
        </div>
      </div>

      <div class="mt-3 text-muted">
        {% if (plan_hoy.plan_type|lower) == 'fuerza' %}
          Hoy toca fuerza. Entr√° y marc√° tus ejercicios ‚úÖ
        {% elif (plan_hoy.plan_type|lower) == 'descanso' %}
          Hoy descanso (si entren√°s igual, pod√©s marcarlo).
        {% else %}
          Hoy toca {{ plan_hoy.plan_type }}. Entr√° y carg√° lo realizado.
        {% endif %}
      </div>
    </div>
  {% endif %}

  {% if view == 'week' %}
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="text-light mb-0">üìÖ Semana ({{ semana_str }})</h5>
    </div>

    <div class="row g-3">
      {% for f in fechas %}
        {% set p = planes[f] %}
        {% set is_done = (f in done_week) %}
        <div class="col-md-6 col-lg-4">
          <div class="card glass p-3">
            <div class="d-flex justify-content-between align-items-center">
              <strong class="text-light">{{ f.strftime('%a %d/%m')|upper }}</strong>
              <div class="d-flex gap-2 align-items-center">
                {% if is_done %}
                  <span class="badge bg-success">HECHO</span>
                {% endif %}
                <span class="badge bg-secondary">{{ p.plan_type }}</span>
              </div>
            </div>

            <div class="mt-3 d-flex gap-2">
              <button class="btn btn-outline-info w-100"
                      onclick="openDayDetail('{{ user.id }}','{{ f.isoformat() }}')">
                Ver / Completar
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if view == 'month' %}
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="text-light mb-0">üóìÔ∏è {{ month_label }}</h5>
    </div>

    <div class="card glass p-3">
      <div class="month-grid">
        <div class="month-head">L</div><div class="month-head">M</div><div class="month-head">X</div>
        <div class="month-head">J</div><div class="month-head">V</div><div class="month-head">S</div><div class="month-head">D</div>

        {% for week in month_grid %}
          {% for d in week %}
            {% if d %}
              {% set p = planes_mes[d] %}
              {% set done = (d in done_month) %}
              <button class="month-cell {% if done %}done{% endif %}"
                      type="button"
                      onclick="openDayDetail('{{ user.id }}','{{ d.isoformat() }}')">
                <div class="daynum">{{ d.day }}</div>
                <div class="ptype">{{ p.plan_type }}</div>
              </button>
            {% else %}
              <div class="month-cell empty"></div>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>
      <div class="text-muted mt-2">Tip: toc√° un d√≠a para ver el entrenamiento y marcarlo ‚úÖ</div>
    </div>
  {% endif %}

  {% if view == 'progress' %}
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="card glass p-3">
          <h5 class="text-light">üìà Progreso semanal</h5>
          <div class="text-muted mb-2">Objetivo: {{ week_goal }} ‚Äî Hechos: {{ week_done }}</div>

          {% set pct = (0 if week_goal == 0 else (week_done * 100 / week_goal)) %}
          <div class="progress" role="progressbar" aria-valuenow="{{ pct|int }}" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width: {{ pct }}%"></div>
          </div>

          <div class="text-muted mt-2">
            {% if week_goal == 0 %}
              Esta semana no hay entrenos planificados todav√≠a.
            {% elif week_done >= week_goal %}
              Brutal. Semana completa ‚úÖüî•
            {% else %}
              Te faltan {{ week_goal - week_done }} para completar la semana.
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card glass p-3">
          <h5 class="text-light">üî• Racha</h5>
          <div class="text-muted">Consecutivos completados: <strong>{{ streak }}</strong></div>
          <div class="mt-3 text-muted">
            Consejo: aunque sea un entreno corto, marc√° ‚ÄúHoy entren√©‚Äù para sostener h√°bito.
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card glass p-3">
          <h5 class="text-light">üóìÔ∏è D√≠as completados del mes</h5>
          <div class="text-muted">Completados: <strong>{{ done_month|length }}</strong> d√≠as</div>
          <div class="mt-2">
            <a class="btn btn-outline-info" href="{{ url_for('main.perfil_usuario', user_id=user.id, view='month', center=center.isoformat()) }}">
              Ver calendario del mes
            </a>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

</div>

<!-- MODAL -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content" style="background:#070a0c;color:#fff;">
      <div class="modal-header" style="border-color:rgba(255,255,255,.08)">
        <div>
          <h5 class="modal-title mb-0" id="dayTitle">Detalle</h5>
          <div class="text-muted" id="daySubtitle"></div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="dayBody" class="container"></div>
      </div>
    </div>
  </div>
</div>

<style>
.glass{
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 16px;
}
.mini-stat{
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  padding: 10px 12px;
  min-width: 110px;
}
.mini-title{font-size:.78rem;color:rgba(255,255,255,.65);letter-spacing:.12em;text-transform:uppercase}
.mini-value{font-size:1.1rem;font-weight:700}

.item-row{
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px;
  padding:12px;
  background: rgba(255,255,255,.02);
}
textarea.form-control{
  background: rgba(0,0,0,.20);
  border: 1px solid rgba(255,255,255,.10);
  color:#fff;
}

.month-grid{
  display:grid;
  grid-template-columns: repeat(7, 1fr);
  gap:10px;
}
.month-head{
  color:rgba(255,255,255,.65);
  text-align:center;
  font-weight:700;
  letter-spacing:.12em;
}
.month-cell{
  border:1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.02);
  border-radius:14px;
  padding:10px;
  min-height:72px;
  color:#fff;
  text-align:left;
  cursor:pointer;
  transition: .15s ease;
}
.month-cell:hover{ transform: translateY(-1px); border-color: rgba(34,211,238,.35); }
.month-cell.done{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); }
.month-cell.empty{ border:1px dashed rgba(255,255,255,.06); background: transparent; min-height:72px; border-radius:14px; }
.daynum{ font-weight:800; }
.ptype{ font-size:.78rem; color: rgba(255,255,255,.65); margin-top:2px; }
</style>
{% endblock %}

{% block extra_js %}
<script>
let dayModal;

function esc(s){ return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

async function openDayDetail(userId, fecha){
  if (!dayModal) dayModal = new bootstrap.Modal(document.getElementById("dayModal"));
  document.getElementById("dayTitle").textContent = "Cargando‚Ä¶";
  document.getElementById("daySubtitle").textContent = fecha;
  document.getElementById("dayBody").innerHTML = "<div class='text-muted'>Cargando plan‚Ä¶</div>";
  dayModal.show();

  const res = await fetch(`/api/day_detail?user_id=${userId}&fecha=${fecha}`);
  const data = await res.json();
  if (!data.ok){
    document.getElementById("dayTitle").textContent = "Error";
    document.getElementById("dayBody").innerHTML = `<div class="alert alert-danger">${esc(data.error)}</div>`;
    return;
  }

  const plan = data.plan;
  const tipo = (plan.plan_type || "Descanso");
  document.getElementById("dayTitle").textContent = `üìå ${tipo}`;
  document.getElementById("daySubtitle").textContent = data.fecha;

  if ((tipo||"").toLowerCase() === "fuerza" && data.rutina){
    renderFuerza(userId, data.fecha, data);
  } else {
    renderEndurance(userId, data.fecha, data);
  }
}

function renderFuerza(userId, fecha, data){
  const r = data.rutina;
  const items = data.items || [];
  const checks = new Set(data.checks || []);

  let html = `
    <div class="mb-3">
      <h4 class="text-light mb-1">üèãÔ∏è ${esc(r.nombre)}</h4>
      ${r.descripcion ? `<div class="text-muted">${esc(r.descripcion)}</div>` : ""}
    </div>
    <div class="row g-3">
  `;

  items.forEach(it=>{
    const checked = checks.has(it.id) ? "checked" : "";
    const video = it.video_url ? `
      <video class="w-100 rounded mb-2" controls preload="metadata" style="max-height:420px;">
        <source src="/static/${esc(it.video_url)}" type="video/mp4">
      </video>` : "";

    html += `
      <div class="col-lg-6">
        <div class="item-row">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong class="text-light">${esc(it.nombre)}</strong>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox"
                     ${checked}
                     onchange="toggleCheck(${userId},'${fecha}',${it.id}, this.checked)">
              <label class="form-check-label text-muted">Hecho</label>
            </div>
          </div>

          <div class="text-muted mb-2">
            ${esc(it.series)} ¬∑ ${esc(it.reps)} ¬∑ Desc ${esc(it.descanso)}
          </div>

          ${it.nota ? `<div class="text-muted mb-2">üìù ${esc(it.nota)}</div>` : ""}

          ${video}
        </div>
      </div>
    `;
  });

  html += `</div>
    <hr style="border-color:rgba(255,255,255,.08)" />
    <div class="d-flex gap-2 align-items-center flex-wrap">
      <button class="btn btn-success" onclick="markDidTrain(${userId},'${fecha}', true)">‚úÖ Marcar entreno completado</button>
      <button class="btn btn-outline-light" onclick="markDidTrain(${userId},'${fecha}', false)">‚Ü© Quitar marca</button>
      <span class="text-muted">Esto alimenta racha y progreso.</span>
    </div>
  `;

  document.getElementById("dayBody").innerHTML = html;
}

function renderEndurance(userId, fecha, data){
  const log = data.log || {};
  const plan = data.plan || {};
  const warm = plan.warmup || "";
  const main = plan.main || "";
  const fin = plan.finisher || "";

  let html = `
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="item-row">
          <h5 class="text-light">Plan</h5>
          <div class="text-muted mb-2"><strong>Activaci√≥n:</strong><br>${esc(warm).replaceAll("\n","<br>")}</div>
          <div class="text-muted mb-2"><strong>Bloque principal:</strong><br>${esc(main).replaceAll("\n","<br>")}</div>
          <div class="text-muted"><strong>Enfriamiento:</strong><br>${esc(fin).replaceAll("\n","<br>")}</div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="item-row">
          <h5 class="text-light">Lo realizado</h5>

          <div class="form-check form-switch mb-2">
            <input class="form-check-input" type="checkbox" id="didTrain" ${log.did_train ? "checked":""}>
            <label class="form-check-label text-muted">Hoy entren√©</label>
          </div>

          <label class="text-muted">Activaci√≥n realizada</label>
          <textarea id="warmup_done" class="form-control mb-2" rows="2">${esc(log.warmup_done||"")}</textarea>

          <label class="text-muted">Bloque principal realizado</label>
          <textarea id="main_done" class="form-control mb-2" rows="3">${esc(log.main_done||"")}</textarea>

          <label class="text-muted">Enfriamiento realizado</label>
          <textarea id="finisher_done" class="form-control mb-2" rows="2">${esc(log.finisher_done||"")}</textarea>

          <button class="btn btn-primary w-100" onclick="saveLog(${userId},'${fecha}')">üíæ Guardar</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById("dayBody").innerHTML = html;
}

async function toggleCheck(userId, fecha, itemId, checked){
  const fd = new FormData();
  fd.append("user_id", userId);
  fd.append("fecha", fecha);
  fd.append("item_id", itemId);
  fd.append("done", checked ? "1" : "0");

  const res = await fetch("/athlete/check_item", { method:"POST", body: fd });
  const data = await res.json();
  if (!data.ok) alert(data.error || "Error guardando check");
}

async function saveLog(userId, fecha){
  const payload = {
    user_id: userId,
    fecha: fecha,
    did_train: document.getElementById("didTrain")?.checked || false,
    warmup_done: document.getElementById("warmup_done")?.value || "",
    main_done: document.getElementById("main_done")?.value || "",
    finisher_done: document.getElementById("finisher_done")?.value || "",
  };

  const res = await fetch("/athlete/save_log", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (!data.ok) alert(data.error || "Error guardando");
  else alert("‚úÖ Guardado");
}

async function markDidTrain(userId, fecha, didTrain){
  const payload = {
    user_id: userId,
    fecha: fecha,
    did_train: !!didTrain,
    warmup_done: "",
    main_done: "",
    finisher_done: "",
  };

  const res = await fetch("/athlete/save_log", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if (!data.ok) alert(data.error || "Error guardando");
  else alert("‚úÖ Marcado");
}
</script>
{% endblock %}
