{% extends "layout.html" %}
{% block title %}Perfil ‚Äî VR Training{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0 text-strong">üë§ {{ user.nombre }}</h2>
      <div class="text-soft">{{ user.email }}</div>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <div class="mini-stat">
        <div class="mini-title">Racha</div>
        <div class="mini-value">üî• {{ streak or 0 }}</div>
      </div>
      <div class="mini-stat">
        <div class="mini-title">Semana</div>
        <div class="mini-value">‚úÖ {{ week_done }}/{{ week_goal }}</div>
      </div>
    </div>
  </div>

  <!-- NAV (server-side por ?view=...) -->
  <div class="d-flex gap-2 flex-wrap mb-3">
    <a class="btn {% if view=='today' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='today', center=center.isoformat()) }}">
      ‚ñ∂ Hoy
    </a>

    <a class="btn {% if view=='week' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=center.isoformat()) }}">
      üìÖ Semana
    </a>

    <a class="btn {% if view=='month' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='month', center=center.isoformat()) }}">
      üóì Mes
    </a>

    <a class="btn {% if view=='progress' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='progress', center=center.isoformat()) }}">
      üìà Progreso
    </a>
  </div>

  <!-- =========================
       HOY
  ========================== -->
  {% if view == 'today' %}
  <div class="card glass p-3">
    <div class="d-flex justify-content-between align-items-start gap-3 flex-wrap">
      <div>
        <div class="text-soft text-uppercase" style="letter-spacing:.14em;font-weight:800;">Hoy</div>
        <div class="text-strong" style="font-size:1.35rem;">
          {{ hoy.strftime('%A %d/%m')|upper }}
          <span class="badge bg-secondary ms-2">{{ plan_hoy.plan_type or 'Descanso' }}</span>
        </div>

        <div class="mt-2 text-soft">
          {% if (plan_hoy.plan_type or '').lower() == 'descanso' %}
            Hoy es descanso / recuperaci√≥n. Si quer√©s, mir√° tu semana para planear el siguiente d√≠a.
          {% else %}
            Ten√©s plan listo. Entr√° a ‚ÄúEmpezar‚Äù y marc√° lo realizado ‚úÖ
          {% endif %}
        </div>
      </div>

      <div class="d-flex gap-2">
        <button class="btn btn-info" type="button" onclick="openDay('{{ hoy.isoformat() }}')">‚ñ∂ Empezar</button>
        <a class="btn btn-outline-light"
           href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=center.isoformat()) }}">
          Ver semana
        </a>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- =========================
       SEMANA
  ========================== -->
  {% if view == 'week' %}
  <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
    <div>
      <h5 class="section-title mb-0">Semana {{ semana_str }}</h5>
      <div class="text-soft">Toc√° un d√≠a para ver detalle y videos.</div>
    </div>

    <form method="GET" class="d-flex gap-2">
      <input type="hidden" name="view" value="week">
      <input class="form-control" type="date" name="center" value="{{ center.isoformat() }}">
      <button class="btn btn-outline-info" type="submit">Cambiar</button>
    </form>
  </div>

  <div class="row g-3">
    {% for f in fechas %}
      {% set p = planes.get(f) %}
      <div class="col-md-6 col-lg-4">
        <div class="card glass p-3 lift">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <div class="text-soft text-uppercase" style="letter-spacing:.12em;font-weight:900;">
                {{ f.strftime('%a') }}
              </div>
              <div class="text-strong" style="font-size:1.15rem;">
                {{ f.strftime('%d/%m') }}
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-secondary">{{ (p.plan_type if p else '‚Äî') }}</span>
              {% if f in done_week %}
                <span class="badge bg-success">HECHO</span>
              {% endif %}
            </div>
          </div>

          <div class="text-soft" style="min-height:46px;">
            {% if not p or (p.plan_type or '').lower() == 'descanso' %}
              Descanso / movilidad / recuperaci√≥n.
            {% else %}
              {% if (p.plan_type or '').lower() == 'fuerza' %}
                {% if p.main and p.main.startswith('RUTINA:') %}
                  Rutina asignada (con videos).
                {% else %}
                  Fuerza (sin rutina asignada).
                {% endif %}
              {% else %}
                {{ (p.main or p.warmup or 'Plan listo') }}
              {% endif %}
            {% endif %}
          </div>

          <div class="d-grid mt-2">
            <button class="btn btn-outline-info" type="button" onclick="openDay('{{ f.isoformat() }}')">
              Ver detalle
            </button>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- =========================
       MES
  ========================== -->
  {% if view == 'month' %}
  <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
    <div>
      <h5 class="section-title mb-0">Mes {{ month_label }}</h5>
      <div class="text-soft">Toc√° un d√≠a para ver detalle.</div>
    </div>

    <form method="GET" class="d-flex gap-2">
      <input type="hidden" name="view" value="month">
      <input class="form-control" type="month" name="center" value="{{ center.strftime('%Y-%m') }}">
      <button class="btn btn-outline-info" type="submit">Ir</button>
    </form>
  </div>

  <div class="month-grid">
    <div class="month-head">L</div><div class="month-head">M</div><div class="month-head">X</div>
    <div class="month-head">J</div><div class="month-head">V</div><div class="month-head">S</div><div class="month-head">D</div>

    {% for week in month_grid %}
      {% for d in week %}
        {% if d %}
          {% set p = planes_mes.get(d) %}
          <div class="month-cell {% if d in done_month %}done{% endif %}" onclick="openDay('{{ d.isoformat() }}')">
            <div class="daynum">{{ d.day }}</div>
            <div class="ptype">{{ (p.plan_type if p else '‚Äî') }}</div>
          </div>
        {% else %}
          <div class="month-cell empty"></div>
        {% endif %}
      {% endfor %}
    {% endfor %}
  </div>
  {% endif %}

  <!-- =========================
       PROGRESO
  ========================== -->
  {% if view == 'progress' %}
  <h5 class="section-title">Progreso</h5>

  <div class="card glass p-3">
    <div class="text-soft mb-2">
      Objetivo semanal: <span class="text-strong">{{ week_goal }}</span> d√≠as ¬∑ Hechos: <span class="text-strong">{{ week_done }}</span>
    </div>

    {% set pct = 0 %}
    {% if week_goal and week_goal > 0 %}
      {% set pct = (week_done * 100) // week_goal %}
    {% endif %}

    <div class="progress mb-2">
      <div class="progress-bar" role="progressbar" style="width: {{ pct }}%"></div>
    </div>

    <div class="text-soft">
      Meta: completar la semana para subir de nivel üèÜ (esto engancha MUCHO cuando sumemos medallas).
    </div>
  </div>
  {% endif %}

</div>

<!-- =========================
     MODAL (detalle)
========================= -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modal-dark">
      <div class="modal-header">
        <h5 class="modal-title text-strong" id="dayTitle">Detalle</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <div class="row g-3">
          <div class="col-md-6">
            <div class="card glass p-3">
              <h5 class="section-title">Plan</h5>

              <div class="field-title">Activaci√≥n</div>
              <div class="field-value" id="planWarmup">‚Äî</div>

              <div class="field-title mt-3">Bloque principal</div>
              <div class="field-value" id="planMain">‚Äî</div>

              <div class="field-title mt-3">Enfriamiento</div>
              <div class="field-value" id="planFinisher">‚Äî</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card glass p-3">
              <h5 class="section-title">Lo realizado</h5>

              <label class="switch-hecho mb-2">
                <input id="didTrain" type="checkbox">
                <span>Hoy entren√©</span>
              </label>

              <div class="text-soft mb-1">Activaci√≥n realizado</div>
              <textarea id="warmupDone" class="form-control mb-2" rows="2" placeholder="Qu√© hiciste..."></textarea>

              <div class="text-soft mb-1">Bloque principal realizado</div>
              <textarea id="mainDone" class="form-control mb-2" rows="2" placeholder="Qu√© hiciste..."></textarea>

              <div class="text-soft mb-1">Enfriamiento realizado</div>
              <textarea id="finisherDone" class="form-control mb-2" rows="2" placeholder="Qu√© hiciste..."></textarea>

              <button class="btn btn-primary w-100" type="button" onclick="saveLog()">üíæ Guardar</button>
            </div>
          </div>
        </div>

        <div id="strengthBox" class="mt-3" style="display:none;">
          <h5 class="section-title">Fuerza (videos)</h5>
          <div id="strengthItems"></div>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentUserId = {{ user.id }};
let currentFecha = null;

async function openDay(fecha){
  currentFecha = fecha;

  const res = await fetch(`/api/day_detail?user_id=${currentUserId}&fecha=${fecha}`);
  const data = await res.json();
  if(!data.ok){ alert(data.error || "Error"); return; }

  const p = data.plan;

  document.getElementById("dayTitle").innerText = `${p.plan_type} ¬∑ ${fecha}`;
  document.getElementById("planWarmup").innerText = p.warmup || "‚Äî";
  document.getElementById("planMain").innerText = p.main || "‚Äî";
  document.getElementById("planFinisher").innerText = p.finisher || "‚Äî";

  document.getElementById("didTrain").checked = !!data.log?.did_train;
  document.getElementById("warmupDone").value = data.log?.warmup_done || "";
  document.getElementById("mainDone").value = data.log?.main_done || "";
  document.getElementById("finisherDone").value = data.log?.finisher_done || "";

  const strengthBox = document.getElementById("strengthBox");
  const strengthItems = document.getElementById("strengthItems");
  strengthItems.innerHTML = "";

  const isFuerza = (p.plan_type || "").toLowerCase() === "fuerza";
  if(isFuerza && data.items && data.items.length){
    strengthBox.style.display = "";
    const doneSet = new Set(data.checks || []);

    data.items.forEach(it=>{
      const row = document.createElement("div");
      row.className = "item-row mb-2";

      row.innerHTML = `
        <div class="d-flex justify-content-between align-items-center gap-2">
          <div style="min-width:0;">
            <div class="text-strong" style="font-size:1.05rem;">${it.nombre}</div>
            <div class="text-soft">${it.series || ""} ${it.reps || ""} ${it.descanso ? (" ¬∑ Desc " + it.descanso) : ""}</div>
          </div>
          <label class="switch-hecho">
            <input type="checkbox" ${doneSet.has(it.id) ? "checked" : ""} onchange="toggleItem(${it.id}, this.checked)">
            <span>Hecho</span>
          </label>
        </div>

        ${it.video_url ? `
          <div class="mt-2">
            <video class="w-100" controls preload="metadata">
              <source src="/static/${it.video_url}" type="video/mp4">
            </video>
          </div>` : ""}

        ${it.nota ? `<div class="text-soft mt-2">${it.nota}</div>` : ""}
      `;

      strengthItems.appendChild(row);
    });

  } else {
    strengthBox.style.display = "none";
  }

  const modal = new bootstrap.Modal(document.getElementById("dayModal"));
  modal.show();
}

async function saveLog(){
  if(!currentFecha) return;

  const payload = {
    user_id: currentUserId,
    fecha: currentFecha,
    did_train: document.getElementById("didTrain").checked,
    warmup_done: document.getElementById("warmupDone").value,
    main_done: document.getElementById("mainDone").value,
    finisher_done: document.getElementById("finisherDone").value
  };

  const res = await fetch("/athlete/save_log", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if(!data.ok){ alert(data.error || "Error guardando"); return; }
  alert("‚úÖ Guardado");
}

async function toggleItem(itemId, checked){
  if(!currentFecha) return;

  const form = new FormData();
  form.append("user_id", currentUserId);
  form.append("fecha", currentFecha);
  form.append("item_id", itemId);
  form.append("done", checked ? "1" : "0");

  const res = await fetch("/athlete/check_item", { method:"POST", body: form });
  const data = await res.json();
  if(!data.ok){ alert(data.error || "Error"); }
}
</script>
{% endblock %}
