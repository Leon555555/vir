{% extends "layout.html" %}
{% block title %}Perfil de {{ user.nombre }} â€” VR Training{% endblock %}

{% block content %}

<!-- ENCABEZADO -->
<div class="text-center mb-5">
  <img src="{{ url_for('static', filename='logo_blanco_vr_training.png') }}" alt="VR"
       style="height:70px;filter:drop-shadow(0 0 15px #22d3ee);">
  <h2 class="fw-bold mt-2 text-light">{{ user.nombre }}</h2>
  <div class="text-secondary">{{ user.email }} â€¢ Grupo: {{ user.grupo or 'â€”' }}</div>
</div>

<!-- ÃšLTIMO / PRÃ“XIMO -->
<div class="row mb-4 text-center g-3">
  <div class="col-md-6">
    <div class="card text-light border-0 shadow-lg"
         style="background: radial-gradient(circle at top left, #002233, #000); box-shadow:0 0 20px rgba(34,211,238,0.2);">
      <div class="card-body">
        <h5 class="card-title text-info"><i class="bi bi-activity me-2"></i>Ãšltimo entrenamiento</h5>
        <p class="small text-secondary mb-0">No hay entrenamientos anteriores.</p>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card text-light border-0 shadow-lg"
         style="background: radial-gradient(circle at top right, #330000, #000); box-shadow:0 0 20px rgba(239,68,68,0.25);">
      <div class="card-body">
        <h5 class="card-title text-danger"><i class="bi bi-lightning-charge me-2"></i>PrÃ³ximo entrenamiento</h5>
        <p class="small text-secondary mb-0">No hay prÃ³ximos entrenamientos planificados.</p>
      </div>
    </div>
  </div>
</div>

<!-- SEMANA ACTUAL -->
<div class="card bg-black border-0 shadow-lg mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0 text-light"><i class="bi bi-calendar-week text-info me-2"></i>{{ semana_str }}</h5>
      <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="collapse" data-bs-target="#mesCompleto">
        <i class="bi bi-calendar3-range me-1"></i>Ver mes completo
      </button>
    </div>

    <div class="week-grid">
      {% for f in fechas %}
      <div class="day-card text-light p-3 rounded shadow-sm"
           data-bs-toggle="modal" data-bs-target="#modalDia{{ loop.index }}"
           style="cursor:pointer; transition:transform .2s ease;">
        {% set tipo = planes[f].plan_type|lower %}
        {% if tipo == "fuerza" %}
          <img src="{{ url_for('static', filename='icons/fuerza.png') }}" class="icono-dia" alt="Fuerza">
        {% elif tipo in ["pista", "running", "run"] %}
          <img src="{{ url_for('static', filename='icons/pista.png') }}" class="icono-dia" alt="Pista">
        {% elif tipo == "bike" %}
          <img src="{{ url_for('static', filename='icons/bike.png') }}" class="icono-dia" alt="Bike">
        {% elif tipo == "natacion" %}
          <img src="{{ url_for('static', filename='icons/natacion.png') }}" class="icono-dia" alt="NataciÃ³n">
        {% endif %}
        <div class="d-flex justify-content-between align-items-center mb-2 mt-1">
          <strong>{{ f.strftime('%a')|capitalize }}</strong>
          <span class="badge bg-info text-dark">{{ planes[f].plan_type|capitalize }}</span>
        </div>
        <div class="small bg-dark rounded p-2 border border-secondary">
          <div><strong>Calentamiento:</strong> {{ planes[f].warmup or 'â€”' }}</div>
          <div><strong>Entrenamiento:</strong> {{ planes[f].main or 'â€”' }}</div>
          <div><strong>Bloque final:</strong> {{ planes[f].finisher or 'â€”' }}</div>
        </div>
      </div>

      <!-- MODAL DÃA -->
      <div class="modal fade" id="modalDia{{ loop.index }}" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div class="modal-content bg-dark text-light border border-info">
            <div class="modal-header border-info">
              <h5 class="modal-title text-info fw-bold">
                {{ f.strftime('%A %d/%m')|capitalize }}
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form action="{{ url_for('main.save_day') }}" method="POST">
                <input type="hidden" name="user_id" value="{{ user.id }}">
                <input type="hidden" name="fecha" value="{{ f.isoformat() }}">
                <textarea name="main" class="form-control bg-black text-light mb-3" rows="5">{{ planes[f].main or '' }}</textarea>
                <button class="btn btn-info w-100 fw-bold">Guardar</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- GRÃFICO -->
<div class="card bg-black border-0 shadow-lg mb-5">
  <div class="card-body">
    <h5 class="mb-3 text-light"><i class="bi bi-graph-up-arrow text-info me-2"></i>Propuesto vs Realizado</h5>
    <canvas id="graficoProgreso"></canvas>
  </div>
</div>

<!-- ===================================================== -->
<!-- ðŸ“… NUEVO: CALENDARIO MENSUAL CON DRAG & DROP -->
<!-- ===================================================== -->
<div class="row mb-5">
  <div class="col-md-3">
    <div class="card bg-dark border-0 shadow p-3">
      <h5 class="text-info mb-3"><i class="bi bi-collection me-2"></i>Rutinas disponibles</h5>
      {% for r in rutinas %}
      <div class="bloque-entrenamiento mb-2 text-light p-2 rounded"
           draggable="true"
           ondragstart="drag(event)"
           data-id="{{ r.id }}"
           data-tipo="{{ r.tipo or 'fuerza' }}"
           data-nombre="{{ r.nombre }}"
           style="cursor:grab;">
        <strong>{{ r.nombre }}</strong><br>
        <small class="text-secondary">{{ r.tipo|capitalize }}</small>
      </div>
      {% else %}
      <p class="text-secondary small">No hay rutinas creadas aÃºn.</p>
      {% endfor %}
    </div>
  </div>

  <div class="col-md-9">
    <div class="card bg-black border-0 shadow-lg p-3">
      <h5 class="text-info mb-3"><i class="bi bi-calendar-week me-2"></i>Calendario mensual de {{ user.nombre }}</h5>
      <div id="calendar" class="calendar-grid">
        {% for d in range(1,32) %}
        <div class="calendar-day"
             ondrop="drop(event)"
             ondragover="allowDrop(event)"
             data-date="{{ hoy.year }}-{{ hoy.month }}-{{ '%02d' % d }}">
          <div class="date-number text-secondary">{{ d }}</div>
          <div class="day-content" id="day-{{ hoy.year }}-{{ hoy.month }}-{{ '%02d' % d }}"></div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- RUTINAS -->
<div class="card bg-black border-0 shadow-lg mb-5">
  <div class="card-body">{% include 'partials/rutinas.html' %}</div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const userId = {{ user.id }};
function allowDrop(ev) { ev.preventDefault(); }
function drag(ev) {
  ev.dataTransfer.setData("id", ev.target.dataset.id);
  ev.dataTransfer.setData("tipo", (ev.target.dataset.tipo || "").toLowerCase());
  ev.dataTransfer.setData("nombre", ev.target.dataset.nombre);
}
function drop(ev) {
  ev.preventDefault();
  const rutina_id = ev.dataTransfer.getData("id");
  const tipo = ev.dataTransfer.getData("tipo");
  const nombre = ev.dataTransfer.getData("nombre");
  const fecha = ev.currentTarget.dataset.date;
  asignarBloque(userId, rutina_id, fecha);
  agregarVisualDia(fecha, tipo, nombre);
}
function asignarBloque(user_id, rutina_id, fecha) {
  fetch("{{ url_for('main.asignar_bloque') }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ user_id, rutina_id, fecha })
  })
  .then(r => r.json())
  .then(res => console.log(res.msg || res.status))
  .catch(e => console.error(e));
}
function agregarVisualDia(fecha, tipo, nombre) {
  const cont = document.getElementById("day-" + fecha);
  if (!cont) return;
  const iconos = {
    "fuerza": "{{ url_for('static', filename='icons/fuerza.png') }}",
    "bike": "{{ url_for('static', filename='icons/bike.png') }}",
    "pista": "{{ url_for('static', filename='icons/pista.png') }}",
    "natacion": "{{ url_for('static', filename='icons/natacion.png') }}"
  };
  const icon = iconos[tipo] || "";
  const div = document.createElement("div");
  div.classList.add("rutina-asignada");
  if (tipo) div.classList.add("tipo-" + tipo);
  div.innerHTML = icon ? `<img src="${icon}" alt="${tipo}" height="20"><span>${nombre}</span>` : `<span>${nombre}</span>`;
  cont.appendChild(div);
}
</script>

<script>
const ctx = document.getElementById("graficoProgreso").getContext("2d");
new Chart(ctx, {
  type: "line",
  data: {
    labels: {{ labels|tojson }},
    datasets: [
      { label: "Propuesto", data: {{ propuesto|tojson }}, borderColor: "#22d3ee", tension: 0.3, fill: false, borderWidth: 2 },
      { label: "Realizado", data: {{ realizado|tojson }}, borderColor: "#00bfff", tension: 0.3, fill: false, borderWidth: 2 }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { labels: { color: "#ccc" } } },
    scales: { x: { ticks: { color: "#aaa" } }, y: { min: 0, ticks: { color: "#aaa" } } }
  }
});
</script>

<style>
.calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.calendar-day { border:1px solid rgba(34,211,238,0.2); min-height:160px; background:#050608; border-radius:8px; padding:6px; position:relative; }
.date-number { position:absolute; top:4px; right:6px; font-size:0.9rem; }
.day-content { margin-top:18px; }
.rutina-asignada { background:rgba(10,10,10,0.9); border-radius:6px; padding:4px 6px; margin-bottom:4px; font-size:0.8rem; display:flex; align-items:center; gap:6px; border-left:4px solid rgba(255,255,255,0.3); }
.rutina-asignada.tipo-fuerza { border-left-color:gold; }
.rutina-asignada.tipo-bike { border-left-color:#22c55e; }
.rutina-asignada.tipo-pista { border-left-color:#ef4444; }
.rutina-asignada.tipo-natacion { border-left-color:#3b82f6; }
.bloque-entrenamiento { background:rgba(15,23,42,0.8); border-radius:8px; border-left:4px solid rgba(34,211,238,0.6); }
.bloque-entrenamiento:hover { transform:translateY(-2px); box-shadow:0 0 12px rgba(34,211,238,0.5); }
</style>
{% endblock %}
