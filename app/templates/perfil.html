{% extends "layout.html" %}
{% block title %}Perfil â€” VR Training{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-3">
      <div class="vr-avatar">
        <i class="bi bi-person-fill text-info"></i>
      </div>

      <div>
        <h2 class="text-light mb-0">{{ user.nombre }}</h2>
        <div class="text-muted">{{ user.email }}</div>

        <div class="mt-2">
          {% if strava_account %}
            <span class="badge bg-success">ðŸŸ  Strava conectado</span>
          {% else %}
            <a href="{{ url_for('strava.connect') }}" class="btn btn-sm btn-outline-warning">
              ðŸ”— Conectar con Strava
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="d-flex gap-2 align-items-center flex-wrap">
      {% if admin_ok %}
        <a class="btn btn-outline-info" href="{{ url_for('main.coach_planificador', user_id=user.id) }}">
          <i class="bi bi-calendar3"></i> Planificar
        </a>
      {% endif %}
      <a class="btn btn-outline-light" href="{{ url_for('main.perfil_redirect') }}">
        <i class="bi bi-arrow-left"></i> Volver
      </a>

      <div class="mini-stat">
        <div class="mini-title">RACHA</div>
        <div class="mini-value">ðŸ”¥ {{ streak }}</div>
      </div>
      <div class="mini-stat">
        <div class="mini-title">SEMANA</div>
        <div class="mini-value">âœ… {{ week_done }} / {{ week_goal }}</div>
        <div class="progress mt-2">
          {% set pct = 0 if week_goal==0 else (week_done*100//week_goal) %}
          <div class="progress-bar" style="width: {{ pct }}%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="d-flex gap-2 flex-wrap mb-3">
    <a class="btn btn-sm {% if view=='today' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='today') }}">Hoy</a>

    <a class="btn btn-sm {% if view=='week' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=center.isoformat()) }}">Semana</a>

    <a class="btn btn-sm {% if view=='month' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='month', center=center.isoformat()) }}">Mes</a>

    <a class="btn btn-sm {% if view=='progress' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='progress', center=center.isoformat()) }}">Progreso</a>
  </div>

  {% if view == 'today' %}
    <div class="card glass p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <div>
          <div class="text-muted vr-kicker" style="letter-spacing:.18em;text-transform:uppercase;">HOY</div>
          <div class="d-flex align-items-center gap-2">
            <div class="fs-4 fw-bold">{{ hoy.strftime('%A %d/%m')|upper }}</div>
            <span class="badge bg-secondary">{{ plan_hoy.plan_type }}</span>
          </div>
          <div class="text-muted mt-1">EntrÃ¡ y marcÃ¡ lo que hiciste.</div>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-info" type="button" onclick="openDay('{{ hoy.isoformat() }}')">
            â–¶ Empezar
          </button>

          <a class="btn btn-outline-light"
             href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=hoy.isoformat()) }}">
            Ver semana
          </a>
        </div>
      </div>
    </div>
  {% endif %}

  {% if view == 'week' %}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h4 class="text-light mb-0">Semana</h4>
        <div class="text-muted">{{ semana_str }}</div>
      </div>

      <form method="GET" class="d-flex gap-2">
        <input type="hidden" name="view" value="week">
        <input type="date" class="form-control" name="center" value="{{ center.isoformat() }}">
        <button class="btn btn-outline-info" type="submit">Ir</button>
      </form>
    </div>

    <div class="row g-3">
      {% for f in fechas %}
        {% set p = planes[f] %}
        {% set done = (f in done_week) %}
        <div class="col-md-6 col-lg-4">
          <div class="card glass p-3 lift">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold" style="letter-spacing:.08em;">{{ f.strftime('%a %d/%m')|upper }}</div>
              <span class="badge {% if done %}bg-success{% else %}bg-secondary{% endif %}">
                {% if done %}HECHO{% else %}{{ p.plan_type }}{% endif %}
              </span>
            </div>

            <div class="text-muted" style="font-size:.95rem;">
              {% if (p.plan_type or '').lower() == 'descanso' %}
                Descanso / recuperaciÃ³n.
              {% else %}
                {{ p.warmup or 'â€”' }}
              {% endif %}
            </div>

            <div class="d-grid mt-3">
              <button class="btn btn-outline-info" type="button" onclick="openDay('{{ f.isoformat() }}')">
                Ver detalle
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if view == 'month' %}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h4 class="text-light mb-0">Mes</h4>
        <div class="text-muted">{{ month_label }}</div>
      </div>

      <form method="GET" class="d-flex gap-2">
        <input type="hidden" name="view" value="month">
        <input type="month" class="form-control" name="center" value="{{ center.strftime('%Y-%m') }}">
        <button class="btn btn-outline-info" type="submit">Ir</button>
      </form>
    </div>

    <div class="card glass p-3 p-md-4">
      <div class="month-grid">
        <div class="month-head">L</div><div class="month-head">M</div><div class="month-head">X</div>
        <div class="month-head">J</div><div class="month-head">V</div><div class="month-head">S</div><div class="month-head">D</div>

        {% for w in month_grid %}
          {% for d in w %}
            {% if d %}
              {% set pm = planes_mes[d] %}
              {% set blocked = ((pm.puede_entrenar or 'si') == 'no') %}
              <div class="month-cell {% if blocked %}blocked{% endif %}"
                   data-date="{{ d.isoformat() }}"
                   onclick="openDay('{{ d.isoformat() }}')">
                <div class="daynum">{{ d.day }}</div>
              </div>
            {% else %}
              <div class="month-cell empty"></div>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if view == 'progress' %}
    <div class="card glass p-3 p-md-4">
      <div class="mb-2">
        <h4 class="text-light mb-0">Tus progresos</h4>
        <div class="text-muted">Semana actual Â· Objetivo vs completado</div>
      </div>

      <div class="glass p-3 mt-2" style="border-radius:18px;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="mini-title">CONSISTENCIA</div>
          <div class="text-muted" style="font-weight:900;">
            {% set pct = 0 if week_goal==0 else (week_done*100//week_goal) %}
            {{ pct }}%
          </div>
        </div>

        <div class="vr-bars">
          {% for i in range(7) %}
            <div class="vr-bar">
              <div class="vr-bar-fill" style="height: {{ 100 if i < week_done else 0 }}%;"></div>
            </div>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between mt-2 vr-days">
          <span>L</span><span>M</span><span>X</span>
          <span>J</span><span>V</span><span>S</span><span>D</span>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- =========================
     MODAL DÃA (SIMPLE + PRO)
========================= -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-xl">
    <div class="modal-content day-modal">
      <div class="modal-header">
        <div class="w-100">
          <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
            <div>
              <div class="text-muted" id="dayModalDate" style="letter-spacing:.18em;text-transform:uppercase;"></div>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <h5 class="modal-title mb-0" id="dayModalTitle">Detalle</h5>
                <span class="day-chip" id="dayModalType">â€”</span>
              </div>
              <div class="text-muted mt-1" style="font-size:.95rem;">Lo que toca hoy.</div>
            </div>

            <div class="d-flex align-items-center gap-3 flex-wrap">
              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" id="didTrain">
                <label class="form-check-label text-muted" for="didTrain">Hoy entrenÃ©</label>
              </div>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-body">
        <div class="row g-3">

          <!-- IZQUIERDA: SOLO LO QUE EXISTE -->
          <div class="col-lg-4">
            <div class="day-section">
              <div class="day-section-title">Plan</div>

              <div id="planWarmupWrap" class="plan-card d-none">
                <div class="plan-k">ActivaciÃ³n</div>
                <div class="plan-v" id="planWarmup">â€”</div>
              </div>

              <div id="planMainWrap" class="plan-card d-none">
                <div class="plan-k">Principal</div>
                <div class="plan-v" id="planMain">â€”</div>
              </div>

              <div id="planFinisherWrap" class="plan-card d-none">
                <div class="plan-k">Enfriamiento</div>
                <div class="plan-v" id="planFinisher">â€”</div>
              </div>

              <!-- DISPONIBILIDAD: OCULTA POR DEFECTO (solo aparece si estÃ¡ bloqueado o si el atleta abre) -->
              <div id="availWrap" class="avail-box mt-2 d-none">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="day-section-title" style="margin:0;">Disponibilidad</div>
                  <span id="availBadge" class="badge bg-secondary">â€”</span>
                </div>

                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="noPuedoToggle">
                  <label class="form-check-label text-muted" for="noPuedoToggle">No puedo entrenar</label>
                </div>

                <textarea class="form-control mt-2" id="noPuedoText"
                          placeholder="Motivo (corto)"></textarea>

                <button class="btn btn-outline-danger w-100 mt-2" type="button" onclick="saveAvailability()">
                  Guardar
                </button>

                <div class="text-muted mt-2" style="font-size:.9rem;">
                  Si bloqueÃ¡s el dÃ­a, el coach lo verÃ¡ en rojo.
                </div>
              </div>

              <!-- BOTÃ“N PEQUEÃ‘O PARA ABRIR DISPONIBILIDAD (solo si aÃºn NO estÃ¡ bloqueado) -->
              <button id="openAvailBtn" class="btn btn-outline-light w-100 mt-2 d-none" type="button" onclick="openAvailability()">
                <i class="bi bi-slash-circle"></i> No puedo entrenar
              </button>

            </div>
          </div>

          <!-- DERECHA: BLOQUES + CHECK + VIDEOS (SIN DUPLICAR) -->
          <div class="col-lg-8">
            <div class="day-section">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                <div>
                  <div class="day-section-title">Lo que toca hoy</div>
                  <div class="text-muted" id="blocksMeta">â€”</div>
                </div>
              </div>

              <div id="dayBlocks" class="blocks-wrap">
                <div class="text-muted">Cargando...</div>
              </div>
            </div>

            <!-- QUE HICISTE: 1 SOLO CAMPO -->
            <div class="day-section mt-3">
              <div class="day-section-title">QuÃ© hiciste</div>
              <textarea class="form-control" id="doneText" rows="4" placeholder="ContÃ¡ quÃ© hiciste hoy (rÃ¡pido)..."></textarea>
              <button class="btn btn-primary w-100 mt-2" onclick="saveLog()">
                ðŸ’¾ Guardar
              </button>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.day-modal{
  background: radial-gradient(circle at 50% 20%, #111 0%, #000 90%) !important;
  color: rgba(255,255,255,.92);
}
.day-modal .modal-body{ background: transparent; }

.month-head{ color: rgba(255,255,255,.72) !important; }
.month-cell{ background: rgba(0,0,0,.42) !important; }
.month-cell .daynum{ color: rgba(255,255,255,.92) !important; }
.month-cell.blocked{
  background: rgba(255, 59, 48, 0.18) !important;
  border: 1px solid rgba(255, 59, 48, 0.55) !important;
  box-shadow: 0 0 0 1px rgba(255,59,48,0.15) inset;
}

.vr-days span{ color: rgba(255,255,255,.78); font-weight: 900; letter-spacing:.08em; }

.day-chip{
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  border-radius: 999px;
  padding: 6px 10px;
  font-weight: 900;
  font-size: .82rem;
  letter-spacing:.06em;
}

.day-section{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius: 18px;
  padding: 12px;
}
.day-section-title{
  font-weight: 950;
  letter-spacing: .14em;
  text-transform: uppercase;
  font-size: .78rem;
  color: rgba(255,255,255,.72);
  margin-bottom: 10px;
}

.plan-card{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius: 16px;
  padding: 12px;
  margin-bottom: 10px;
}
.plan-k{
  font-weight: 900;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: rgba(255,255,255,.72);
  font-size: .78rem;
}
.plan-v{
  margin-top: 6px;
  font-size: 1.00rem;
  font-weight: 800;
  color: rgba(255,255,255,.92);
  white-space: pre-line;
}

.blocks-wrap{ display:grid; gap:12px; }

.block-card{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius: 18px;
  padding: 12px;
}
.block-head{
  display:flex;
  justify-content: space-between;
  align-items:flex-start;
  gap:10px;
}
.block-left{ display:flex; gap:10px; align-items:flex-start; }
.block-icon{
  width:40px;height:40px;border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  flex: 0 0 auto;
}
.block-title{ font-weight: 950; color: rgba(255,255,255,.96); line-height: 1.1; }
.block-sub{
  color: rgba(255,255,255,.72);
  font-weight: 800;
  font-size: .92rem;
  margin-top: 4px;
  line-height: 1.2;
}
.block-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }

.exercise-mini{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(0,0,0,.18);
  border-radius: 16px;
  padding: 10px;
  margin-top: 10px;
}
.exercise-row{
  display:flex;
  justify-content: space-between;
  gap:10px;
  padding: 8px 0;
  border-bottom: 1px dashed rgba(255,255,255,.10);
}
.exercise-row:last-child{ border-bottom: 0; }
.exercise-name{ font-weight: 900; }
.exercise-meta{ color: rgba(255,255,255,.70); font-weight: 800; font-size: .92rem; }
.exercise-video video{
  width:100%;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.35);
  min-height: 200px;
  object-fit: cover;
  margin-top: 8px;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let DAY_MODAL = null;
let CURRENT_DAY = null;
let CURRENT_USER = {{ user.id|int }};
let CURRENT_PAYLOAD = null;
let CURRENT_CHECKS = new Set();

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function decodeHtmlEntities(s){
  const txt = document.createElement("textarea");
  txt.innerHTML = String(s||"");
  return txt.value;
}
function cleanText(s){
  let out = decodeHtmlEntities(s);
  if(out.includes("&") || out.includes("&#")) out = decodeHtmlEntities(out);
  return out;
}
function hasMeaningfulText(s){
  const t = (s ?? "").toString().trim();
  if(!t) return false;
  if(t.toLowerCase() === "none") return false;
  return true;
}

function badgeHtml(type){
  const t = (type||"").toUpperCase();
  const map = {
    "TABATA": "bg-danger",
    "FUERZA": "bg-info",
    "RUN": "bg-success",
    "BIKE": "bg-warning text-dark",
    "SWIM": "bg-primary",
    "FREE": "bg-secondary",
    "NOTE": "bg-light text-dark"
  };
  const cls = map[t] || "bg-secondary";
  return `<span class="badge ${cls}" style="font-weight:900; letter-spacing:.06em;">${escapeHtml(t||"BLOQUE")}</span>`;
}
function typeLabel(type){
  const t = (type||"").toLowerCase();
  if(t === "tabata") return "TABATA";
  if(t === "fuerza") return "FUERZA";
  if(t === "run") return "RUN";
  if(t === "bike") return "BIKE";
  if(t === "swim") return "SWIM";
  if(t === "free") return "FREE";
  if(t === "note") return "NOTE";
  return (type||"BLOQUE").toUpperCase();
}

function setAvailUI(puede, comentario){
  const wrap = document.getElementById("availWrap");
  const openBtn = document.getElementById("openAvailBtn");
  const toggle = document.getElementById("noPuedoToggle");
  const text = document.getElementById("noPuedoText");
  const badge = document.getElementById("availBadge");

  const blocked = (puede === "no");
  toggle.checked = blocked;
  text.value = comentario || "";

  if(blocked){
    wrap.classList.remove("d-none");     // si estÃ¡ bloqueado, se ve
    openBtn.classList.add("d-none");    // no muestro botÃ³n "No puedo entrenar"
    badge.className = "badge bg-danger";
    badge.textContent = "BLOQUEADO";
  }else{
    wrap.classList.add("d-none");       // por defecto oculto
    openBtn.classList.remove("d-none"); // muestro el botÃ³n para abrirlo si quiere
    badge.className = "badge bg-success";
    badge.textContent = "OK";
  }
}

function openAvailability(){
  const wrap = document.getElementById("availWrap");
  const openBtn = document.getElementById("openAvailBtn");
  wrap.classList.remove("d-none");
  openBtn.classList.add("d-none");
  // no marcamos bloqueado aÃºn; eso solo cuando el usuario lo activa y guarda
}

function posterDataUrl(title){
  const safe = (title || "VR TRAINING").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="1280" height="720">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#0b0f12"/>
        <stop offset="1" stop-color="#050608"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#g)"/>
    <rect x="40" y="40" width="1200" height="640" rx="36" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.16)"/>
    <circle cx="640" cy="360" r="62" fill="rgba(34,211,238,0.18)" stroke="rgba(34,211,238,0.45)" stroke-width="6"/>
    <polygon points="625,330 625,390 680,360" fill="rgba(255,255,255,0.85)"/>
    <text x="80" y="130" font-size="46" fill="rgba(255,255,255,0.92)" font-family="Arial" font-weight="700">${safe}</text>
    <text x="80" y="180" font-size="26" fill="rgba(255,255,255,0.60)" font-family="Arial">VR Training</text>
  </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function strengthItemsHtml(items){
  const arr = Array.isArray(items) ? items : [];
  if(!arr.length) return `<div class="text-muted">No hay ejercicios cargados.</div>`;

  return `
    <div class="exercise-mini">
      ${arr.map(it => {
        const id = String(it.id);
        const checked = CURRENT_CHECKS.has(id) ? "checked" : "";
        const name = escapeHtml(cleanText(it.nombre || "Ejercicio"));
        const metaParts = [];
        if(it.series) metaParts.push(escapeHtml(it.series));
        if(it.reps) metaParts.push(escapeHtml(it.reps));
        if(it.descanso) metaParts.push("Desc " + escapeHtml(it.descanso));
        if(it.nota) metaParts.push(escapeHtml(cleanText(it.nota)));
        const meta = metaParts.join(" Â· ");

        const vidSrc = it.video_src || "";
        const poster = posterDataUrl(it.nombre);

        return `
          <div class="exercise-row">
            <div style="min-width:0;">
              <div class="exercise-name">${name}</div>
              <div class="exercise-meta">${meta || ""}</div>
              ${vidSrc ? `
                <div class="exercise-video">
                  <video controls playsinline webkit-playsinline preload="metadata" poster="${poster}">
                    <source src="${vidSrc}" type="video/mp4">
                  </video>
                </div>
              ` : `<div class="text-muted mt-1">Sin video</div>`}
            </div>

            <div class="d-flex align-items-center gap-2">
              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" ${checked}
                       onchange="toggleItem(${it.id}, this.checked)">
              </div>
              <div class="text-muted" style="font-weight:900;letter-spacing:.08em;">HECHO</div>
            </div>
          </div>
        `;
      }).join("")}
    </div>
  `;
}

function renderBlocks(blocks){
  const wrap = document.getElementById("dayBlocks");
  const meta = document.getElementById("blocksMeta");
  wrap.innerHTML = "";

  const arr = Array.isArray(blocks) ? blocks : [];
  meta.textContent = arr.length ? `${arr.length} bloque(s)` : "â€”";

  if(!arr.length){
    wrap.innerHTML = `<div class="text-muted">No hay bloques definidos.</div>`;
    return;
  }

  arr.forEach((b, idx) => {
    const type = (b.type || "").toLowerCase();
    const ok = b.ok !== false;

    let icon = "bi-grid";
    if(type === "tabata"){ icon = "bi-lightning-charge-fill"; }
    if(type === "run"){ icon = "bi-person-running"; }
    if(type === "bike"){ icon = "bi-bicycle"; }
    if(type === "swim"){ icon = "bi-water"; }
    if(type === "free"){ icon = "bi-wind"; }
    if(type === "note"){ icon = "bi-chat-left-text"; }
    if(type === "fuerza"){ icon = "bi-barbell"; }

    const div = document.createElement("div");
    div.className = "block-card";

    if(!ok){
      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-warning"></i></div>
            <div>
              <div class="block-title">${typeLabel(b.type)}</div>
              <div class="block-sub text-warning">${escapeHtml(b.error || "Bloque invÃ¡lido")}</div>
            </div>
          </div>
          ${badgeHtml(typeLabel(b.type))}
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "tabata"){
      const rname = cleanText(b.rutina?.nombre || "Tabata");
      const work = b.cfg?.work ?? 40;
      const rest = b.cfg?.rest ?? 20;
      const rounds = b.cfg?.rounds ?? (Array.isArray(b.items) ? b.items.length : 0);
      const sets = b.cfg?.sets ?? 1;
      const startUrl = b.start_url || "#";

      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
            <div>
              <div class="block-title">${escapeHtml(rname)}</div>
              <div class="block-sub">${work}s Â· ${rest}s Â· ${rounds} ejercicios Â· ${sets} set(s)</div>
            </div>
          </div>
          ${badgeHtml("TABATA")}
        </div>

        <div class="block-actions">
          <a class="btn btn-danger" href="${startUrl}" target="_blank" rel="noopener">â–¶ Reproducir</a>
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "run" || type === "bike" || type === "swim" || type === "free" || type === "note"){
      const text = cleanText(b.text || "â€”");
      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
            <div>
              <div class="block-title">${typeLabel(b.type)}</div>
              <div class="block-sub">${escapeHtml(text)}</div>
            </div>
          </div>
          ${badgeHtml(typeLabel(b.type))}
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "fuerza"){
      const rname = cleanText(b.rutina?.nombre || "Fuerza");
      const collapseId = `force_${idx}`;
      const hasItems = Array.isArray(b.items) && b.items.length;

      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
            <div>
              <div class="block-title">${escapeHtml(rname)}</div>
              <div class="block-sub">${hasItems ? "Ejercicios con video y check." : "Sin ejercicios cargados."}</div>
            </div>
          </div>
          ${badgeHtml("FUERZA")}
        </div>

        <div class="block-actions">
          <button class="btn btn-outline-light" type="button"
                  data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false">
            Ver ejercicios
          </button>
        </div>

        <div class="collapse mt-2" id="${collapseId}">
          ${strengthItemsHtml(b.items || [])}
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    div.innerHTML = `
      <div class="block-head">
        <div class="block-left">
          <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
          <div>
            <div class="block-title">${typeLabel(b.type)}</div>
            <div class="block-sub">${escapeHtml(cleanText(b.text || ""))}</div>
          </div>
        </div>
        ${badgeHtml(typeLabel(b.type))}
      </div>
    `;
    wrap.appendChild(div);
  });
}

/* =========================
   MODAL OPEN
========================= */
function openDay(isoDate){
  CURRENT_DAY = isoDate;

  if(typeof bootstrap === "undefined"){
    alert("Bootstrap JS no cargÃ³. RevisÃ¡ layout.html (bootstrap.bundle.min.js).");
    return;
  }
  if(!DAY_MODAL){
    DAY_MODAL = new bootstrap.Modal(document.getElementById("dayModal"));
  }

  CURRENT_PAYLOAD = null;
  CURRENT_CHECKS = new Set();

  document.getElementById("dayModalDate").textContent = isoDate;
  document.getElementById("dayModalTitle").textContent = "Cargando...";
  document.getElementById("dayModalType").textContent = "â€”";

  // reset plan wrappers
  document.getElementById("planWarmupWrap").classList.add("d-none");
  document.getElementById("planMainWrap").classList.add("d-none");
  document.getElementById("planFinisherWrap").classList.add("d-none");

  document.getElementById("planWarmup").textContent = "â€”";
  document.getElementById("planMain").textContent = "â€”";
  document.getElementById("planFinisher").textContent = "â€”";

  document.getElementById("dayBlocks").innerHTML = `<div class="text-muted">Cargando...</div>`;
  document.getElementById("blocksMeta").textContent = "â€”";

  document.getElementById("didTrain").checked = false;
  document.getElementById("doneText").value = "";

  // disponibilidad oculta por defecto
  setAvailUI("si", "");

  fetch(`/api/day_detail?user_id=${CURRENT_USER}&fecha=${encodeURIComponent(isoDate)}`)
    .then(r => r.json())
    .then(data => {
      if(!data.ok) throw new Error(data.error || "Error");
      CURRENT_PAYLOAD = data;

      const p = data.plan || {};

      document.getElementById("dayModalTitle").textContent = cleanText(data.rutina?.nombre || "Detalle del dÃ­a");
      document.getElementById("dayModalType").textContent = cleanText(p.plan_type || "â€”");

      const warm = cleanText(p.warmup || "");
      const main = cleanText(p.main || "");
      const fin  = cleanText(p.finisher || "");

      if(hasMeaningfulText(warm)){
        document.getElementById("planWarmupWrap").classList.remove("d-none");
        document.getElementById("planWarmup").textContent = warm;
      }
      if(hasMeaningfulText(main)){
        document.getElementById("planMainWrap").classList.remove("d-none");
        document.getElementById("planMain").textContent = main;
      }
      if(hasMeaningfulText(fin)){
        document.getElementById("planFinisherWrap").classList.remove("d-none");
        document.getElementById("planFinisher").textContent = fin;
      }

      setAvailUI(p.puede_entrenar || "si", cleanText(p.comentario_atleta || ""));

      document.getElementById("didTrain").checked = !!data.log?.did_train;

      // usamos main_done como campo Ãºnico (compat con tu backend)
      const existing = cleanText(data.log?.main_done || data.log?.warmup_done || data.log?.finisher_done || "");
      document.getElementById("doneText").value = existing;

      CURRENT_CHECKS = new Set((Array.isArray(data.checks) ? data.checks : []).map(x => String(x)));

      renderBlocks(data.blocks || []);
      DAY_MODAL.show();
    })
    .catch(err => {
      console.error(err);
      alert("Error cargando el dÃ­a: " + err.message);
    });
}

/* =========================
   CHECKS + LOG + AVAIL
========================= */
function toggleItem(itemId, done){
  const form = new FormData();
  form.append("user_id", String(CURRENT_USER));
  form.append("fecha", String(CURRENT_DAY));
  form.append("item_id", String(itemId));
  form.append("done", done ? "1" : "0");

  fetch("/athlete/check_item", { method:"POST", body: form })
    .then(r => r.json())
    .then(j => {
      if(!j.ok) throw new Error(j.error || "Error");
      if(done) CURRENT_CHECKS.add(String(itemId));
      else CURRENT_CHECKS.delete(String(itemId));
    })
    .catch(err => { console.error(err); alert("Error guardando check: " + err.message); });
}

function saveLog(){
  const payload = {
    user_id: CURRENT_USER,
    fecha: CURRENT_DAY,
    did_train: document.getElementById("didTrain").checked,
    warmup_done: "",
    main_done: document.getElementById("doneText").value || "",
    finisher_done: ""
  };

  fetch("/athlete/save_log", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(j => { if(!j.ok) throw new Error(j.error || "Error"); alert("âœ… Guardado"); })
  .catch(err => { console.error(err); alert("Error guardando: " + err.message); });
}

async function saveAvailability(){
  const noPuedo = document.getElementById("noPuedoToggle").checked;
  const comentario = document.getElementById("noPuedoText").value || "";
  const payload = { user_id: CURRENT_USER, fecha: CURRENT_DAY, no_puedo: noPuedo, comentario };

  try{
    const res = await fetch("/athlete/save_availability", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || "Error");

    setAvailUI(noPuedo ? "no" : "si", comentario);

    const cell = document.querySelector(`.month-cell[data-date="${CSS.escape(CURRENT_DAY)}"]`);
    if(cell){
      if(noPuedo) cell.classList.add("blocked");
      else cell.classList.remove("blocked");
    }

    alert("âœ… Guardado");
  }catch(err){
    console.error(err);
    alert("Error guardando disponibilidad: " + err.message);
  }
}
</script>
{% endblock %}
