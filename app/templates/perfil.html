{% extends "layout.html" %}
{% block title %}Perfil de {{ user.nombre }} ‚Äî VR Training{% endblock %}

{% block content %}
<div class="perfil-container">

  <!-- HEADER -->
  <div class="text-center mb-4">
    <img src="{{ url_for('static', filename='logo_blanco_vr_training.png') }}" class="perfil-logo" alt="VR Training">
    <h2 class="perfil-nombre mt-2">{{ user.nombre }}</h2>
    <div class="perfil-sub">
      {{ user.email }} ‚Ä¢ Grupo: {{ user.grupo or '‚Äî' }}
    </div>
  </div>

  <!-- TABS -->
  <ul class="nav nav-tabs nav-vr-tabs justify-content-center mb-4" id="perfilTabs">
    <li class="nav-item"><button class="nav-link active" data-tab="semana">üìÖ Semana</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="calendario">üóìÔ∏è Calendario</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="progreso">üìà Progreso</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="rutinas">üèãÔ∏è Rutinas</button></li>
  </ul>

  <!-- TAB SEMANA -->
  <section id="tab-semana" class="vr-tab active">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-light mb-3">{{ semana_str }}</h5>

      <div class="week-grid">
        {% for f in fechas %}
          {% set plan = planes[f] %}
          {% set tipo = (plan.plan_type or 'descanso')|lower %}
          {% set rutina = rutina_by_day.get(f) %}
          {% set items = items_by_day.get(f, []) %}
          {% set plan_label = (plan.plan_type or 'Descanso') %}

          <div class="day-card day-{{ tipo }}">
            <div class="d-flex justify-content-between mb-1">
              <strong>{{ f.strftime('%a')|upper }} {{ f.day }}</strong>
              <span class="badge badge-{{ tipo }}">{{ plan_label|capitalize }}</span>
            </div>

            {% if rutina %}
              <div class="mt-2">
                <div class="text-info small"><strong>Rutina:</strong> {{ rutina.nombre }}</div>
                <div class="text-muted small">{{ items|length }} ejercicios</div>
              </div>

              <div class="mt-2">
                {% if items %}
                  {% for it in items %}
                    <div class="p-2 rounded mb-2" style="background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08);">
                      <div class="d-flex justify-content-between align-items-center">
                        <div class="small"><strong>{{ it.nombre }}</strong></div>

                        {% set is_done = (f, it.id) in done_set %}
                        <button class="btn btn-sm {% if is_done %}btn-success{% else %}btn-outline-info{% endif %}"
                                onclick="toggleDone('{{ f.strftime('%Y-%m-%d') }}', {{ it.id }}, {{ 0 if is_done else 1 }}, this)">
                          {% if is_done %}‚úÖ Realizado{% else %}Marcar realizado{% endif %}
                        </button>
                      </div>

                      {% if it.series or it.reps or it.descanso %}
                        <div class="text-muted small mt-1">
                          {% if it.series %}Series: {{ it.series }}{% endif %}
                          {% if it.reps %} ‚Ä¢ Reps: {{ it.reps }}{% endif %}
                          {% if it.descanso %} ‚Ä¢ Descanso: {{ it.descanso }}{% endif %}
                        </div>
                      {% endif %}

                      {% if it.video_url %}
                        <video class="w-100 rounded mt-2" controls preload="metadata" style="max-height:220px;">
                          <source src="{{ url_for('static', filename=it.video_url) }}" type="video/mp4">
                        </video>
                      {% endif %}

                      {# ‚úÖ FIX: en tu modelo es "nota", NO "notas" #}
                      {% if it.nota %}
                        <div class="small text-secondary mt-1">{{ it.nota }}</div>
                      {% endif %}
                    </div>
                  {% endfor %}
                {% else %}
                  <div class="small text-muted mt-2">Esta rutina no tiene ejercicios cargados.</div>
                {% endif %}
              </div>

            {% else %}
              <div class="small text-muted mt-2">Sin rutina asignada.</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- TAB CALENDARIO -->
  <section id="tab-calendario" class="vr-tab">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-info mb-3">Calendario ‚Äî {{ hoy.strftime('%B %Y')|capitalize }}</h5>
      <div class="calendar-grid">
        {% for f in dias_mes %}
          {% set plan_mes = planes_mes.get(f) %}
          {% set tipo_mes = (plan_mes.plan_type|lower) if plan_mes and plan_mes.plan_type else 'descanso' %}
          <div class="calendar-day day-{{ tipo_mes }}">
            <div class="cal-header">
              <span class="cal-day-num">{{ f.day }}</span>
              <span class="cal-weekday">{{ f.strftime('%a')|upper }}</span>
            </div>
            {% if plan_mes %}
              <div class="event-pill event-{{ tipo_mes }}">
                <span class="event-text">{{ (plan_mes.plan_type or 'Descanso')|capitalize }}</span>
              </div>
            {% else %}
              <span class="plan-empty mt-2">Sin plan</span>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </section>

  <!-- TAB PROGRESO -->
  <section id="tab-progreso" class="vr-tab">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-light mb-3">Progreso</h5>
      <div class="text-muted">Aqu√≠ luego metemos el gr√°fico (cuando quieras lo enchufamos).</div>
    </div>
  </section>

  <!-- TAB RUTINAS -->
  <section id="tab-rutinas" class="vr-tab">
    <div class="card bg-black border-0 shadow-lg mb-4 p-3">
      <h5 class="text-light mb-3">Rutinas disponibles</h5>
      <div class="row g-3">
        {% for r in rutinas %}
          <div class="col-md-6 col-lg-4">
            <div class="p-3 rounded" style="background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08);">
              <div class="d-flex justify-content-between">
                <div>
                  <strong>{{ r.nombre }}</strong>
                  {% if r.tipo %}<span class="badge bg-info text-dark ms-2">{{ r.tipo }}</span>{% endif %}
                  {% if r.descripcion %}<div class="small text-muted mt-1">{{ r.descripcion }}</div>{% endif %}
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div class="text-muted">No hay rutinas todav√≠a.</div>
        {% endfor %}
      </div>
    </div>
  </section>

</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const tabs = document.querySelectorAll(".nav-vr-tabs .nav-link");
  const sections = {
    semana: document.getElementById("tab-semana"),
    calendario: document.getElementById("tab-calendario"),
    progreso: document.getElementById("tab-progreso"),
    rutinas: document.getElementById("tab-rutinas"),
  };

  function activateTab(name) {
    tabs.forEach(btn => btn.classList.toggle("active", btn.dataset.tab === name));
    Object.entries(sections).forEach(([key, sec]) => sec.classList.toggle("active", key === name));
  }

  tabs.forEach(btn => btn.addEventListener("click", () => activateTab(btn.dataset.tab)));
  activateTab("semana");
});

// ‚úÖ Este endpoint en routes.py espera JSON (request.get_json)
async function toggleDone(fechaISO, itemId, doneValue, btn) {
  try {
    const res = await fetch("{{ url_for('main.athlete_check_item') }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        fecha: fechaISO,
        item_id: itemId,
        done: doneValue ? true : false
      })
    });

    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Error");

    if (doneValue) {
      btn.classList.remove("btn-outline-info");
      btn.classList.add("btn-success");
      btn.textContent = "‚úÖ Realizado";
      btn.setAttribute("onclick", `toggleDone('${fechaISO}', ${itemId}, 0, this)`);
    } else {
      btn.classList.remove("btn-success");
      btn.classList.add("btn-outline-info");
      btn.textContent = "Marcar realizado";
      btn.setAttribute("onclick", `toggleDone('${fechaISO}', ${itemId}, 1, this)`);
    }
  } catch (e) {
    alert("No se pudo guardar: " + e.message);
  }
}
</script>
{% endblock %}
