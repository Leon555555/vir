{% extends "layout.html" %}
{% block title %}Perfil â€” VR Training{% endblock %}

{# ============================================================
   âœ… Macro: icono + texto para plan_type (sin templates extra)
   Usa tus PNG en /static/icons/
   fuerza.png, run.png, pista.png, bike.png, natacion.png, descanso.png
============================================================ #}
{% macro activity_badge(plan_type, size='') %}
  {% set raw = (plan_type or 'Descanso') %}
  {% set t = raw|string %}
  {% set norm = t|lower %}

  {% if norm in ['swim','natacion','nataciÃ³n'] %}
    {% set icon = 'icons/natacion.png' %}
    {% set label = 'NataciÃ³n' %}
  {% elif norm in ['pista','run_pista','track'] %}
    {% set icon = 'icons/pista.png' %}
    {% set label = 'Pista' %}
  {% elif norm in ['run','running'] %}
    {% set icon = 'icons/run.png' %}
    {% set label = 'Run' %}
  {% elif norm in ['bike','bici','cycling'] %}
    {% set icon = 'icons/bike.png' %}
    {% set label = 'Bike' %}
  {% elif norm in ['fuerza','strength','gym'] %}
    {% set icon = 'icons/fuerza.png' %}
    {% set label = 'Fuerza' %}
  {% elif norm in ['descanso','rest','recovery','off'] %}
    {% set icon = 'icons/descanso.png' %}
    {% set label = 'Descanso' %}
  {% else %}
    {# fallback #}
    {% set icon = 'icons/descanso.png' %}
    {% set label = t %}
  {% endif %}

  <span class="vr-activity-badge {% if size=='sm' %}sm{% endif %}">
    <img class="vr-activity-icon" src="{{ url_for('static', filename=icon) }}" alt="{{ label }}">
    <span class="vr-activity-text">{{ label }}</span>
  </span>
{% endmacro %}

{% block content %}
<div class="container mt-4">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div class="d-flex align-items-center gap-3">
      <div class="vr-avatar">
        <i class="bi bi-person-fill text-info"></i>
      </div>

      <div>
        <h2 class="text-light mb-0">{{ user.nombre }}</h2>
        <div class="text-muted">{{ user.email }}</div>

        <div class="mt-2">
          {% if strava_account %}
            <span class="badge bg-success">ðŸŸ  Strava conectado</span>
          {% else %}
            <a href="{{ url_for('main.strava_connect') }}" class="btn btn-sm btn-outline-warning">
              ðŸ”— Conectar con Strava
            </a>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="d-flex gap-2 align-items-center flex-wrap">
      {% if admin_ok %}
        <a class="btn btn-outline-info" href="{{ url_for('main.coach_planificador', user_id=user.id) }}">
          <i class="bi bi-calendar3"></i> Planificar
        </a>
      {% endif %}
      <a class="btn btn-outline-light" href="{{ url_for('main.perfil_redirect') }}">
        <i class="bi bi-arrow-left"></i> Volver
      </a>

      <div class="mini-stat">
        <div class="mini-title">RACHA</div>
        <div class="mini-value">ðŸ”¥ {{ streak }}</div>
      </div>
      <div class="mini-stat">
        <div class="mini-title">SEMANA</div>
        <div class="mini-value">âœ… {{ week_done }} / {{ week_goal }}</div>
        <div class="progress mt-2">
          {% set pct = 0 if week_goal==0 else (week_done*100//week_goal) %}
          <div class="progress-bar" style="width: {{ pct }}%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="d-flex gap-2 flex-wrap mb-3">
    <a class="btn btn-sm {% if view=='today' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='today') }}">Hoy</a>

    <a class="btn btn-sm {% if view=='week' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=center.isoformat()) }}">Semana</a>

    <a class="btn btn-sm {% if view=='month' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='month', center=center.isoformat()) }}">Mes</a>

    <a class="btn btn-sm {% if view=='progress' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='progress', center=center.isoformat()) }}">Progreso</a>
  </div>

  {% if view == 'today' %}
    <div class="card glass p-3 p-md-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <div>
          <div class="text-muted vr-kicker" style="letter-spacing:.18em;text-transform:uppercase;">HOY</div>
          <div class="d-flex align-items-center gap-2 flex-wrap">
            <div class="fs-4 fw-bold">{{ hoy.strftime('%A %d/%m')|upper }}</div>
            {{ activity_badge(plan_hoy.plan_type, 'sm') }}
          </div>
          <div class="text-muted mt-1">EntrÃ¡ y marcÃ¡ lo que hiciste.</div>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-info" type="button" onclick="openDay('{{ hoy.isoformat() }}')">
            â–¶ Empezar
          </button>

          <a class="btn btn-outline-light"
             href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=hoy.isoformat()) }}">
            Ver semana
          </a>
        </div>
      </div>
    </div>
  {% endif %}

  {% if view == 'week' %}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h4 class="text-light mb-0">Semana</h4>
        <div class="text-muted">{{ semana_str }}</div>
      </div>

      <form method="GET" class="d-flex gap-2">
        <input type="hidden" name="view" value="week">
        <input type="date" class="form-control" name="center" value="{{ center.isoformat() }}">
        <button class="btn btn-outline-info" type="submit">Ir</button>
      </form>
    </div>

    <div class="row g-3">
      {% for f in fechas %}
        {% set p = planes[f] %}
        {% set done = (f in done_week) %}
        <div class="col-md-6 col-lg-4">
          <div class="card glass p-3 lift">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold" style="letter-spacing:.08em;">{{ f.strftime('%a %d/%m')|upper }}</div>

              {% if done %}
                <span class="badge bg-success">HECHO</span>
              {% else %}
                {{ activity_badge(p.plan_type, 'sm') }}
              {% endif %}
            </div>

            <div class="text-muted" style="font-size:.95rem;">
              {% if (p.plan_type or '').lower() == 'descanso' %}
                Descanso / recuperaciÃ³n.
              {% else %}
                {{ p.warmup or 'â€”' }}
              {% endif %}
            </div>

            <div class="d-grid mt-3">
              <button class="btn btn-outline-info" type="button" onclick="openDay('{{ f.isoformat() }}')">
                Ver detalle
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if view == 'month' %}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h4 class="text-light mb-0">Mes</h4>
        <div class="text-muted">{{ month_label }}</div>
      </div>

      <form method="GET" class="d-flex gap-2">
        <input type="hidden" name="view" value="month">
        <input type="month" class="form-control" name="center" value="{{ center.strftime('%Y-%m') }}">
        <button class="btn btn-outline-info" type="submit">Ir</button>
      </form>
    </div>

    <div class="card glass p-3 p-md-4">
      <div class="month-grid">
        <div class="month-head">L</div><div class="month-head">M</div><div class="month-head">X</div>
        <div class="month-head">J</div><div class="month-head">V</div><div class="month-head">S</div><div class="month-head">D</div>

        {% for w in month_grid %}
          {% for d in w %}
            {% if d %}
              {% set pm = planes_mes[d] %}
              {% set blocked = ((pm.puede_entrenar or 'si') == 'no') %}
              <div class="month-cell {% if blocked %}blocked{% endif %}"
                   data-date="{{ d.isoformat() }}"
                   onclick="openDay('{{ d.isoformat() }}')">
                <div class="daynum">{{ d.day }}</div>

                {% set raw = (pm.plan_type or 'Descanso') %}
                {% set norm = raw|lower %}
                {% if norm in ['swim','natacion','nataciÃ³n'] %}
                  {% set icon = 'icons/natacion.png' %}
                  {% set label = 'NataciÃ³n' %}
                {% elif norm in ['pista','run_pista','track'] %}
                  {% set icon = 'icons/pista.png' %}
                  {% set label = 'Pista' %}
                {% elif norm in ['run','running'] %}
                  {% set icon = 'icons/run.png' %}
                  {% set label = 'Run' %}
                {% elif norm in ['bike','bici','cycling'] %}
                  {% set icon = 'icons/bike.png' %}
                  {% set label = 'Bike' %}
                {% elif norm in ['fuerza','strength','gym'] %}
                  {% set icon = 'icons/fuerza.png' %}
                  {% set label = 'Fuerza' %}
                {% else %}
                  {% set icon = 'icons/descanso.png' %}
                  {% set label = 'Descanso' %}
                {% endif %}

                <div class="ptype-icon">
                  <img src="{{ url_for('static', filename=icon) }}" alt="{{ label }}">
                  <span>{{ label }}</span>
                </div>
              </div>
            {% else %}
              <div class="month-cell empty"></div>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if view == 'progress' %}
    <div class="card glass p-3 p-md-4">
      <div class="mb-2">
        <h4 class="text-light mb-0">Tus progresos</h4>
        <div class="text-muted">Semana actual Â· Objetivo vs completado</div>
      </div>

      <div class="glass p-3 mt-2" style="border-radius:18px;">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="mini-title">CONSISTENCIA</div>
          <div class="text-muted" style="font-weight:900;">
            {% set pct = 0 if week_goal==0 else (week_done*100//week_goal) %}
            {{ pct }}%
          </div>
        </div>

        <div class="vr-bars">
          {% for i in range(7) %}
            <div class="vr-bar">
              <div class="vr-bar-fill" style="height: {{ 100 if i < week_done else 0 }}%;"></div>
            </div>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between mt-2 vr-days">
          <span>L</span><span>M</span><span>X</span>
          <span>J</span><span>V</span><span>S</span><span>D</span>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<!-- =========================
     MODAL DÃA (PREMIUM CLEAN)
========================= -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-xl">
    <div class="modal-content day-modal">

      <div class="modal-header">
        <div class="w-100">
          <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
            <div>
              <div class="text-muted" id="dayModalDate" style="letter-spacing:.18em;text-transform:uppercase;"></div>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <h5 class="modal-title mb-0" id="dayModalTitle">Detalle</h5>
                <span class="day-chip" id="dayModalType">â€”</span>
                <span class="chip chip-danger d-none" id="blockedChip"><i class="bi bi-slash-circle me-1"></i>Bloqueado</span>
              </div>
              <div class="text-muted mt-1" style="font-size:.95rem;" id="daySubtitle">Lo que toca hoy.</div>
            </div>

            <div class="d-flex align-items-center gap-2 flex-wrap">
              <!-- âœ… BOTÃ“N PREMIUM â€œNO PUEDO ENTRENARâ€ -->
              <button class="btn btn-sm btn-outline-danger" type="button" id="cantTrainBtn" onclick="toggleAvailabilityPanel(true)">
                <i class="bi bi-slash-circle me-1"></i> No puedo entrenar
              </button>

              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" id="didTrain">
                <label class="form-check-label text-muted" for="didTrain">Hoy entrenÃ©</label>
              </div>

              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
          </div>

          <!-- Progreso -->
          <div class="glass p-2 mt-3" style="border-radius:16px;">
            <div class="d-flex justify-content-between align-items-center px-2">
              <div class="day-section-title" style="margin:0;">Progreso</div>
              <div class="text-muted" style="font-weight:900;" id="progressLabel">â€”</div>
            </div>
            <div class="progress mt-2" style="height:10px;border-radius:999px; overflow:hidden;">
              <div class="progress-bar" id="progressBar" style="width:0%"></div>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-body">
        <div class="row g-3">

          <!-- IZQUIERDA -->
          <div class="col-lg-4">
            <div class="day-section" id="planSection">
              <div class="day-section-title">Plan</div>

              <div class="plan-card" id="warmupCard">
                <div class="plan-k">ActivaciÃ³n</div>
                <div class="plan-v" id="planWarmup">â€”</div>
              </div>

              <!-- âœ… SESIÃ“N EN EL MEDIO (solo run/bike/swim) -->
              <div class="day-section d-none mt-2" id="midSessionSection">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                  <div>
                    <div class="day-section-title" style="margin:0;">Principal</div>
                    <div class="text-muted" id="blocksMetaMid">â€”</div>
                  </div>
                </div>
                <div id="dayBlocksMid" class="blocks-wrap">
                  <div class="text-muted">â€”</div>
                </div>
              </div>

              <div class="plan-card" id="finisherCard">
                <div class="plan-k">Enfriamiento</div>
                <div class="plan-v" id="planFinisher">â€”</div>
              </div>

              <div class="text-muted mt-2" style="font-size:.92rem;">
                SeguÃ­ el orden: activaciÃ³n â†’ principal â†’ enfriamiento.
              </div>
            </div>

            <!-- âœ… DISPONIBILIDAD (colapsado, premium) -->
            <div class="day-section mt-3 d-none" id="availabilityPanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="day-section-title" style="margin:0;">Disponibilidad</div>
                <span class="badge bg-secondary" id="availBadge">â€”</span>
              </div>

              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="noPuedoToggle">
                <label class="form-check-label text-muted" for="noPuedoToggle">No puedo entrenar este dÃ­a</label>
              </div>

              <textarea class="form-control mt-2" id="noPuedoText"
                        placeholder="Ej: viaje / lesiÃ³n / trabajo / etc (corto)"></textarea>

              <div class="d-grid mt-2">
                <button class="btn btn-outline-danger" type="button" onclick="saveAvailability()">
                  Guardar bloqueo
                </button>
              </div>

              <div class="text-muted mt-2" style="font-size:.9rem;">
                Si bloqueÃ¡s el dÃ­a, el coach lo verÃ¡ en rojo y no planifica.
              </div>
            </div>
          </div>

          <!-- DERECHA -->
          <div class="col-lg-8">

            <!-- âœ… SESIÃ“N NORMAL (fuerza/tabata y resto) -->
            <div class="day-section" id="sessionRightSection">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                <div>
                  <div class="day-section-title">SesiÃ³n</div>
                  <div class="text-muted" id="blocksMeta">â€”</div>
                </div>
              </div>

              <div id="dayBlocks" class="blocks-wrap">
                <div class="text-muted">Cargando...</div>
              </div>
            </div>

            <!-- EJERCICIOS (solo fuerza al abrir) -->
            <div class="day-section mt-3 d-none" id="strengthSection">
              <div class="day-section-title">Ejercicios</div>
              <div id="strengthItems" class="row g-3"></div>
            </div>

            <div class="day-section mt-3">
              <div class="day-section-title">QuÃ© hiciste</div>
              <textarea class="form-control mb-2" id="doneNote" placeholder="EscribÃ­ breve: cÃ³mo te sentiste, cargas, tiempos, etc..."></textarea>

              <div class="d-grid">
                <button class="btn btn-primary" onclick="saveLog()">
                  ðŸ’¾ Guardar
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.day-modal{
  background: radial-gradient(circle at 50% 20%, #111 0%, #000 90%) !important;
  color: rgba(255,255,255,.92);
}
.day-modal .modal-body{ background: transparent; }

.day-chip{
  border: 1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
  border-radius: 999px;
  padding: 6px 10px;
  font-weight: 900;
  font-size: .82rem;
  letter-spacing:.06em;
}

.chip{
  border-radius:999px;
  padding:6px 10px;
  font-weight:900;
  font-size:.82rem;
  letter-spacing:.06em;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(255,255,255,.06);
}
.chip-danger{
  border-color: rgba(255,59,48,.55);
  background: rgba(255,59,48,.14);
  color: rgba(255,255,255,.92);
}

.day-section{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius: 18px;
  padding: 12px;
}
.day-section-title{
  font-weight: 950;
  letter-spacing: .14em;
  text-transform: uppercase;
  font-size: .78rem;
  color: rgba(255,255,255,.72);
  margin-bottom: 10px;
}

.plan-card{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius: 16px;
  padding: 12px;
  margin-bottom: 10px;
}
.plan-k{
  font-weight: 900;
  letter-spacing: .08em;
  text-transform: uppercase;
  color: rgba(255,255,255,.72);
  font-size: .78rem;
}
.plan-v{
  margin-top: 6px;
  font-size: 1.00rem;
  font-weight: 800;
  color: rgba(255,255,255,.92);
  white-space: pre-line;
}

.blocks-wrap{ display:grid; gap:12px; }

.block-card{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius: 18px;
  padding: 12px;
}
.block-head{
  display:flex;
  justify-content: space-between;
  align-items:flex-start;
  gap:10px;
}
.block-left{ display:flex; gap:10px; align-items:flex-start; }
.block-icon{
  width:40px;height:40px;border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.04);
  display:flex;align-items:center;justify-content:center;
  flex: 0 0 auto;
}
.block-title{ font-weight: 950; color: rgba(255,255,255,.96); line-height: 1.1; }
.block-sub{
  color: rgba(255,255,255,.72);
  font-weight: 800;
  font-size: .92rem;
  margin-top: 4px;
  line-height: 1.2;
}
.block-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }

.exercise-card{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  border-radius: 18px;
  overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
  transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
}
.exercise-card.done{
  border-color: rgba(34,197,94,.55) !important;
  background: rgba(34,197,94,.10) !important;
  box-shadow: 0 0 0 2px rgba(34,197,94,.12), 0 10px 30px rgba(0,0,0,.35);
}
.exercise-done-pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding: 6px 10px;
  border-radius: 999px;
  font-weight: 950;
  letter-spacing: .08em;
  font-size: .78rem;
  border: 1px solid rgba(34,197,94,.50);
  background: rgba(34,197,94,.14);
  color: rgba(255,255,255,.95);
}

.exercise-head{
  padding: 10px 12px;
  display:flex;
  justify-content: space-between;
  align-items:flex-start;
  gap:10px;
}
.exercise-name{ font-weight: 900; font-size: 1.02rem; color: rgba(255,255,255,.96); }
.exercise-meta{ font-size:.92rem; color: rgba(255,255,255,.80); font-weight:800; letter-spacing:.02em; }
.exercise-video{ padding: 10px 12px 12px; }
.exercise-video video{
  width:100%;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.18);
  background: rgba(0,0,0,.35);
  min-height: 220px;
  object-fit: cover;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let DAY_MODAL = null;
let CURRENT_DAY = null;
let CURRENT_USER = {{ user.id|int }};

let CURRENT_PAYLOAD = null;
let CURRENT_CHECKS = new Set();

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function decodeHtmlEntities(s){
  const txt = document.createElement("textarea");
  txt.innerHTML = String(s||"");
  return txt.value;
}
function cleanText(s){
  let out = decodeHtmlEntities(s);
  if(out.includes("&") || out.includes("&#")){
    out = decodeHtmlEntities(out);
  }
  return out;
}

function badgeHtml(type){
  const t = (type||"").toUpperCase();
  const map = {
    "TABATA": "bg-danger",
    "FUERZA": "bg-info",
    "RUN": "bg-success",
    "BIKE": "bg-warning text-dark",
    "SWIM": "bg-primary",
    "FREE": "bg-secondary",
    "NOTE": "bg-light text-dark"
  };
  const cls = map[t] || "bg-secondary";
  return `<span class="badge ${cls}" style="font-weight:900; letter-spacing:.06em;">${escapeHtml(t||"BLOQUE")}</span>`;
}
function typeLabel(type){
  const t = (type||"").toLowerCase();
  if(t === "tabata") return "TABATA";
  if(t === "fuerza") return "FUERZA";
  if(t === "run") return "RUN";
  if(t === "bike") return "BIKE";
  if(t === "swim") return "SWIM";
  if(t === "free") return "FREE";
  if(t === "note") return "NOTE";
  return (type||"BLOQUE").toUpperCase();
}

/* =========================
   DISPONIBILIDAD (UI)
========================= */
function setAvailUI(puede, comentario){
  const toggle = document.getElementById("noPuedoToggle");
  const text = document.getElementById("noPuedoText");
  const badge = document.getElementById("availBadge");

  const blocked = (String(puede || "si") === "no");
  toggle.checked = blocked;
  text.value = comentario || "";

  if(blocked){
    badge.className = "badge bg-danger";
    badge.textContent = "NO PUEDE";
    document.getElementById("blockedChip").classList.remove("d-none");
    document.getElementById("cantTrainBtn").classList.add("active");
  }else{
    badge.className = "badge bg-success";
    badge.textContent = "OK";
    document.getElementById("blockedChip").classList.add("d-none");
    document.getElementById("cantTrainBtn").classList.remove("active");
  }
}

function toggleAvailabilityPanel(forceOpen){
  const panel = document.getElementById("availabilityPanel");
  const open = !panel.classList.contains("d-none");
  if(forceOpen || !open){
    panel.classList.remove("d-none");
    panel.scrollIntoView({behavior:"smooth", block:"start"});
  }else{
    panel.classList.add("d-none");
  }
}

async function saveAvailability(){
  const noPuedo = document.getElementById("noPuedoToggle").checked;
  const comentario = document.getElementById("noPuedoText").value || "";

  const payload = { user_id: CURRENT_USER, fecha: CURRENT_DAY, no_puedo: noPuedo, comentario };

  try{
    const res = await fetch("/athlete/save_availability", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || "Error");

    setAvailUI(noPuedo ? "no" : "si", comentario);

    // pintar celda del mes si estÃ¡ visible
    const cell = document.querySelector(`.month-cell[data-date="${CSS.escape(CURRENT_DAY)}"]`);
    if(cell){
      if(noPuedo) cell.classList.add("blocked");
      else cell.classList.remove("blocked");
    }

    alert("âœ… Guardado");
  }catch(err){
    console.error(err);
    alert("Error guardando disponibilidad: " + err.message);
  }
}

/* =========================
   BLOQUES
========================= */
function renderBlocksInto(elId, blocks){
  const wrap = document.getElementById(elId);
  wrap.innerHTML = "";

  const arr = Array.isArray(blocks) ? blocks : [];
  if(!arr.length){
    wrap.innerHTML = `<div class="text-muted">No hay sesiÃ³n definida para este dÃ­a.</div>`;
    return;
  }

  arr.forEach((b, idx) => {
    const type = (b.type || "").toLowerCase();
    const ok = b.ok !== false;

    let icon = "bi-grid";
    if(type === "tabata"){ icon = "bi-lightning-charge-fill"; }
    if(type === "run"){ icon = "bi-person-running"; }
    if(type === "bike"){ icon = "bi-bicycle"; }
    if(type === "swim"){ icon = "bi-water"; }
    if(type === "free"){ icon = "bi-wind"; }
    if(type === "note"){ icon = "bi-chat-left-text"; }
    if(type === "fuerza"){ icon = "bi-barbell"; }

    const div = document.createElement("div");
    div.className = "block-card";

    if(!ok){
      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-warning"></i></div>
            <div>
              <div class="block-title">${typeLabel(b.type)}</div>
              <div class="block-sub text-warning">${escapeHtml(b.error || "Bloque invÃ¡lido")}</div>
            </div>
          </div>
          ${badgeHtml(typeLabel(b.type))}
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "fuerza"){
      const rname = cleanText(b.rutina?.nombre || "Fuerza");
      const itemsCount = Array.isArray(b.items) ? b.items.length : 0;
      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
            <div>
              <div class="block-title">${escapeHtml(rname)}</div>
              <div class="block-sub">${itemsCount} ejercicio(s) Â· video + check</div>
            </div>
          </div>
          ${badgeHtml("FUERZA")}
        </div>

        <div class="block-actions">
          <button class="btn btn-outline-light" type="button" onclick="toggleStrength(${idx})">
            Ver ejercicios
          </button>
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "tabata"){
      const rname = cleanText(b.rutina?.nombre || "Tabata");
      const work = b.cfg?.work ?? 40;
      const rest = b.cfg?.rest ?? 20;
      const rounds = b.cfg?.rounds ?? (Array.isArray(b.items) ? b.items.length : 0);
      const sets = b.cfg?.sets ?? 1;
      const startUrl = b.start_url || "#";

      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
            <div>
              <div class="block-title">${escapeHtml(rname)}</div>
              <div class="block-sub">${work}s trabajo Â· ${rest}s descanso Â· ${rounds} ejercicios Â· ${sets} set(s)</div>
            </div>
          </div>
          ${badgeHtml("TABATA")}
        </div>
        <div class="block-actions">
          <a class="btn btn-danger" href="${startUrl}" target="_blank" rel="noopener">â–¶ Reproducir</a>
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "run" || type === "bike" || type === "swim" || type === "free" || type === "note"){
      const text = cleanText(b.text || "â€”");
      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
            <div>
              <div class="block-title">${typeLabel(b.type)}</div>
              <div class="block-sub">${escapeHtml(text)}</div>
            </div>
          </div>
          ${badgeHtml(typeLabel(b.type))}
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    div.innerHTML = `
      <div class="block-head">
        <div class="block-left">
          <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
          <div>
            <div class="block-title">${typeLabel(b.type)}</div>
            <div class="block-sub">${escapeHtml(cleanText(b.text || ""))}</div>
          </div>
        </div>
        ${badgeHtml(typeLabel(b.type))}
      </div>
    `;
    wrap.appendChild(div);
  });
}

function updateProgress(){
  const blocks = Array.isArray(CURRENT_PAYLOAD?.blocks) ? CURRENT_PAYLOAD.blocks : [];
  const force = blocks.find(b => (b.type||"").toLowerCase()==="fuerza" && b.ok && Array.isArray(b.items));
  const total = force?.items?.length || 0;
  const done = total ? force.items.filter(it => CURRENT_CHECKS.has(String(it.id))).length : 0;

  const pct = total ? Math.round((done * 100) / total) : 0;
  document.getElementById("progressBar").style.width = pct + "%";
  document.getElementById("progressLabel").textContent = total ? `Hechos ${done} / ${total}` : "â€”";
}

/* =========================
   FUERZA (mostrar/ocultar)
========================= */
function posterDataUrl(title){
  const safe = (title || "VR TRAINING").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="1280" height="720">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#0b0f12"/>
        <stop offset="1" stop-color="#050608"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#g)"/>
    <rect x="40" y="40" width="1200" height="640" rx="36" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.16)"/>
    <circle cx="640" cy="360" r="62" fill="rgba(34,211,238,0.18)" stroke="rgba(34,211,238,0.45)" stroke-width="6"/>
    <polygon points="625,330 625,390 680,360" fill="rgba(255,255,255,0.85)"/>
    <text x="80" y="130" font-size="46" fill="rgba(255,255,255,0.92)" font-family="Arial" font-weight="700">${safe}</text>
    <text x="80" y="180" font-size="26" fill="rgba(255,255,255,0.60)" font-family="Arial">VR Training</text>
  </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function renderStrength(items){
  const wrap = document.getElementById("strengthItems");
  wrap.innerHTML = "";
  if(!items || !items.length){
    wrap.innerHTML = `<div class="text-muted">No hay ejercicios para mostrar.</div>`;
    return;
  }

  function pickWeight(it){
    const w = (it.peso ?? it.kg ?? it.kilos ?? it.weight ?? it.carga ?? it.load ?? null);
    if(w === null || w === undefined) return "";
    const n = String(w).trim();
    if(!n || n === "0" || n.toLowerCase() === "none") return "";
    return n;
  }

  items.forEach(it => {
    const col = document.createElement("div");
    col.className = "col-12";

    const isDone = CURRENT_CHECKS.has(String(it.id));
    const checked = isDone ? "checked" : "";
    const vidSrc = it.video_src || "";
    const poster = posterDataUrl(it.nombre);

    const series = String(it.series || "").trim();
    const reps   = String(it.reps || "").trim();
    const desc   = String(it.descanso || "").trim();
    const nota   = String(it.nota || "").trim();

    const kgVal = pickWeight(it);
    const kgTxt = kgVal ? `${kgVal} kg` : "";

    const parts = [];
    if(series) parts.push(series);
    if(reps) parts.push(reps);
    if(kgTxt) parts.push(kgTxt);
    if(desc) parts.push(`Desc ${desc}`);
    if(nota) parts.push(cleanText(nota));

    col.innerHTML = `
      <div class="exercise-card ${isDone ? "done" : ""}" id="exCard-${it.id}">
        <div class="exercise-head">
          <div>
            <div class="exercise-name">${escapeHtml(cleanText(it.nombre || "Ejercicio"))}</div>
            <div class="exercise-meta">${escapeHtml(parts.join(" Â· ") || "â€”")}</div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <span class="exercise-done-pill ${isDone ? "" : "d-none"}" id="exPill-${it.id}">
              <i class="bi bi-check2-circle"></i> HECHO
            </span>

            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" ${checked}
                     onchange="toggleItem(${it.id}, this.checked)">
            </div>
            <div class="text-muted" style="font-weight:900;letter-spacing:.08em;">HECHO</div>
          </div>
        </div>

        <div class="exercise-video">
          ${vidSrc ? `
            <video controls playsinline webkit-playsinline preload="metadata" poster="${poster}">
              <source src="${vidSrc}" type="video/mp4">
            </video>
          ` : `<div class="text-muted">Sin video</div>`}
        </div>
      </div>
    `;
    wrap.appendChild(col);
  });
}

function toggleStrength(blockIndex){
  const sec = document.getElementById("strengthSection");
  const isHidden = sec.classList.contains("d-none");

  if(isHidden){
    const b = (CURRENT_PAYLOAD && Array.isArray(CURRENT_PAYLOAD.blocks)) ? CURRENT_PAYLOAD.blocks[blockIndex] : null;
    const items = (b && b.ok && Array.isArray(b.items)) ? b.items : [];
    sec.classList.remove("d-none");
    renderStrength(items);
    updateProgress();
    sec.scrollIntoView({behavior:"smooth", block:"start"});
  }else{
    sec.classList.add("d-none");
  }
}

/* =========================
   OPEN DAY + REORDEN RUN/BIKE/SWIM
========================= */
function openDay(isoDate){
  CURRENT_DAY = isoDate;

  if(typeof bootstrap === "undefined"){
    alert("Bootstrap JS no cargÃ³. RevisÃ¡ layout.html (bootstrap.bundle.min.js).");
    return;
  }
  if(!DAY_MODAL){
    DAY_MODAL = new bootstrap.Modal(document.getElementById("dayModal"));
  }

  CURRENT_PAYLOAD = null;
  CURRENT_CHECKS = new Set();

  // reset UI
  document.getElementById("dayModalDate").textContent = isoDate;
  document.getElementById("dayModalTitle").textContent = "Cargando...";
  document.getElementById("dayModalType").textContent = "â€”";
  document.getElementById("daySubtitle").textContent = "Lo que toca hoy.";

  document.getElementById("dayBlocks").innerHTML = `<div class="text-muted">Cargando...</div>`;
  document.getElementById("blocksMeta").textContent = "â€”";

  document.getElementById("dayBlocksMid").innerHTML = `<div class="text-muted">â€”</div>`;
  document.getElementById("blocksMetaMid").textContent = "â€”";

  document.getElementById("strengthSection").classList.add("d-none");
  document.getElementById("strengthItems").innerHTML = "";

  document.getElementById("warmupCard").style.display = "";
  document.getElementById("finisherCard").style.display = "";

  document.getElementById("planWarmup").textContent = "â€”";
  document.getElementById("planFinisher").textContent = "â€”";

  document.getElementById("progressBar").style.width = "0%";
  document.getElementById("progressLabel").textContent = "â€”";

  document.getElementById("blockedChip").classList.add("d-none");

  // availability panel reset (cerrado por defecto)
  document.getElementById("availabilityPanel").classList.add("d-none");
  setAvailUI("si","");

  // default sections visible
  document.getElementById("midSessionSection").classList.add("d-none");
  document.getElementById("sessionRightSection").classList.remove("d-none");

  fetch(`/api/day_detail?user_id=${CURRENT_USER}&fecha=${encodeURIComponent(isoDate)}`)
    .then(r => r.json())
    .then(data => {
      if(!data.ok) throw new Error(data.error || "Error");
      CURRENT_PAYLOAD = data;

      const p = data.plan || {};
      const planType = String(p.plan_type || "").toLowerCase();
      const isEndurance = (planType === "run" || planType === "bike" || planType === "swim");

      document.getElementById("dayModalTitle").textContent = cleanText(data.rutina?.nombre || "Detalle del dÃ­a");
      document.getElementById("dayModalType").textContent = cleanText(p.plan_type || "â€”");

      // warmup / finisher (no mostrar none)
      const warm = cleanText(p.warmup || "");
      if(!warm || warm.toLowerCase()==="none"){
        document.getElementById("warmupCard").style.display = "none";
      }else{
        document.getElementById("planWarmup").textContent = warm;
        document.getElementById("warmupCard").style.display = "";
      }

      const fin = cleanText(p.finisher || "");
      if(!fin || fin.toLowerCase()==="none"){
        document.getElementById("finisherCard").style.display = "none";
      }else{
        document.getElementById("planFinisher").textContent = fin;
        document.getElementById("finisherCard").style.display = "";
      }

      // âœ… disponibilidad desde backend
      setAvailUI(p.puede_entrenar || "si", cleanText(p.comentario_atleta || ""));

      document.getElementById("didTrain").checked = !!data.log?.did_train;
      document.getElementById("doneNote").value = cleanText(data.log?.main_done || "");

      CURRENT_CHECKS = new Set((Array.isArray(data.checks) ? data.checks : []).map(x => String(x)));

      // bloques
      const blocks = Array.isArray(data.blocks) ? data.blocks : [];
      const blocksCount = blocks.length;

      if(isEndurance){
        document.getElementById("midSessionSection").classList.remove("d-none");
        document.getElementById("sessionRightSection").classList.add("d-none");

        document.getElementById("blocksMetaMid").textContent = blocksCount ? `${blocksCount} bloque(s)` : "â€”";
        renderBlocksInto("dayBlocksMid", blocks);
      }else{
        document.getElementById("midSessionSection").classList.add("d-none");
        document.getElementById("sessionRightSection").classList.remove("d-none");

        document.getElementById("blocksMeta").textContent = blocksCount ? `${blocksCount} bloque(s)` : "â€”";
        renderBlocksInto("dayBlocks", blocks);
      }

      // progreso fuerza
      updateProgress();

      DAY_MODAL.show();
    })
    .catch(err => {
      console.error(err);
      alert("Error cargando el dÃ­a: " + err.message);
    });
}

/* =========================
   CHECKS + LOG
========================= */
function toggleItem(itemId, done){
  const form = new FormData();
  form.append("user_id", String(CURRENT_USER));
  form.append("fecha", String(CURRENT_DAY));
  form.append("item_id", String(itemId));
  form.append("done", done ? "1" : "0");

  fetch("/athlete/check_item", { method:"POST", body: form })
    .then(r => r.json())
    .then(j => {
      if(!j.ok) throw new Error(j.error || "Error");

      // estado local
      if(done) CURRENT_CHECKS.add(String(itemId));
      else CURRENT_CHECKS.delete(String(itemId));

      // âœ… UI instantÃ¡nea: verde + pill
      const card = document.getElementById(`exCard-${itemId}`);
      if(card) card.classList.toggle("done", !!done);

      const pill = document.getElementById(`exPill-${itemId}`);
      if(pill) pill.classList.toggle("d-none", !done);

      updateProgress();
    })
    .catch(err => { console.error(err); alert("Error guardando check: " + err.message); });
}

function saveLog(){
  const payload = {
    user_id: CURRENT_USER,
    fecha: CURRENT_DAY,
    did_train: document.getElementById("didTrain").checked,
    warmup_done: "",
    main_done: document.getElementById("doneNote").value || "",
    finisher_done: ""
  };

  fetch("/athlete/save_log", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(j => { if(!j.ok) throw new Error(j.error || "Error"); alert("âœ… Guardado"); })
  .catch(err => { console.error(err); alert("Error guardando: " + err.message); });
}
</script>
{% endblock %}
