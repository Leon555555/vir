{% extends "layout.html" %}
{% block title %}Perfil ‚Äî {{ user.nombre }}{% endblock %}

{% block content %}
<style>
  body{background: radial-gradient(1000px 600px at 10% 0%, rgba(220,30,40,0.15), transparent 50%), #070809;}
  .panel{background:#0e1116;border-radius:18px;padding:20px;box-shadow:0 8px 26px rgba(0,0,0,.35);color:#e9ecef}
  .title{font-weight:700;letter-spacing:.3px}
  .day-button{
    background:#13181f;border:1px solid rgba(255,255,255,.07);
    border-radius:12px; padding:16px 12px; color:#eee; font-weight:600;
    cursor:pointer; transition:.15s; text-align:center;
  }
  .day-button:hover{background:#1a1f27}
  .day-button.fuerza{border-left:4px solid #e63946;}
  .day-button.correr{border-left:4px solid #12fff7;}
  .day-button.natacion{border-left:4px solid #1f78ff;}
  .day-button.bike{border-left:4px solid #f5a623;}
  .day-button.fisioterapia{border-left:4px solid #a020f0;}
  .day-button.descanso{border-left:4px solid #555;}
  .day-title{font-size:1rem;font-weight:600;}
  .collapse-box{background:#10141a;border-radius:12px;margin-top:10px;padding:14px 18px;border:1px solid rgba(255,255,255,.06);}
  .form-control-sm{background:#0b0f14;border:none;color:#eee;}
  .btn-vir{background:#e63946;border:none;font-weight:700}
  .btn-vir:hover{background:#be2f3a}
</style>

<!-- Header -->
<div class="panel mb-4">
  <div class="d-flex align-items-center justify-content-between">
    <div>
      <h3 class="mb-1">{{ user.nombre }}</h3>
      <div class="text-secondary small">{{ user.email }}{% if user.grupo %} ‚Ä¢ Grupo: {{ user.grupo }}{% endif %}</div>
    </div>
    <a href="{{ url_for('main.logout') }}" class="btn btn-outline-light btn-sm"><i class="bi bi-box-arrow-right"></i> Salir</a>
  </div>
</div>

<!-- Semana -->
<div class="panel">
  <div class="title mb-3"><i class="bi bi-calendar-week"></i> Semana actual</div>
  <div class="row g-3 text-center">
    {% for f in fechas %}
      {% set plan = planes[f] %}
      <div class="col-6 col-md-3 col-lg-1-7">
        <div class="day-button {{ plan.plan_type }}" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}">
          <div>{{ ["Lun","Mar","Mi√©","Jue","Vie","S√°b","Dom"][loop.index0] }}</div>
          <div class="day-title mt-1">
            {% if plan.plan_type == "fuerza" %}Fuerza
            {% elif plan.plan_type == "correr" %}Correr
            {% elif plan.plan_type == "natacion" %}Nataci√≥n
            {% elif plan.plan_type == "bike" %}Bike
            {% elif plan.plan_type == "fisioterapia" %}Fisio
            {% else %}Descanso{% endif %}
          </div>
        </div>

        <div class="collapse mt-2" id="collapse{{ loop.index }}">
          <div class="collapse-box text-start">
            <form method="POST" action="{{ url_for('main.save_day') }}">
              <input type="hidden" name="user_id" value="{{ user.id }}">
              <input type="hidden" name="fecha" value="{{ f.strftime('%Y-%m-%d') }}">
              
              <label class="form-label small text-secondary">Tipo de d√≠a</label>
              <select class="form-select form-select-sm mb-2" name="plan_type">
                {% for val,label in [("fuerza","Fuerza"),("correr","Correr"),("natacion","Nataci√≥n"),("bike","Bike"),("fisioterapia","Fisioterapia"),("descanso","Descanso")] %}
                  <option value="{{ val }}" {% if plan.plan_type==val %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>

              <label class="small text-secondary">Calentamiento</label>
              <textarea class="form-control form-control-sm mb-2" name="warmup" rows="2">{{ plan.warmup or "" }}</textarea>
              <label class="small text-secondary">Entrenamiento</label>
              <textarea class="form-control form-control-sm mb-2" name="main" rows="3">{{ plan.main or "" }}</textarea>
              <label class="small text-secondary">Bloque final</label>
              <textarea class="form-control form-control-sm mb-3" name="finisher" rows="2">{{ plan.finisher or "" }}</textarea>
              <div class="text-end">
                <button class="btn btn-vir btn-sm"><i class="bi bi-save"></i> Guardar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Line Chart -->
<div class="panel mt-4">
  <div class="title mb-2"><i class="bi bi-graph-up"></i> Propuesto vs Realizado</div>
  <canvas id="lineChart" height="90"></canvas>
</div>

<!-- Rutinas de fuerza -->
<div class="panel mt-4">
  <div class="title mb-3"><i class="bi bi-lightning-charge"></i> Rutinas de fuerza</div>
  <div class="row g-3">
    {% for r in rutinas %}
      <div class="col-md-4">
        <div class="card bg-dark text-light border-0 shadow-lg h-100" style="border-radius: 18px;">
          <img src="{{ r.imagen_url or 'https://images.unsplash.com/photo-1517963628607-235ccdd5476a?q=80&w=1600&auto=format&fit=crop' }}" 
               class="card-img-top" style="height: 160px; object-fit: cover; border-radius: 18px 18px 0 0;">
          <div class="card-body">
            <h5 class="card-title">{{ r.titulo }}</h5>
            <p class="text-secondary small">{{ r.descripcion or "Sesi√≥n de fuerza general." }}</p>
            <a href="#" class="btn btn-outline-light btn-sm w-100" onclick="alert('Versi√≥n IA de rutina con video ü§ñ');">Ver detalles</a>
          </div>
        </div>
      </div>
    {% else %}
      <p class="text-secondary">No hay rutinas configuradas.</p>
    {% endfor %}
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('lineChart').getContext('2d');
new Chart(ctx, {
  type: 'line',
  data: {
    labels: {{ labels|tojson }},
    datasets: [
      {
        label: 'Propuesto',
        data: {{ propuesto|tojson }},
        borderColor: '#e63946',
        backgroundColor: 'rgba(230,57,70,.15)',
        borderWidth: 3,
        tension: .35
      },
      {
        label: 'Realizado',
        data: {{ realizado|tojson }},
        borderColor: '#12fff7',
        backgroundColor: 'rgba(18,255,247,.12)',
        borderWidth: 3,
        tension: .35
      }
    ]
  },
  options: {
    plugins: { legend: { labels: { color: '#cfd4da' } } },
    scales: {
      x: { ticks:{ color:'#9aa3ac' }, grid:{ color:'rgba(255,255,255,.06)' } },
      y: { ticks:{ color:'#9aa3ac' }, grid:{ color:'rgba(255,255,255,.06)' }, beginAtZero:true }
    }
  }
});
</script>
{% endblock %}
