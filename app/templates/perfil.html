{% extends "layout.html" %}
{% block title %}Perfil ‚Äî {{ user.nombre }}{% endblock %}

{% block content %}
<div class="container mt-3">

  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <div>
      <h2 class="mb-0 text-light">üë§ {{ user.nombre }}</h2>
      <div class="text-muted">
        {{ user.email }}
        {% if user.grupo %} ¬∑ <span class="badge bg-secondary">{{ user.grupo }}</span>{% endif %}
      </div>
      <div class="text-muted mt-1">Semana: <strong>{{ semana_str }}</strong></div>
    </div>

    <div class="d-flex gap-2 align-items-center">
      <form method="GET" class="d-flex gap-2">
        <input class="form-control" type="date" name="center" value="{{ center.isoformat() if center else '' }}">
        <button class="btn btn-outline-info" type="submit">Ver semana</button>
      </form>

      {% if admin_ok %}
        <a class="btn btn-outline-light"
           href="{{ url_for('main.coach_planificador', user_id=user.id, center=center.isoformat() if center else '') }}">
          üß† Planificar
        </a>
      {% endif %}
    </div>
  </div>

  <div class="row g-3">
    {% for f in fechas %}
      {% set plan = planes[f] %}
      {% set fecha_id = f.isoformat() %}
      {% set st = day_status.get(f, {}) %}
      {% set completed = st.get("completed", False) %}
      {% set done = st.get("done", 0) %}
      {% set total = st.get("total", 0) %}

      <div class="col-md-6 col-lg-4">
        <div class="card p-3 day-card">

          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <div class="day-title">{{ f.strftime('%A %d/%m')|upper }}</div>
              <div class="small text-muted">
                <span class="badge bg-secondary">{{ plan.plan_type }}</span>

                {% if completed %}
                  <span class="badge bg-success ms-1">Completado</span>
                {% endif %}

                {% if plan.puede_entrenar == "no" %}
                  <span class="badge bg-danger ms-1">Bloqueado</span>
                {% endif %}
              </div>
            </div>

            <button class="btn btn-sm btn-outline-info"
                    type="button"
                    onclick="openDayDetail({{ user.id }}, '{{ fecha_id }}')">
              Ver detalle
            </button>
          </div>

          <div class="preview-box">
            {% if plan.plan_type|lower == "fuerza" %}
              {% set r = rutina_by_day[f] %}
              {% if r %}
                <div class="fw-bold text-light">üèãÔ∏è Rutina: {{ r.nombre }}</div>
                <div class="small text-muted">Marc√° cada ejercicio dentro del detalle.</div>
              {% else %}
                <div class="text-muted">No hay rutina asignada.</div>
              {% endif %}

            {% elif plan.plan_type|lower == "descanso" %}
              <div class="text-muted">üßò Descanso / recuperaci√≥n.</div>

            {% else %}
              <div class="small text-muted mb-2">Objetivo del d√≠a</div>
              <div class="text-light preview-text">{{ plan.main or "‚Äî" }}</div>
              {% if plan.warmup %}
                <div class="small mt-2"><span class="badge bg-dark border border-secondary">Warmup</span>
                  <span class="text-muted ms-1">{{ plan.warmup }}</span>
                </div>
              {% endif %}
              {% if plan.finisher %}
                <div class="small mt-2"><span class="badge bg-dark border border-secondary">Finisher</span>
                  <span class="text-muted ms-1">{{ plan.finisher }}</span>
                </div>
              {% endif %}
            {% endif %}
          </div>

          <!-- ‚úÖ PROGRESO (gamificaci√≥n light A) -->
          {% if plan.plan_type|lower == "fuerza" and total > 0 %}
            <div class="mt-3">
              <div class="d-flex justify-content-between small text-muted">
                <span>Progreso</span>
                <span>{{ done }}/{{ total }}</span>
              </div>
              <div class="progress progress-dark mt-1">
                <div class="progress-bar" role="progressbar"
                     style="width: {{ (done * 100 // total) if total else 0 }}%;"></div>
              </div>
            </div>
          {% elif plan.plan_type|lower != "descanso" %}
            <div class="mt-3 small text-muted">
              Estado: <span class="badge {{ 'bg-success' if completed else 'bg-secondary' }}">
                {{ 'Completado' if completed else 'Pendiente' }}
              </span>
            </div>
          {% endif %}

          <div class="mt-3 d-flex justify-content-between align-items-center">
            <div class="small text-muted">Score propuesto</div>
            <div class="badge bg-dark border border-secondary">{{ plan.propuesto_score or 0 }}</div>
          </div>

        </div>
      </div>
    {% endfor %}
  </div>

</div>

<!-- Modal full screen (usa /api/day_detail) -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content modal-dark">
      <div class="modal-header">
        <div>
          <h5 class="modal-title mb-0" id="dayModalTitle">Detalle del d√≠a</h5>
          <div class="small text-muted" id="dayModalSubtitle">‚Äî</div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="dayModalBody">
          <div class="text-center py-5" id="dayLoading">
            <div class="spinner-border text-info" role="status"></div>
            <div class="text-muted mt-2">Cargando...</div>
          </div>

          <div class="row g-3 d-none" id="dayContent">
            <div class="col-lg-6">
              <div class="card p-3 panel-box">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0 text-info">üìå Plan del d√≠a</h6>
                  <span class="badge bg-secondary" id="planTypeBadge">‚Äî</span>
                </div>

                <div class="small text-muted">Warmup</div>
                <pre class="pre-box" id="planWarmup">‚Äî</pre>

                <div class="small text-muted mt-2">Bloque principal</div>
                <pre class="pre-box" id="planMain">‚Äî</pre>

                <div class="small text-muted mt-2">Finisher</div>
                <pre class="pre-box" id="planFinisher">‚Äî</pre>

                <hr style="border-color:rgba(255,255,255,.08)">

                <div class="d-flex justify-content-between align-items-center">
                  <div class="text-muted small">¬øEntrenaste hoy?</div>
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="didTrainToggle">
                    <label class="form-check-label small" for="didTrainToggle">S√≠</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-lg-6">
              <div class="card p-3 panel-box">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="mb-0 text-info">‚úÖ Ejecuci√≥n / Check</h6>
                  <span class="badge bg-dark border border-secondary" id="rutinaName">‚Äî</span>
                </div>

                <!-- ‚úÖ barra progreso dentro del modal (Fuerza) -->
                <div id="modalProgressWrap" class="d-none">
                  <div class="d-flex justify-content-between small text-muted">
                    <span>Progreso</span>
                    <span id="modalProgressText">0/0</span>
                  </div>
                  <div class="progress progress-dark mt-1 mb-2">
                    <div class="progress-bar" id="modalProgressBar" role="progressbar" style="width:0%"></div>
                  </div>
                </div>

                <div id="strengthBox" class="d-none">
                  <div id="itemsList" class="items-list"></div>
                </div>

                <div id="enduranceBox" class="d-none">
                  <div class="small text-muted mb-1">Warmup realizado</div>
                  <textarea class="form-control area-dark" id="warmupDone" rows="3"></textarea>

                  <div class="small text-muted mt-2 mb-1">Bloque principal realizado</div>
                  <textarea class="form-control area-dark" id="mainDone" rows="4"></textarea>

                  <div class="small text-muted mt-2 mb-1">Finisher / Enfriamiento</div>
                  <textarea class="form-control area-dark" id="finisherDone" rows="3"></textarea>
                </div>

                <div class="d-grid mt-3">
                  <button class="btn btn-info" onclick="saveDayLog()">üíæ Guardar lo realizado</button>
                </div>
                <div class="small text-muted mt-2" id="saveHint">Guard√° para llevar registro y mejorar progresi√≥n.</div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

<style>
.day-card{
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 18px;
  box-shadow: 0 10px 40px rgba(0,0,0,.35);
}
.day-title{font-weight:800; letter-spacing:.06em;}
.preview-box{
  padding: 12px;
  border-radius: 14px;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.06);
}
.preview-text{white-space:pre-wrap; opacity:.95}
.modal-dark{
  background: radial-gradient(circle at 50% 20%, #111 0%, #000 90%);
  color:#fff;
}
.panel-box{
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 18px;
}
.pre-box{
  white-space: pre-wrap;
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  padding: 10px;
  margin: 0;
  color: #fff;
  min-height: 52px;
}
.area-dark{
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.10);
  color:#fff;
  border-radius: 14px;
}
.items-list{display:flex;flex-direction:column;gap: 10px;}
.item-row{
  background: rgba(0,0,0,.22);
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px;
  padding: 12px;
}
.item-top{display:flex;justify-content:space-between;align-items:flex-start;gap:10px;}
.item-name{font-weight:800}
.item-meta{font-size:.9rem; color:rgba(255,255,255,.75)}
.video-wrap{margin-top:10px;border-radius: 14px;overflow:hidden;border: 1px solid rgba(255,255,255,.08);}
video{width:100%; max-height:360px; background:#000}
.progress-dark{height:10px;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
.progress-bar{background:#22d3ee;}
</style>
{% endblock %}

{% block extra_js %}
<script>
let CURRENT_DAY = { user_id: null, fecha: null, plan_type: null, items_total: 0, done_count: 0 };

function escapeHtml(s){
  return (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function setText(id, txt){
  const el = document.getElementById(id);
  if (el) el.textContent = txt ?? "‚Äî";
}
function show(elId){ document.getElementById(elId)?.classList.remove("d-none"); }
function hide(elId){ document.getElementById(elId)?.classList.add("d-none"); }

function updateModalProgress(){
  const total = CURRENT_DAY.items_total || 0;
  const done = CURRENT_DAY.done_count || 0;
  if(total <= 0){
    hide("modalProgressWrap");
    return;
  }
  show("modalProgressWrap");
  setText("modalProgressText", `${done}/${total}`);
  const pct = Math.floor((done * 100) / total);
  const bar = document.getElementById("modalProgressBar");
  if(bar) bar.style.width = `${pct}%`;
}

async function openDayDetail(userId, fecha){
  CURRENT_DAY.user_id = userId;
  CURRENT_DAY.fecha = fecha;
  CURRENT_DAY.items_total = 0;
  CURRENT_DAY.done_count = 0;

  const modal = new bootstrap.Modal(document.getElementById("dayModal"));
  modal.show();

  hide("dayContent");
  show("dayLoading");
  document.getElementById("itemsList").innerHTML = "";
  document.getElementById("strengthBox").classList.add("d-none");
  document.getElementById("enduranceBox").classList.add("d-none");
  hide("modalProgressWrap");

  setText("dayModalSubtitle", `${fecha}`);
  setText("rutinaName", "‚Äî");

  try{
    const url = `/api/day_detail?user_id=${encodeURIComponent(userId)}&fecha=${encodeURIComponent(fecha)}`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.ok){
      alert(data.error || "Error cargando el d√≠a");
      return;
    }

    const plan = data.plan || {};
    CURRENT_DAY.plan_type = (plan.plan_type || "").toLowerCase().trim();

    setText("planTypeBadge", plan.plan_type || "‚Äî");
    setText("planWarmup", plan.warmup || "‚Äî");
    setText("planMain", plan.main || "‚Äî");
    setText("planFinisher", plan.finisher || "‚Äî");

    const log = data.log || {};
    document.getElementById("didTrainToggle").checked = !!log.did_train;

    const isStrength = (CURRENT_DAY.plan_type === "fuerza");

    if(isStrength){
      document.getElementById("strengthBox").classList.remove("d-none");
      document.getElementById("enduranceBox").classList.add("d-none");

      const rutina = data.rutina;
      setText("rutinaName", rutina?.nombre || "Sin rutina");

      const items = data.items || [];
      const doneIds = new Set((data.checks || []).map(x => Number(x)));

      CURRENT_DAY.items_total = items.length;
      CURRENT_DAY.done_count = 0;
      items.forEach(it => { if(doneIds.has(Number(it.id))) CURRENT_DAY.done_count += 1; });
      updateModalProgress();

      const list = document.getElementById("itemsList");
      list.innerHTML = items.map(it => {
        const id = Number(it.id);
        const checked = doneIds.has(id) ? "checked" : "";
        const metaParts = [];
        if(it.series) metaParts.push(`${escapeHtml(it.series)} series`);
        if(it.reps) metaParts.push(`${escapeHtml(it.reps)} reps`);
        if(it.descanso) metaParts.push(`desc ${escapeHtml(it.descanso)}`);
        const meta = metaParts.length ? metaParts.join(" ¬∑ ") : "‚Äî";
        const video = it.video_url
          ? `<div class="video-wrap">
               <video controls preload="metadata">
                 <source src="/static/${encodeURIComponent(it.video_url)}" type="video/mp4">
               </video>
             </div>`
          : "";
        const nota = it.nota ? `<div class="small text-muted mt-2">Nota: ${escapeHtml(it.nota)}</div>` : "";

        return `
          <div class="item-row">
            <div class="item-top">
              <div>
                <div class="item-name">${escapeHtml(it.nombre || "")}</div>
                <div class="item-meta">${meta}</div>
                ${nota}
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" ${checked}
                       onchange="toggleItem(${userId}, '${fecha}', ${id}, this.checked)">
                <label class="form-check-label small">Hecho</label>
              </div>
            </div>
            ${video}
          </div>
        `;
      }).join("");

    } else {
      document.getElementById("strengthBox").classList.add("d-none");
      document.getElementById("enduranceBox").classList.remove("d-none");

      document.getElementById("warmupDone").value = log.warmup_done || "";
      document.getElementById("mainDone").value = log.main_done || "";
      document.getElementById("finisherDone").value = log.finisher_done || "";
    }

    hide("dayLoading");
    show("dayContent");
  } catch(e){
    console.error(e);
    alert("Error cargando detalle");
  }
}

async function toggleItem(userId, fecha, itemId, done){
  const fd = new FormData();
  fd.append("user_id", userId);
  fd.append("fecha", fecha);
  fd.append("item_id", itemId);
  fd.append("done", done ? "1" : "0");

  const res = await fetch("/athlete/check_item", { method:"POST", body: fd });
  const data = await res.json();
  if(!data.ok){
    alert(data.error || "Error guardando check");
    return;
  }

  // actualizar barra modal
  CURRENT_DAY.done_count += done ? 1 : -1;
  if(CURRENT_DAY.done_count < 0) CURRENT_DAY.done_count = 0;
  updateModalProgress();
}

async function saveDayLog(){
  const payload = {
    user_id: CURRENT_DAY.user_id,
    fecha: CURRENT_DAY.fecha,
    did_train: document.getElementById("didTrainToggle").checked,
    warmup_done: document.getElementById("warmupDone")?.value || "",
    main_done: document.getElementById("mainDone")?.value || "",
    finisher_done: document.getElementById("finisherDone")?.value || ""
  };

  const res = await fetch("/athlete/save_log", {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if(data.ok){
    document.getElementById("saveHint").textContent = "‚úÖ Guardado. Perfecto.";
  } else {
    alert(data.error || "Error guardando");
  }
}
</script>
{% endblock %}
