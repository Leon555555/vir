{% extends "layout.html" %}
{% block title %}Perfil ‚Äî VR Training{% endblock %}

{# ============================================================
   ‚úÖ Macro: icono + texto para plan_type
============================================================ #}
{% macro activity_badge(plan_type, size='') %}
  {% set raw = (plan_type or 'Descanso') %}
  {% set t = raw|string %}
  {% set norm = t|lower %}

  {% if norm in ['swim','natacion','nataci√≥n'] %}
    {% set icon = 'icons/natacion.png' %}
    {% set label = 'Nataci√≥n' %}
  {% elif norm in ['pista','run_pista','track'] %}
    {% set icon = 'icons/pista.png' %}
    {% set label = 'Pista' %}
  {% elif norm in ['run','running'] %}
    {% set icon = 'icons/run.png' %}
    {% set label = 'Run' %}
  {% elif norm in ['bike','bici','cycling'] %}
    {% set icon = 'icons/bike.png' %}
    {% set label = 'Bike' %}
  {% elif norm in ['fuerza','strength','gym'] %}
    {% set icon = 'icons/fuerza.png' %}
    {% set label = 'Fuerza' %}
  {% elif norm in ['descanso','rest','recovery','off'] %}
    {% set icon = 'icons/descanso.png' %}
    {% set label = 'Descanso' %}
  {% else %}
    {% set icon = 'icons/descanso.png' %}
    {% set label = t %}
  {% endif %}

  <span class="vr-activity-badge {% if size=='sm' %}sm{% endif %}">
    <img class="vr-activity-icon" src="{{ url_for('static', filename=icon) }}" alt="{{ label }}">
    <span class="vr-activity-text">{{ label }}</span>
  </span>
{% endmacro %}

{% block content %}
<div class="container mt-4">

  {# ============================================================
     HERO PERFIL
  ============================================================ #}
  <div class="card glass profile-hero mb-3">
    <div class="row g-3 align-items-center">
      <div class="col-md-7 d-flex align-items-center gap-3">
        <div class="vr-avatar profile-avatar">
          <i class="bi bi-person-fill text-info"></i>
        </div>

        <div>
          <div class="profile-hero-label">ATLETA</div>
          <h2 class="profile-hero-name mb-1">{{ user.nombre }}</h2>
          <div class="profile-hero-email">{{ user.email }}</div>

          <div class="mt-3 d-flex flex-wrap gap-2">
            {% if strava_account %}
              <span class="badge bg-success profile-pill">
                üü† Strava conectado
              </span>
            {% else %}
              <a href="{{ url_for('main.strava_connect') }}"
                 class="btn btn-sm btn-strava">
                <i class="bi bi-link-45deg me-1"></i> Conectar con Strava
              </a>
            {% endif %}

            {% if admin_ok %}
              <a class="btn btn-sm btn-outline-light profile-pill-btn"
                 href="{{ url_for('main.coach_planificador', user_id=user.id) }}">
                <i class="bi bi-calendar3 me-1"></i> Planificar semana
              </a>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-md-5">
        <div class="d-flex flex-wrap gap-2 justify-content-md-end">
          <div class="mini-stat hero-stat">
            <div class="mini-title">RACHA</div>
            <div class="mini-value">üî• {{ streak }}</div>
            <div class="mini-foot">D√≠as seguidos entrenando</div>
          </div>

          <div class="mini-stat hero-stat">
            <div class="mini-title">SEMANA</div>
            <div class="mini-value">
              ‚úÖ {{ week_done }} / {{ week_goal }}
            </div>
            <div class="progress mt-2">
              {% set pct = 0 if week_goal==0 else (week_done*100//week_goal) %}
              <div class="progress-bar" style="width: {{ pct }}%"></div>
            </div>
            <div class="mini-foot">Objetivo semanal</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# ============================================================
     TABS
  ============================================================ #}
  <div class="d-flex gap-2 flex-wrap mb-3 profile-tabs">
    <a class="btn btn-sm {% if view=='today' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='today') }}">Hoy</a>

    <a class="btn btn-sm {% if view=='week' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=center.isoformat()) }}">Semana</a>

    <a class="btn btn-sm {% if view=='month' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='month', center=center.isoformat()) }}">Mes</a>

    <a class="btn btn-sm {% if view=='progress' %}btn-info{% else %}btn-outline-light{% endif %}"
       href="{{ url_for('main.perfil_usuario', user_id=user.id, view='progress', center=center.isoformat()) }}">Progreso</a>

    <div class="ms-auto d-none d-md-flex">
      {% if view == 'today' %}
        <a class="btn btn-sm btn-outline-light"
           href="{{ url_for('main.perfil_redirect') }}">
          <i class="bi bi-arrow-left"></i> Volver
        </a>
      {% else %}
        <a class="btn btn-sm btn-outline-light"
           href="{{ url_for('main.perfil_redirect') }}">
          <i class="bi bi-arrow-left"></i> Volver
        </a>
      {% endif %}
    </div>
  </div>

  {# ============================================================
     HOY
  ============================================================ #}
  {% if view == 'today' %}
    <div class="card glass today-card p-3 p-md-4 mb-3">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
          <div class="vr-kicker mb-1">HOY</div>
          <div class="d-flex flex-wrap align-items-center gap-2">
            <div class="today-date">
              {{ hoy.strftime('%A %d/%m')|upper }}
            </div>
            {{ activity_badge(plan_hoy.plan_type, 'sm') }}
          </div>
          <div class="text-muted mt-2">
            Entr√° y marc√° lo que hiciste para seguir sumando racha.
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-info btn-lg px-4" type="button"
                  onclick="openDay('{{ hoy.isoformat() }}')">
            ‚ñ∂ Empezar
          </button>

          <a class="btn btn-outline-light btn-lg px-4"
             href="{{ url_for('main.perfil_usuario', user_id=user.id, view='week', center=hoy.isoformat()) }}">
            Ver semana
          </a>
        </div>
      </div>
    </div>
  {% endif %}

  {# ============================================================
     SEMANA
  ============================================================ #}
  {% if view == 'week' %}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h4 class="text-light mb-0">Semana</h4>
        <div class="text-muted">{{ semana_str }}</div>
      </div>

      <form method="GET" class="d-flex gap-2">
        <input type="hidden" name="view" value="week">
        <input type="date" class="form-control" name="center" value="{{ center.isoformat() }}">
        <button class="btn btn-outline-info" type="submit">Ir</button>
      </form>
    </div>

    <div class="row g-3">
      {% for f in fechas %}
        {% set p = planes[f] %}
        {% set done = (f in done_week) %}
        <div class="col-md-6 col-lg-4">
          <div class="card glass p-3 lift week-day-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="fw-bold week-day-title">
                {{ f.strftime('%a %d/%m')|upper }}
              </div>

              {% if done %}
                <span class="badge bg-success">HECHO</span>
              {% else %}
                {{ activity_badge(p.plan_type, 'sm') }}
              {% endif %}
            </div>

            <div class="text-muted week-day-text">
              {% if (p.plan_type or '').lower() == 'descanso' %}
                Descanso / recuperaci√≥n.
              {% else %}
                {{ p.warmup or '‚Äî' }}
              {% endif %}
            </div>

            <div class="d-grid mt-3">
              <button class="btn btn-outline-info" type="button"
                      onclick="openDay('{{ f.isoformat() }}')">
                Ver detalle
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# ============================================================
     MES
  ============================================================ #}
  {% if view == 'month' %}
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
      <div>
        <h4 class="text-light mb-0">Mes</h4>
        <div class="text-muted">{{ month_label }}</div>
      </div>

      <form method="GET" class="d-flex gap-2">
        <input type="hidden" name="view" value="month">
        <input type="month" class="form-control" name="center" value="{{ center.strftime('%Y-%m') }}">
        <button class="btn btn-outline-info" type="submit">Ir</button>
      </form>
    </div>

    <div class="card glass p-3 p-md-4">
      <div class="month-grid">
        <div class="month-head">L</div><div class="month-head">M</div><div class="month-head">X</div>
        <div class="month-head">J</div><div class="month-head">V</div><div class="month-head">S</div><div class="month-head">D</div>

        {% for w in month_grid %}
          {% for d in w %}
            {% if d %}
              {% set pm = planes_mes[d] %}
              {% set blocked = ((pm.puede_entrenar or 'si') == 'no') %}
              <div class="month-cell {% if blocked %}blocked{% endif %}"
                   data-date="{{ d.isoformat() }}"
                   onclick="openDay('{{ d.isoformat() }}')">
                <div class="daynum">{{ d.day }}</div>

                {% set raw = (pm.plan_type or 'Descanso') %}
                {% set norm = raw|lower %}
                {% if norm in ['swim','natacion','nataci√≥n'] %}
                  {% set icon = 'icons/natacion.png' %}
                  {% set label = 'Nataci√≥n' %}
                {% elif norm in ['pista','run_pista','track'] %}
                  {% set icon = 'icons/pista.png' %}
                  {% set label = 'Pista' %}
                {% elif norm in ['run','running'] %}
                  {% set icon = 'icons/run.png' %}
                  {% set label = 'Run' %}
                {% elif norm in ['bike','bici','cycling'] %}
                  {% set icon = 'icons/bike.png' %}
                  {% set label = 'Bike' %}
                {% elif norm in ['fuerza','strength','gym'] %}
                  {% set icon = 'icons/fuerza.png' %}
                  {% set label = 'Fuerza' %}
                {% else %}
                  {% set icon = 'icons/descanso.png' %}
                  {% set label = 'Descanso' %}
                {% endif %}

                <div class="ptype-icon">
                  <img src="{{ url_for('static', filename=icon) }}" alt="{{ label }}">
                  <span>{{ label }}</span>
                </div>
              </div>
            {% else %}
              <div class="month-cell empty"></div>
            {% endif %}
          {% endfor %}
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {# ============================================================
     PROGRESO
  ============================================================ #}
  {% if view == 'progress' %}
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="card glass p-3 p-md-4 h-100">
          <h4 class="text-light mb-1">Consistencia semanal</h4>
          <div class="text-muted mb-3">Objetivo vs completado esta semana.</div>

          {% set pct = 0 if week_goal==0 else (week_done*100//week_goal) %}
          <div class="glass p-3 mb-3" style="border-radius:18px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="mini-title">PORCENTAJE</div>
              <div class="fs-4 fw-bold">{{ pct }}%</div>
            </div>
            <div class="progress" style="height:12px;border-radius:999px;overflow:hidden;">
              <div class="progress-bar" style="width: {{ pct }}%"></div>
            </div>
          </div>

          <div class="vr-bars">
            {% for i in range(7) %}
              <div class="vr-bar">
                <div class="vr-bar-fill" style="height: {{ 100 if i < week_done else 0 }}%;"></div>
              </div>
            {% endfor %}
          </div>

          <div class="d-flex justify-content-between mt-2 vr-days">
            <span>L</span><span>M</span><span>X</span>
            <span>J</span><span>V</span><span>S</span><span>D</span>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card glass p-3 p-md-4 h-100">
          <h4 class="text-light mb-1">Racha</h4>
          <div class="text-muted mb-3">D√≠as seguidos marcando entreno.</div>

          <div class="display-5 fw-bold mb-2">üî• {{ streak }}</div>
          <p class="text-muted mb-3">
            Cada d√≠a que marc√°s tu sesi√≥n, la racha sube.  
            Si dej√°s un d√≠a sin marcar, la racha vuelve a cero.
          </p>

          <ul class="text-muted mb-0">
            <li>Manten√© al menos 3 d√≠as seguidos para estar en verde.</li>
            <li>5/7 d√≠as: zona atleta serio.</li>
            <li>7/7 d√≠as: üîí modo leyenda.</li>
          </ul>
        </div>
      </div>
    </div>
  {% endif %}
</div>

{# ============================================================
   MODAL D√çA (misma l√≥gica, solo JS/CSS)
============================================================ #}
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen-sm-down modal-xl">
    <div class="modal-content day-modal">

      <div class="modal-header">
        <div class="w-100">
          <div class="d-flex justify-content-between align-items-start gap-2 flex-wrap">
            <div>
              <div class="text-muted" id="dayModalDate"
                   style="letter-spacing:.18em;text-transform:uppercase;"></div>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <h5 class="modal-title mb-0" id="dayModalTitle">Detalle</h5>
                <span class="day-chip" id="dayModalType">‚Äî</span>
                <span class="chip chip-danger d-none" id="blockedChip">
                  <i class="bi bi-slash-circle me-1"></i>Bloqueado
                </span>
              </div>
              <div class="text-muted mt-1" style="font-size:.95rem;" id="daySubtitle">
                Lo que toca hoy.
              </div>
            </div>

            <div class="d-flex align-items-center gap-2 flex-wrap">
              <button class="btn btn-sm btn-outline-danger" type="button"
                      id="cantTrainBtn" onclick="toggleAvailabilityPanel(true)">
                <i class="bi bi-slash-circle me-1"></i> No puedo entrenar
              </button>

              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" id="didTrain">
                <label class="form-check-label text-muted" for="didTrain">Hoy entren√©</label>
              </div>

              <button type="button" class="btn-close btn-close-white"
                      data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
          </div>

          <div class="glass p-2 mt-3" style="border-radius:16px;">
            <div class="d-flex justify-content-between align-items-center px-2">
              <div class="day-section-title" style="margin:0;">Progreso</div>
              <div class="text-muted" style="font-weight:900;" id="progressLabel">‚Äî</div>
            </div>
            <div class="progress mt-2"
                 style="height:10px;border-radius:999px; overflow:hidden;">
              <div class="progress-bar" id="progressBar" style="width:0%"></div>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-body">
        <div class="row g-3">
          <div class="col-lg-4">
            <div class="day-section" id="warmupSection">
              <div class="day-section-title">1 ¬∑ Activaci√≥n</div>
              <div id="warmupBlocks" class="blocks-wrap">
                <div class="text-muted">‚Äî</div>
              </div>
            </div>

            <div class="day-section mt-3" id="mainSection">
              <div class="day-section-title">2 ¬∑ Bloque principal</div>
              <div class="text-muted" id="blocksMeta">‚Äî</div>
              <div id="dayBlocks" class="blocks-wrap mt-2">
                <div class="text-muted">Cargando...</div>
              </div>
            </div>

            <div class="day-section mt-3" id="finisherSection">
              <div class="day-section-title">3 ¬∑ Enfriamiento</div>
              <div id="finisherBlocks" class="blocks-wrap">
                <div class="text-muted">‚Äî</div>
              </div>
            </div>

            <div class="day-section mt-3 d-none" id="availabilityPanel">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="day-section-title" style="margin:0;">Disponibilidad</div>
                <span class="badge bg-secondary" id="availBadge">‚Äî</span>
              </div>

              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="noPuedoToggle">
                <label class="form-check-label text-muted" for="noPuedoToggle">
                  No puedo entrenar este d√≠a
                </label>
              </div>

              <textarea class="form-control mt-2" id="noPuedoText"
                        placeholder="Ej: viaje / lesi√≥n / trabajo / etc (corto)"></textarea>

              <div class="d-grid mt-2">
                <button class="btn btn-outline-danger" type="button"
                        onclick="saveAvailability()">
                  Guardar bloqueo
                </button>
              </div>

              <div class="text-muted mt-2" style="font-size:.9rem;">
                Si bloque√°s el d√≠a, el coach lo ver√° en rojo y no planifica.
              </div>
            </div>
          </div>

          <div class="col-lg-8">
            <div class="day-section d-none" id="strengthSection">
              <div class="day-section-title">Ejercicios</div>
              <div id="strengthItems" class="row g-3"></div>
            </div>

            <div class="day-section mt-3">
              <div class="day-section-title">Qu√© hiciste</div>
              <textarea class="form-control mb-2" id="doneNote"
                        placeholder="Escrib√≠ breve: c√≥mo te sentiste, cargas, tiempos, etc..."></textarea>

              <div class="d-grid">
                <button class="btn btn-primary" onclick="saveLog()">
                  üíæ Guardar
                </button>
              </div>
            </div>

          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.profile-hero{
  border-radius: 22px;
  padding: 18px 18px 16px;
  background: radial-gradient(circle at 0 0, rgba(34,211,238,.18), transparent 60%);
}
.profile-avatar{
  width:56px;
  height:56px;
  border-radius:18px;
}
.profile-hero-label{
  font-size:.78rem;
  font-weight:900;
  letter-spacing:.24em;
  text-transform:uppercase;
  color:rgba(255,255,255,.55);
}
.profile-hero-name{
  font-weight:900;
  letter-spacing:.04em;
}
.profile-hero-email{
  color:rgba(255,255,255,.65);
  font-size:.95rem;
}
.hero-stat{
  min-width:160px;
}
.hero-stat .mini-foot{
  margin-top:4px;
  font-size:.8rem;
  color:rgba(255,255,255,.6);
}
.btn-strava{
  border-radius:999px;
  border:1px solid rgba(255,184,0,.7);
  color:#ffb800;
  padding-inline:14px;
  font-weight:800;
}
.btn-strava:hover{
  background:rgba(255,184,0,.12);
  color:#ffe29a;
}
.profile-pill{
  border-radius:999px;
  font-weight:800;
}
.profile-pill-btn{
  border-radius:999px;
}
.profile-tabs .btn{
  border-radius:999px;
  font-weight:800;
}
.today-card{
  border-radius:22px;
}
.today-date{
  font-size:1.4rem;
  font-weight:900;
  letter-spacing:.12em;
}
.week-day-card{
  border-radius:18px;
}
.week-day-title{
  letter-spacing:.10em;
}
.week-day-text{
  font-size:.95rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let DAY_MODAL = null;
let CURRENT_DAY = null;
let CURRENT_USER = {{ user.id|int }};

let CURRENT_PAYLOAD = null;
let CURRENT_CHECKS = new Set();

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function decodeHtmlEntities(s){
  const txt = document.createElement("textarea");
  txt.innerHTML = String(s||"");
  return txt.value;
}
function cleanText(s){
  let out = decodeHtmlEntities(s);
  if(out.includes("&") || out.includes("&#")){
    out = decodeHtmlEntities(out);
  }
  return out;
}

function badgeHtml(type){
  const t = (type||"").toUpperCase();
  const map = {
    "TABATA": "bg-danger",
    "FUERZA": "bg-info",
    "STRETCH": "bg-info",
    "RUN": "bg-success",
    "BIKE": "bg-warning text-dark",
    "SWIM": "bg-primary",
    "EJERCICIO": "bg-dark",
    "FREE": "bg-secondary",
    "NOTE": "bg-light text-dark",
    "VIDEO": "bg-dark"
  };
  const cls = map[t] || "bg-secondary";
  return `<span class="badge ${cls}" style="font-weight:900; letter-spacing:.06em;">${escapeHtml(t||"BLOQUE")}</span>`;
}
function typeLabel(type){
  const t = (type||"").toLowerCase();
  if(t === "tabata") return "TABATA";
  if(t === "fuerza") return "FUERZA";
  if(t === "stretch") return "STRETCH";
  if(t === "ejercicio") return "EJERCICIO";
  if(t === "run") return "RUN";
  if(t === "bike") return "BIKE";
  if(t === "swim") return "SWIM";
  if(t === "free") return "FREE";
  if(t === "note") return "NOTE";
  if(t === "video") return "VIDEO";
  return (type||"BLOQUE").toUpperCase();
}

/* =========================
   DISPONIBILIDAD
========================= */
function setAvailUI(puede, comentario){
  const toggle = document.getElementById("noPuedoToggle");
  const text = document.getElementById("noPuedoText");
  const badge = document.getElementById("availBadge");

  const blocked = (String(puede || "si") === "no");
  toggle.checked = blocked;
  text.value = comentario || "";

  if(blocked){
    badge.className = "badge bg-danger";
    badge.textContent = "NO PUEDE";
    document.getElementById("blockedChip").classList.remove("d-none");
    document.getElementById("cantTrainBtn").classList.add("active");
  }else{
    badge.className = "badge bg-success";
    badge.textContent = "OK";
    document.getElementById("blockedChip").classList.add("d-none");
    document.getElementById("cantTrainBtn").classList.remove("active");
  }
}

function toggleAvailabilityPanel(forceOpen){
  const panel = document.getElementById("availabilityPanel");
  const open = !panel.classList.contains("d-none");
  if(forceOpen || !open){
    panel.classList.remove("d-none");
    panel.scrollIntoView({behavior:"smooth", block:"start"});
  }else{
    panel.classList.add("d-none");
  }
}

async function saveAvailability(){
  const noPuedo = document.getElementById("noPuedoToggle").checked;
  const comentario = document.getElementById("noPuedoText").value || "";

  const payload = { user_id: CURRENT_USER, fecha: CURRENT_DAY, no_puedo: noPuedo, comentario };

  try{
   const res = await fetch("/athlete/save_availability", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!j.ok) throw new Error(j.error || "Error");

    setAvailUI(noPuedo ? "no" : "si", comentario);

    const cell = document.querySelector(`.month-cell[data-date="${CSS.escape(CURRENT_DAY)}"]`);
    if(cell){
      if(noPuedo) cell.classList.add("blocked");
      else cell.classList.remove("blocked");
    }

    alert("‚úÖ Guardado");
  }catch(err){
    console.error(err);
    alert("Error guardando disponibilidad: " + err.message);
  }
}

/* =========================
   BLOQUES (RENDER)
========================= */
function renderBlocksInto(elId, blocks){
  const wrap = document.getElementById(elId);
  wrap.innerHTML = "";

  const arr = Array.isArray(blocks) ? blocks : [];
  if(!arr.length){
    wrap.innerHTML = `<div class="text-muted">‚Äî</div>`;
    return;
  }

  arr.forEach((b, idx) => {
    const type = (b.type || "").toLowerCase();
    const ok = b.ok !== false;

    let icon = "bi-grid";
    if(type === "tabata"){ icon = "bi-lightning-charge-fill"; }
    if(type === "run"){ icon = "bi-person-running"; }
    if(type === "bike"){ icon = "bi-bicycle"; }
    if(type === "swim"){ icon = "bi-water"; }
    if(type === "free"){ icon = "bi-wind"; }
    if(type === "note"){ icon = "bi-chat-left-text"; }
    if(type === "fuerza"){ icon = "bi-barbell"; }
    if(type === "stretch"){ icon = "bi-universal-access-circle"; }
    if(type === "ejercicio"){ icon = "bi-play-btn-fill"; }

    const div = document.createElement("div");
    div.className = "block-card";

    if(!ok){
      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-warning"></i></div>
            <div>
              <div class="block-title">${typeLabel(b.type)}</div>
              <div class="block-sub text-warning">${escapeHtml(b.error || "Bloque inv√°lido")}</div>
            </div>
          </div>
          ${badgeHtml(typeLabel(b.type))}
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "fuerza" || type === "stretch"){
      const rname = cleanText(b.rutina?.nombre || (type === "stretch" ? "Estiramientos" : "Fuerza"));
      const itemsCount = Array.isArray(b.items) ? b.items.length : 0;
      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
            <div>
              <div class="block-title">${escapeHtml(rname)}</div>
              <div class="block-sub">${itemsCount} ejercicio(s) ¬∑ kilos + video + check</div>
            </div>
          </div>
          ${badgeHtml(typeLabel(b.type))}
        </div>

        <div class="block-actions">
          <button class="btn btn-outline-light" type="button"
                  onclick="toggleStrength(${idx}, '${elId}')">
            Ver ejercicios
          </button>
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "tabata"){
      const rname = cleanText(b.rutina?.nombre || "Tabata");
      const work = b.cfg?.work ?? 40;
      const rest = b.cfg?.rest ?? 20;
      const rounds = b.cfg?.rounds ?? (Array.isArray(b.items) ? b.items.length : 0);
      const sets = b.cfg?.sets ?? 1;
      const startUrl = b.start_url || "#";

      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-danger"></i></div>
            <div>
              <div class="block-title">${escapeHtml(rname)}</div>
              <div class="block-sub">${work}s trabajo ¬∑ ${rest}s descanso ¬∑ ${rounds} ejercicios ¬∑ ${sets} set(s)</div>
            </div>
          </div>
          ${badgeHtml("TABATA")}
        </div>
        <div class="block-actions">
          <a class="btn btn-danger" href="${startUrl}" target="_blank" rel="noopener">‚ñ∂ Reproducir</a>
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "ejercicio"){
      const ej = b.ejercicio || {};
      const title = cleanText(ej.nombre || "Ejercicio");
      const src = (ej.video_url || "").trim();
      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
            <div>
              <div class="block-title">${escapeHtml(title)}</div>
              <div class="block-sub">${src ? "Reproduc√≠ y segu√≠." : "Sin video"}</div>
            </div>
          </div>
          ${badgeHtml("EJERCICIO")}
        </div>
        ${src ? `
          <div class="mt-2">
            <video class="w-100" controls playsinline preload="metadata"
                   style="border-radius:16px;border:1px solid rgba(255,255,255,.14);background:#000;max-height:320px;">
              <source src="${src}" type="video/mp4">
            </video>
          </div>
        ` : ``}
      `;
      wrap.appendChild(div);
      return;
    }

    if(type === "run" || type === "bike" || type === "swim" || type === "free" || type === "note"){
      const text = cleanText(b.text || "‚Äî");
      div.innerHTML = `
        <div class="block-head">
          <div class="block-left">
            <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
            <div>
              <div class="block-title">${typeLabel(b.type)}</div>
              <div class="block-sub">${escapeHtml(text)}</div>
            </div>
          </div>
          ${badgeHtml(typeLabel(b.type))}
        </div>
      `;
      wrap.appendChild(div);
      return;
    }

    div.innerHTML = `
      <div class="block-head">
        <div class="block-left">
          <div class="block-icon"><i class="bi ${icon} text-info"></i></div>
          <div>
            <div class="block-title">${typeLabel(b.type)}</div>
            <div class="block-sub">${escapeHtml(cleanText(b.text || ""))}</div>
          </div>
        </div>
        ${badgeHtml(typeLabel(b.type))}
      </div>
    `;
    wrap.appendChild(div);
  });
}

function updateProgress(){
  const blocks = Array.isArray(CURRENT_PAYLOAD?.blocks) ? CURRENT_PAYLOAD.blocks : [];
  const force = blocks.find(b => ["fuerza","stretch"].includes((b.type||"").toLowerCase()) && b.ok && Array.isArray(b.items));
  const total = force?.items?.length || 0;
  const done = total ? force.items.filter(it => CURRENT_CHECKS.has(String(it.id))).length : 0;

  const pct = total ? Math.round((done * 100) / total) : 0;
  document.getElementById("progressBar").style.width = pct + "%";
  document.getElementById("progressLabel").textContent = total ? `Hechos ${done} / ${total}` : "‚Äî";
}

function posterDataUrl(title){
  const safe = (title || "VR TRAINING").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const svg = `
  <svg xmlns="http://www.w3.org/2000/svg" width="1280" height="720">
    <defs>
      <linearGradient id="g" x1="0" x2="1">
        <stop offset="0" stop-color="#0b0f12"/>
        <stop offset="1" stop-color="#050608"/>
      </linearGradient>
    </defs>
    <rect width="100%" height="100%" fill="url(#g)"/>
    <rect x="40" y="40" width="1200" height="640" rx="36" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.16)"/>
    <circle cx="640" cy="360" r="62" fill="rgba(34,211,238,0.18)" stroke="rgba(34,211,238,0.45)" stroke-width="6"/>
    <polygon points="625,330 625,390 680,360" fill="rgba(255,255,255,0.85)"/>
    <text x="80" y="130" font-size="46" fill="rgba(255,255,255,0.92)" font-family="Arial" font-weight="700">${safe}</text>
    <text x="80" y="180" font-size="26" fill="rgba(255,255,255,0.60)" font-family="Arial">VR Training</text>
  </svg>`;
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}

function pickWeight(it){
  const w = (it.peso ?? it.kg ?? it.kilos ?? it.weight ?? it.carga ?? it.load ?? null);
  if(w === null || w === undefined) return "";
  const n = String(w).trim();
  if(!n || n === "0" || n.toLowerCase() === "none") return "";
  return n;
}

function renderStrength(items){
  const wrap = document.getElementById("strengthItems");
  wrap.innerHTML = "";
  if(!items || !items.length){
    wrap.innerHTML = `<div class="text-muted">No hay ejercicios para mostrar.</div>`;
    return;
  }

  items.forEach(it => {
    const col = document.createElement("div");
    col.className = "col-12";

    const isDone = CURRENT_CHECKS.has(String(it.id));
    const checked = isDone ? "checked" : "";
    const vidSrc = it.video_src || "";
    const poster = posterDataUrl(it.nombre);

    const series = String(it.series || "").trim();
    const reps   = String(it.reps || "").trim();
    const desc   = String(it.descanso || "").trim();
    const nota   = String(it.nota || "").trim();

    const kgVal = pickWeight(it);
    const kgTxt = kgVal ? `${kgVal} kg` : "";

    const parts = [];
    if(series) parts.push(`${series} series`);
    if(reps) parts.push(`${reps} reps`);
    if(kgTxt) parts.push(kgTxt);
    if(desc) parts.push(`Desc ${desc}`);
    if(nota) parts.push(cleanText(nota));

    col.innerHTML = `
      <div class="exercise-card ${isDone ? "done" : ""}" id="exCard-${it.id}">
        <div class="exercise-head">
          <div>
            <div class="exercise-name">${escapeHtml(cleanText(it.nombre || "Ejercicio"))}</div>
            <div class="exercise-meta">${escapeHtml(parts.join(" ¬∑ ") || "‚Äî")}</div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <span class="exercise-done-pill ${isDone ? "" : "d-none"}" id="exPill-${it.id}">
              <i class="bi bi-check2-circle"></i> HECHO
            </span>

            <div class="form-check form-switch m-0">
              <input class="form-check-input" type="checkbox" ${checked}
                     onchange="toggleItem(${it.id}, this.checked)">
            </div>
            <div class="text-muted" style="font-weight:900;letter-spacing:.08em;">HECHO</div>
          </div>
        </div>

        <div class="exercise-video">
          ${vidSrc ? `
            <video controls playsinline webkit-playsinline preload="metadata" poster="${poster}">
              <source src="${vidSrc}" type="video/mp4">
            </video>
          ` : `<div class="text-muted">Sin video</div>`}
        </div>
      </div>
    `;
    wrap.appendChild(col);
  });
}

function toggleStrength(blockIndex, sourceElId){
  const sec = document.getElementById("strengthSection");
  const isHidden = sec.classList.contains("d-none");

  if(isHidden){
    let sourceBlocks = [];
    if(sourceElId === "warmupBlocks") sourceBlocks = CURRENT_PAYLOAD?.warmup_blocks || [];
    else if(sourceElId === "finisherBlocks") sourceBlocks = CURRENT_PAYLOAD?.finisher_blocks || [];
    else sourceBlocks = CURRENT_PAYLOAD?.blocks || [];

    const b = Array.isArray(sourceBlocks) ? sourceBlocks[blockIndex] : null;
    const items = (b && b.ok && Array.isArray(b.items)) ? b.items : [];

    sec.classList.remove("d-none");
    renderStrength(items);
    updateProgress();
    sec.scrollIntoView({behavior:"smooth", block:"start"});
  }else{
    sec.classList.add("d-none");
  }
}

function openDay(isoDate){
  CURRENT_DAY = isoDate;

  if(typeof bootstrap === "undefined"){
    alert("Bootstrap JS no carg√≥. Revis√° layout.html (bootstrap.bundle.min.js).");
    return;
  }
  if(!DAY_MODAL){
    DAY_MODAL = new bootstrap.Modal(document.getElementById("dayModal"));
  }

  CURRENT_PAYLOAD = null;
  CURRENT_CHECKS = new Set();

  document.getElementById("dayModalDate").textContent = isoDate;
  document.getElementById("dayModalTitle").textContent = "Cargando...";
  document.getElementById("dayModalType").textContent = "‚Äî";
  document.getElementById("daySubtitle").textContent = "Lo que toca hoy.";

  document.getElementById("warmupBlocks").innerHTML = `<div class="text-muted">‚Äî</div>`;
  document.getElementById("dayBlocks").innerHTML = `<div class="text-muted">Cargando...</div>`;
  document.getElementById("finisherBlocks").innerHTML = `<div class="text-muted">‚Äî</div>`;
  document.getElementById("blocksMeta").textContent = "‚Äî";

  document.getElementById("strengthSection").classList.add("d-none");
  document.getElementById("strengthItems").innerHTML = "";

  document.getElementById("progressBar").style.width = "0%";
  document.getElementById("progressLabel").textContent = "‚Äî";

  document.getElementById("blockedChip").classList.add("d-none");

  document.getElementById("availabilityPanel").classList.add("d-none");
  setAvailUI("si","");

  fetch(`/api/day_detail?user_id=${CURRENT_USER}&fecha=${encodeURIComponent(isoDate)}`)
    .then(r => r.json())
    .then(data => {
      if(!data.ok) throw new Error(data.error || "Error");
      CURRENT_PAYLOAD = data;

      const p = data.plan || {};
      document.getElementById("dayModalTitle").textContent = cleanText(p.plan_type || "Detalle del d√≠a");
      document.getElementById("dayModalType").textContent = cleanText(p.plan_type || "‚Äî");

      setAvailUI(p.puede_entrenar || "si", cleanText(p.comentario_atleta || ""));

      document.getElementById("didTrain").checked = !!data.log?.did_train;
      document.getElementById("doneNote").value = cleanText(data.log?.main_done || "");

      CURRENT_CHECKS = new Set((Array.isArray(data.checks) ? data.checks : []).map(x => String(x)));

      const wBlocks = Array.isArray(data.warmup_blocks) ? data.warmup_blocks : [];
      const mBlocks = Array.isArray(data.blocks) ? data.blocks : [];
      const fBlocks = Array.isArray(data.finisher_blocks) ? data.finisher_blocks : [];

      renderBlocksInto("warmupBlocks", wBlocks);
      renderBlocksInto("dayBlocks", mBlocks);
      renderBlocksInto("finisherBlocks", fBlocks);

      const blocksCount = mBlocks.length;
      document.getElementById("blocksMeta").textContent = blocksCount ? `${blocksCount} bloque(s)` : "‚Äî";

      updateProgress();
      DAY_MODAL.show();
    })
    .catch(err => {
      console.error(err);
      alert("Error cargando el d√≠a: " + err.message);
    });
}

function toggleItem(itemId, done){
  const form = new FormData();
  form.append("user_id", String(CURRENT_USER));
  form.append("fecha", String(CURRENT_DAY));
  form.append("item_id", String(itemId));
  form.append("done", done ? "1" : "0");

  fetch("/athlete/check_item", { method:"POST", body: form })
    .then(r => r.json())
    .then(j => {
      if(!j.ok) throw new Error(j.error || "Error");

      if(done) CURRENT_CHECKS.add(String(itemId));
      else CURRENT_CHECKS.delete(String(itemId));

      const card = document.getElementById(`exCard-${itemId}`);
      if(card) card.classList.toggle("done", !!done);

      const pill = document.getElementById(`exPill-${itemId}`);
      if(pill) pill.classList.toggle("d-none", !done);

      updateProgress();
    })
    .catch(err => { console.error(err); alert("Error guardando check: " + err.message); });
}

function saveLog(){
  const payload = {
    user_id: CURRENT_USER,
    fecha: CURRENT_DAY,
    did_train: document.getElementById("didTrain").checked,
    warmup_done: "",
    main_done: document.getElementById("doneNote").value || "",
    finisher_done: ""
  };

  fetch("/athlete/save_log", {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(j => { if(!j.ok) throw new Error(j.error || "Error"); alert("‚úÖ Guardado"); })
  .catch(err => { console.error(err); alert("Error guardando: " + err.message); });
}
</script>
{% endblock %}
