{% extends "layout.html" %}
{% block title %}Rutina Builder ‚Äî VR Training{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
    <div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-info">BUILDER</span>
        <h2 class="mb-0 text-strong">Editar rutina</h2>
      </div>
      <div class="text-soft mt-1">
        <span class="me-2">Rutina:</span>
        <span class="text-strong">{{ rutina.nombre }}</span>
        {% if rutina.tipo %}<span class="text-soft"> ¬∑ {{ rutina.tipo }}</span>{% endif %}
      </div>
      {% if rutina.descripcion %}
        <div class="text-soft mt-1" style="max-width: 820px;">{{ rutina.descripcion }}</div>
      {% endif %}
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-light" href="{{ url_for('main.dashboard_entrenador') }}">‚Üê Volver al panel</a>
      <a class="btn btn-outline-info" href="{{ url_for('main.coach_planificador') }}">üìÖ Planificador</a>
    </div>
  </div>

  <div class="row g-4">

    <!-- IZQ: EJERCICIOS DE LA RUTINA -->
    <div class="col-12 col-xl-7">
      <div class="card glass lift">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div>
            <h5 class="mb-0 text-strong">Ejercicios de la rutina</h5>
            <div class="text-soft">Arrastr√° para ordenar. Edici√≥n compacta para rutinas largas.</div>
          </div>

          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-secondary">Total: {{ items|length }}</span>
          </div>
        </div>

        <div class="card-body">

          {% if items %}
            <div id="rutinaList" class="rb-list">
              {% for item in items %}
                <div class="rb-item" data-item-id="{{ item.id }}">
                  <div class="d-flex justify-content-between align-items-start gap-2">
                    <div>
                      <div class="rb-title">
                        <span class="rb-handle">‚†ø Orden</span>
                        <span class="ms-2">#{{ loop.index }} ¬∑ {{ item.nombre }}</span>
                      </div>

                      <div class="rb-meta mt-1">
                        <span class="chip">Series: <b>{{ item.series or '‚Äî' }}</b></span>
                        <span class="chip">Repeticiones: <b>{{ item.reps or '‚Äî' }}</b></span>
                        <span class="chip">Peso: <b>{{ item.peso or '‚Äî' }}</b></span>
                        <span class="chip">Descanso: <b>{{ item.descanso or '‚Äî' }}</b></span>
                      </div>
                    </div>

                    <div class="rb-actions">
                      {% if item.video_url %}
                        <button type="button"
                                class="btn btn-sm btn-outline-info"
                                data-video="{{ url_for('static', filename=item.video_url) }}"
                                data-title="{{ item.nombre|e }}"
                                onclick="openVideo(this)">
                          ‚ñ∂ Ver video
                        </button>
                      {% else %}
                        <span class="badge bg-secondary">sin video</span>
                      {% endif %}

                      <form method="post"
                            action="{{ url_for('main.rutina_delete_item', rutina_id=rutina.id, item_id=item.id) }}"
                            onsubmit="return confirm('¬øEliminar {{ item.nombre }} de la rutina?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                      </form>
                    </div>
                  </div>

                  {% if item.nota %}
                    <div class="rb-note mt-2">{{ item.nota }}</div>
                  {% endif %}

                  <!-- edici√≥n compacta -->
                  <form method="post"
                        action="{{ url_for('main.rutina_update_item', rutina_id=rutina.id, item_id=item.id) }}"
                        class="rb-edit mt-3">

                    <div class="rb-grid">
                      <div class="rb-field">
                        <label>Series</label>
                        <input type="text" name="series" value="{{ item.series or '' }}">
                      </div>

                      <div class="rb-field">
                        <label>Repeticiones</label>
                        <input type="text" name="reps" value="{{ item.reps or '' }}">
                      </div>

                      <div class="rb-field">
                        <label>Peso</label>
                        <input type="text" name="peso" value="{{ item.peso or '' }}" placeholder="kg / manc / RPE">
                      </div>

                      <div class="rb-field">
                        <label>Descanso</label>
                        <input type="text" name="descanso" value="{{ item.descanso or '' }}">
                      </div>
                    </div>

                    <div class="rb-note mt-2">
                      <label class="d-block mb-1" style="font-size:12px;opacity:.85;">Nota</label>
                      <textarea name="nota" rows="2" class="w-100" placeholder="Cue, t√©cnica, tempo, RPE...">{{ item.nota or '' }}</textarea>
                    </div>

                    <div class="rb-save d-grid">
                      <button type="submit" class="btn btn-sm btn-primary">Guardar cambios</button>
                    </div>
                  </form>
                </div>
              {% endfor %}
            </div>

          {% else %}
            <div class="empty-state">
              <div class="text-strong">Esta rutina todav√≠a no tiene ejercicios.</div>
              <div class="text-soft">Us√° el banco de la derecha para a√±adir.</div>
            </div>
          {% endif %}

        </div>
      </div>
    </div>

    <!-- DER: BANCO DE EJERCICIOS -->
    <div class="col-12 col-xl-5">
      <div class="card glass lift">
        <div class="card-header">
          <h5 class="mb-0 text-strong">Banco de ejercicios</h5>
          <div class="text-soft">Busc√° r√°pido y a√±ad√≠. El video se abre en modal.</div>
        </div>

        <div class="card-body">

          <div class="rb-bank-tools mb-3">
            <input id="bankSearch" class="form-control" placeholder="Buscar ejercicio (nombre o categor√≠a)..."
                   oninput="filterBank()">
          </div>

          <div id="bankList" class="rb-bank-list">
            {% if ejercicios %}
              {% for ej in ejercicios %}
                <div class="rb-bank-item"
                     data-name="{{ (ej.nombre or '')|lower }}"
                     data-cat="{{ (ej.categoria or '')|lower }}">
                  <div class="rb-bank-head">
                    <div>
                      <div class="text-strong">{{ ej.nombre }}</div>
                      <div class="text-soft">
                        {% if ej.categoria %}{{ ej.categoria }}{% else %}‚Äî{% endif %}
                        {% if ej.descripcion %}<span class="text-soft"> ¬∑ {{ ej.descripcion }}</span>{% endif %}
                      </div>
                    </div>

                    <div class="d-flex gap-2">
                      {% if ej.video_filename %}
                        <button type="button"
                                class="btn btn-sm btn-outline-info"
                                data-video="{{ url_for('static', filename='videos/' ~ ej.video_filename) }}"
                                data-title="{{ ej.nombre|e }}"
                                onclick="openVideo(this)">
                          ‚ñ∂ Ver
                        </button>
                      {% endif %}
                    </div>
                  </div>

                  <form method="post"
                        action="{{ url_for('main.rutina_add_item', rutina_id=rutina.id) }}"
                        class="row g-2 mt-2">
                    <input type="hidden" name="ejercicio_id" value="{{ ej.id }}">

                    <div class="col-3">
                      <input type="text" name="series" placeholder="Series" class="form-control form-control-sm">
                    </div>
                    <div class="col-3">
                      <input type="text" name="reps" placeholder="Reps" class="form-control form-control-sm">
                    </div>
                    <div class="col-3">
                      <input type="text" name="peso" placeholder="Peso" class="form-control form-control-sm">
                    </div>
                    <div class="col-3">
                      <input type="text" name="descanso" placeholder="Desc" class="form-control form-control-sm">
                    </div>

                    <div class="col-12">
                      <textarea name="nota" rows="2" placeholder="Nota (opcional)" class="form-control form-control-sm"></textarea>
                    </div>
                    <div class="col-12 d-grid">
                      <button type="submit" class="btn btn-sm btn-info">+ A√±adir a rutina</button>
                    </div>
                  </form>
                </div>
              {% endfor %}
            {% else %}
              <div class="text-soft">No hay ejercicios en el banco todav√≠a.</div>
            {% endif %}
          </div>

        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL VIDEO -->
<div class="modal fade" id="videoModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content glass">
      <div class="modal-header">
        <h5 class="modal-title text-strong" id="videoTitle">Video</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <video id="videoPlayer" class="w-100" controls preload="metadata" playsinline>
          <source id="videoSource" src="" type="video/mp4">
        </video>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>

<script>
function filterBank(){
  const q = (document.getElementById("bankSearch").value || "").toLowerCase().trim();
  const items = document.querySelectorAll("#bankList .rb-bank-item");
  items.forEach(el=>{
    const name = el.getAttribute("data-name") || "";
    const cat  = el.getAttribute("data-cat") || "";
    const ok = !q || name.includes(q) || cat.includes(q);
    el.style.display = ok ? "" : "none";
  });
}

function openVideo(btn){
  const url = btn.getAttribute("data-video");
  const title = btn.getAttribute("data-title") || "Video";
  const modalEl = document.getElementById("videoModal");
  const titleEl = document.getElementById("videoTitle");
  const player  = document.getElementById("videoPlayer");
  const source  = document.getElementById("videoSource");

  titleEl.textContent = title;
  source.src = url;
  player.load();

  const modal = new bootstrap.Modal(modalEl);
  modal.show();

  modalEl.addEventListener("hidden.bs.modal", () => {
    try { player.pause(); } catch(e){}
    source.src = "";
    player.load();
  }, { once: true });
}

async function saveOrder(){
  const list = document.getElementById("rutinaList");
  if (!list) return;

  const order = Array.from(list.querySelectorAll(".rb-item"))
    .map(el => parseInt(el.getAttribute("data-item-id")));

  try{
    const res = await fetch("{{ url_for('main.rutina_reorder', rutina_id=rutina.id) }}", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ order })
    });
    const data = await res.json();
    if (!data.ok){
      alert("Error guardando orden: " + (data.error || "‚Äî"));
    }
  }catch(e){
    alert("Error guardando orden (network).");
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const list = document.getElementById("rutinaList");
  if (!list) return;

  new Sortable(list, {
    handle: ".rb-handle",
    animation: 150,
    ghostClass: "rb-ghost",
    onEnd: () => saveOrder()
  });
});
</script>
{% endblock %}
