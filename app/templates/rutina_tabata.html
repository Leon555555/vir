{# templates/rutina_tabata.html #}
{% extends "layout.html" %}
{% block title %}Tabata ‚Äî {{ rutina.nombre }}{% endblock %}

{% block content %}
<div class="container mt-4">

  <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
    <div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-info">TABATA</span>
        <h2 class="mb-0 text-strong">{{ rutina.nombre }}</h2>
      </div>
      <div class="text-soft mt-1">
        {% if rutina.tipo %}{{ rutina.tipo }}{% endif %}
        {% if rutina.descripcion %}<span class="text-soft"> ¬∑ {{ rutina.descripcion }}</span>{% endif %}
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-light" href="{{ url_for('main.perfil_redirect') }}">‚Üê Volver</a>
      {% if is_admin() %}
      <a class="btn btn-outline-info" href="{{ url_for('main.rutina_builder', rutina_id=rutina.id) }}">üõ† Builder</a>
      {% endif %}
    </div>
  </div>

  <div class="row g-3">
    <!-- Config -->
    <div class="col-12 col-lg-4">
      <div class="card glass lift">
        <div class="card-header"><strong>Configuraci√≥n</strong></div>
        <div class="card-body">

          <div class="row g-2">
            <div class="col-6">
              <label class="text-soft" style="font-size:.85rem;">Work (seg)</label>
              <input id="cfgWork" type="number" class="form-control" value="{{ tabata_cfg.work }}">
            </div>
            <div class="col-6">
              <label class="text-soft" style="font-size:.85rem;">Rest (seg)</label>
              <input id="cfgRest" type="number" class="form-control" value="{{ tabata_cfg.rest }}">
            </div>

            <div class="col-6">
              <label class="text-soft" style="font-size:.85rem;">Rounds (ejercicios)</label>
              <input id="cfgRounds" type="number" class="form-control" value="{{ tabata_cfg.rounds }}">
            </div>
            <div class="col-6">
              <label class="text-soft" style="font-size:.85rem;">Sets (vueltas)</label>
              <input id="cfgSets" type="number" class="form-control" value="{{ tabata_cfg.sets }}">
            </div>

            <div class="col-12">
              <label class="text-soft" style="font-size:.85rem;">Descanso entre sets (seg)</label>
              <input id="cfgRestBetween" type="number" class="form-control" value="{{ tabata_cfg.rest_between_sets }}">
            </div>

            <div class="col-12">
              <label class="text-soft" style="font-size:.85rem;">Descanso final (seg)</label>
              <input id="cfgFinisher" type="number" class="form-control" value="{{ tabata_cfg.finisher_rest }}">
            </div>

            <div class="col-12">
              <label class="text-soft" style="font-size:.85rem;">Count-in (seg)</label>
              <input id="cfgCountIn" type="number" class="form-control" value="{{ tabata_cfg.count_in }}">
            </div>
          </div>

          <div class="d-grid mt-3">
            <button class="btn btn-info" onclick="applyConfig()">Aplicar</button>
          </div>

          <div class="text-soft mt-3" style="font-size:.9rem;">
            Tip: Para tu ejemplo: <b>10 ejercicios</b>, <b>40''</b> work, <b>20''</b> rest, descanso final <b>60''</b>.
          </div>

        </div>
      </div>

      <div class="card glass lift mt-3">
        <div class="card-header"><strong>Lista</strong></div>
        <div class="card-body" style="max-height: 420px; overflow:auto;">
          {% for it in tabata_items %}
            <div class="d-flex justify-content-between align-items-center mb-2"
                 style="padding:10px;border:1px solid rgba(255,255,255,.10);border-radius:14px;background:rgba(255,255,255,.03);">
              <div class="text-strong">{{ loop.index }} ¬∑ {{ it.nombre }}</div>
              <span class="badge bg-secondary">OK</span>
            </div>
          {% endfor %}
          {% if not tabata_items %}
            <div class="text-soft">No hay ejercicios en esta rutina.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Player -->
    <div class="col-12 col-lg-8">
      <div class="card glass lift">
        <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
          <strong>Player</strong>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-light btn-sm" onclick="resetTabata()">Reset</button>
            <button id="btnStart" class="btn btn-info btn-sm" onclick="startTabata()">Start</button>
            <button id="btnPause" class="btn btn-outline-warning btn-sm" onclick="pauseTabata()" disabled>Pause</button>
          </div>
        </div>

        <div class="card-body">

          <div class="row g-3">
            <div class="col-12">
              <div class="glass p-3" style="border-radius:18px;">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                  <div>
                    <div class="text-soft" style="font-weight:900;letter-spacing:.12em;text-transform:uppercase;font-size:.8rem;">
                      Estado
                    </div>
                    <div id="stateLabel" class="text-strong" style="font-size:1.35rem;font-weight:900;">
                      Listo
                    </div>
                  </div>

                  <div class="text-end">
                    <div class="text-soft" style="font-weight:900;letter-spacing:.12em;text-transform:uppercase;font-size:.8rem;">
                      Tiempo
                    </div>
                    <div id="timeLeft" class="text-strong" style="font-size:2.2rem;font-weight:900;">
                      00:00
                    </div>
                  </div>
                </div>

                <div class="progress mt-3" style="height:10px;background:rgba(255,255,255,.08);">
                  <div id="bar" class="progress-bar" style="width:0%;"></div>
                </div>

                <div class="d-flex justify-content-between mt-3 flex-wrap gap-2">
                  <div>
                    <div class="text-soft" style="font-size:.85rem;">Ejercicio actual</div>
                    <div id="curName" class="text-strong" style="font-weight:900;">‚Äî</div>
                  </div>
                  <div class="text-end">
                    <div class="text-soft" style="font-size:.85rem;">Siguiente</div>
                    <div id="nextName" class="text-strong" style="font-weight:900;">‚Äî</div>
                  </div>
                </div>

                <div class="d-flex justify-content-between mt-2">
                  <div class="text-soft">Round: <b id="roundInfo">‚Äî</b></div>
                  <div class="text-soft">Set: <b id="setInfo">‚Äî</b></div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <div class="glass p-3" style="border-radius:18px;">
                <div class="text-soft" style="font-weight:900;letter-spacing:.12em;text-transform:uppercase;font-size:.8rem;">
                  Video (si existe)
                </div>
                <div class="mt-2" style="border-radius:18px; overflow:hidden; border:1px solid rgba(255,255,255,.12); background:#000;">
                  <video id="playerVideo" class="w-100" controls playsinline preload="metadata"></video>
                </div>
                <div id="videoHint" class="text-soft mt-2" style="font-size:.9rem;">‚Äî</div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

</div>

<script>
const ITEMS = {{ tabata_items_json|safe }};
let CFG = {{ tabata_cfg_json|safe }};

let timer = null;
let phase = "idle";   // idle | countin | work | rest | rest_between | finisher | done
let tLeft = 0;
let tTotal = 0;

let setIdx = 1;
let roundIdx = 1;
let exIdx = 0; // 0..rounds-1 dentro de cada set

function clampInt(v, minv, maxv){
  v = parseInt(v || 0, 10);
  if (isNaN(v)) v = 0;
  v = Math.max(minv, v);
  if (maxv !== null) v = Math.min(maxv, v);
  return v;
}

function fmt(sec){
  sec = Math.max(0, sec|0);
  const m = String(Math.floor(sec/60)).padStart(2,'0');
  const s = String(sec%60).padStart(2,'0');
  return `${m}:${s}`;
}

function setUI(){
  document.getElementById("timeLeft").textContent = fmt(tLeft);
  document.getElementById("roundInfo").textContent = (phase === "idle") ? "‚Äî" : `${roundIdx}/${CFG.rounds}`;
  document.getElementById("setInfo").textContent = (phase === "idle") ? "‚Äî" : `${setIdx}/${CFG.sets}`;

  const cur = getCurrentExercise();
  const nxt = getNextExercise();

  document.getElementById("curName").textContent = cur ? cur.nombre : "‚Äî";
  document.getElementById("nextName").textContent = nxt ? nxt.nombre : "‚Äî";

  const bar = document.getElementById("bar");
  const pct = (tTotal <= 0) ? 0 : Math.round(((tTotal - tLeft) / tTotal) * 100);
  bar.style.width = `${Math.max(0, Math.min(100, pct))}%`;
}

function setStateLabel(txt){
  document.getElementById("stateLabel").textContent = txt;
}

function getCurrentExercise(){
  if (!ITEMS.length) return null;
  const idx = exIdx % Math.max(1, ITEMS.length);
  return ITEMS[idx] || null;
}

function getNextExercise(){
  if (!ITEMS.length) return null;
  const idx = (exIdx + 1) % Math.max(1, ITEMS.length);
  return ITEMS[idx] || null;
}

function loadVideoForCurrent(){
  const v = document.getElementById("playerVideo");
  const hint = document.getElementById("videoHint");
  const cur = getCurrentExercise();
  if (!cur || !cur.video_src){
    v.removeAttribute("src");
    v.load();
    hint.textContent = "Sin video para este ejercicio.";
    return;
  }
  v.src = cur.video_src;
  v.load();
  hint.textContent = "Tip: pod√©s dejarlo en play y hacer Tabata mirando el video.";
}

function tick(){
  tLeft -= 1;
  if (tLeft <= 0){
    nextPhase();
  }
  setUI();
}

function setPhase(newPhase, seconds, label){
  phase = newPhase;
  tLeft = seconds;
  tTotal = seconds;
  setStateLabel(label);
  setUI();
}

function nextPhase(){
  // termina el timer del paso actual
  if (timer){
    clearInterval(timer);
    timer = null;
  }

  if (phase === "countin"){
    loadVideoForCurrent();
    setPhase("work", CFG.work, "WORK");
  }
  else if (phase === "work"){
    setPhase("rest", CFG.rest, "REST");
  }
  else if (phase === "rest"){
    // avanza ejercicio
    exIdx += 1;
    roundIdx += 1;

    if (roundIdx > CFG.rounds){
      // termin√≥ rounds de este set
      if (setIdx < CFG.sets){
        setIdx += 1;
        roundIdx = 1;
        setPhase("rest_between", CFG.rest_between_sets, "DESCANSO ENTRE SETS");
      } else {
        setPhase("finisher", CFG.finisher_rest, "RECUPERACI√ìN FINAL");
      }
    } else {
      // siguiente ejercicio
      loadVideoForCurrent();
      setPhase("work", CFG.work, "WORK");
    }
  }
  else if (phase === "rest_between"){
    // reinicio ejercicios del set (opcional: sigue rotaci√≥n)
    loadVideoForCurrent();
    setPhase("work", CFG.work, "WORK");
  }
  else if (phase === "finisher"){
    setPhase("done", 0, "‚úÖ COMPLETADO");
    stopControls();
    return;
  }

  // arranca intervalo si no estamos en done/idle
  if (phase !== "done" && phase !== "idle"){
    timer = setInterval(tick, 1000);
  }
}

function startControls(){
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnPause").disabled = false;
}

function stopControls(){
  document.getElementById("btnStart").disabled = false;
  document.getElementById("btnPause").disabled = true;
}

function startTabata(){
  if (!ITEMS.length){
    alert("Esta rutina no tiene ejercicios.");
    return;
  }
  if (timer) return;

  startControls();
  setIdx = 1;
  roundIdx = 1;
  exIdx = 0;

  setPhase("countin", CFG.count_in, "PREPARATE");
  timer = setInterval(tick, 1000);
}

function pauseTabata(){
  if (!timer) return;
  clearInterval(timer);
  timer = null;
  setStateLabel("PAUSA");
  document.getElementById("btnStart").disabled = false;
  document.getElementById("btnPause").disabled = true;
}

function resetTabata(){
  if (timer){
    clearInterval(timer);
    timer = null;
  }
  phase = "idle";
  tLeft = 0;
  tTotal = 0;
  setIdx = 1;
  roundIdx = 1;
  exIdx = 0;

  setStateLabel("Listo");
  stopControls();
  setUI();

  const v = document.getElementById("playerVideo");
  v.removeAttribute("src"); v.load();
  document.getElementById("videoHint").textContent = "‚Äî";
}

function applyConfig(){
  const work = clampInt(document.getElementById("cfgWork").value, 1, 3600);
  const rest = clampInt(document.getElementById("cfgRest").value, 0, 3600);
  const rounds = clampInt(document.getElementById("cfgRounds").value, 1, 999);
  const sets = clampInt(document.getElementById("cfgSets").value, 1, 50);
  const restBetween = clampInt(document.getElementById("cfgRestBetween").value, 0, 3600);
  const finisher = clampInt(document.getElementById("cfgFinisher").value, 0, 3600);
  const countIn = clampInt(document.getElementById("cfgCountIn").value, 0, 30);

  // si rounds > items, ajusto
  const maxRounds = Math.max(1, ITEMS.length);
  const finalRounds = Math.min(rounds, maxRounds);

  CFG = {
    work, rest, rounds: finalRounds, sets,
    rest_between_sets: restBetween,
    finisher_rest: finisher,
    count_in: countIn
  };

  // opcional: recargar URL con params para compartir config
  const url = new URL(window.location.href);
  url.searchParams.set("work", CFG.work);
  url.searchParams.set("rest", CFG.rest);
  url.searchParams.set("rounds", CFG.rounds);
  url.searchParams.set("sets", CFG.sets);
  url.searchParams.set("rest_between_sets", CFG.rest_between_sets);
  url.searchParams.set("finisher_rest", CFG.finisher_rest);
  url.searchParams.set("count_in", CFG.count_in);
  window.history.replaceState({}, "", url.toString());

  alert("‚úÖ Config aplicada");
  resetTabata();
}

resetTabata();
</script>
{% endblock %}
