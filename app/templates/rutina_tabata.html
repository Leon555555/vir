{# app/templates/rutina_tabata.html #}
{% extends "layout.html" %}
{% block title %}Tabata ‚Äî {{ rutina.nombre }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 mb-3">
    <div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-info">TABATA</span>
        <h2 class="mb-0 text-strong">Tabata ¬∑ {{ rutina.nombre }}</h2>
        {% if rutina.tipo %}
          <span class="badge bg-secondary">{{ rutina.tipo }}</span>
        {% endif %}
      </div>
      {% if rutina.descripcion %}
        <div class="text-soft mt-1" style="max-width: 980px;">{{ rutina.descripcion }}</div>
      {% endif %}
      <div class="text-soft mt-1">
        <span class="me-2">Work:</span><span class="text-strong">{{ work }}s</span>
        <span class="mx-2">¬∑</span>
        <span class="me-2">Rest:</span><span class="text-strong">{{ rest }}s</span>
        <span class="mx-2">¬∑</span>
        <span class="me-2">Rounds:</span><span class="text-strong">{{ rounds }}</span>
        <span class="mx-2">¬∑</span>
        <span class="me-2">Final:</span><span class="text-strong">{{ final_rest }}s</span>
      </div>
    </div>

    <div class="d-flex gap-2 flex-wrap">
      <a class="btn btn-outline-light" href="{{ url_for('main.perfil_redirect') }}">‚Üê Volver</a>
      <a class="btn btn-outline-info" href="{{ url_for('main.rutina_builder', rutina_id=rutina.id) }}">‚öôÔ∏è Builder</a>
    </div>
  </div>

  <div class="row g-3">

    <!-- PLAYER -->
    <div class="col-12 col-xl-8">
      <div class="card glass lift p-3 p-md-4 tabata-player">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div class="text-soft" style="letter-spacing:.18em;text-transform:uppercase;font-weight:900;">
              Estado
            </div>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <div id="phaseBadge" class="badge bg-secondary">LISTO</div>
              <div class="text-soft" id="roundLabel">Round ‚Äî</div>
            </div>
          </div>

          <div class="d-flex gap-2 align-items-center flex-wrap">
            <button id="btnStart" class="btn btn-info">‚ñ∂ Empezar</button>
            <button id="btnPause" class="btn btn-outline-light" disabled>‚è∏ Pausa</button>
            <button id="btnNext" class="btn btn-outline-info" disabled>‚è≠ Siguiente</button>
            <button id="btnReset" class="btn btn-outline-danger">‚Üª Reset</button>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-12 col-lg-5">
            <div class="timer-box glass p-3">
              <div class="timer-kicker">TIEMPO</div>
              <div id="timeBig" class="timer-big">00:00</div>
              <div class="d-flex justify-content-between mt-2 text-soft" style="font-weight:900;">
                <span id="timeSmall">‚Äî</span>
                <span id="totalSmall">Total: ‚Äî</span>
              </div>

              <div class="progress mt-3" style="height:12px;border-radius:999px;background:rgba(255,255,255,.08);">
                <div id="timeBar" class="progress-bar" style="width:0%"></div>
              </div>
            </div>

            <div class="mt-3 glass p-3" style="border-radius:18px;">
              <div class="mini-title mb-2">CONFIG</div>

              <div class="row g-2">
                <div class="col-6">
                  <label class="text-soft" style="font-size:.8rem;">Work (s)</label>
                  <input id="cfgWork" class="form-control form-control-sm" type="number" min="5" max="300" value="{{ work }}">
                </div>
                <div class="col-6">
                  <label class="text-soft" style="font-size:.8rem;">Rest (s)</label>
                  <input id="cfgRest" class="form-control form-control-sm" type="number" min="0" max="300" value="{{ rest }}">
                </div>
                <div class="col-6">
                  <label class="text-soft" style="font-size:.8rem;">Rounds</label>
                  <input id="cfgRounds" class="form-control form-control-sm" type="number" min="1" max="50" value="{{ rounds }}">
                </div>
                <div class="col-6">
                  <label class="text-soft" style="font-size:.8rem;">Final (s)</label>
                  <input id="cfgFinal" class="form-control form-control-sm" type="number" min="0" max="600" value="{{ final_rest }}">
                </div>
              </div>

              <div class="d-grid mt-3">
                <button id="btnApplyCfg" class="btn btn-outline-info btn-sm">Aplicar configuraci√≥n</button>
              </div>

              <div class="text-soft mt-2" style="font-size:.85rem;">
                Tip: pod√©s ajustar y darle ‚ÄúAplicar‚Äù antes de arrancar.
              </div>
            </div>

          </div>

          <div class="col-12 col-lg-7">
            <div class="current-card glass p-3">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <div class="text-soft" style="letter-spacing:.18em;text-transform:uppercase;font-weight:900;">Ejercicio</div>
                  <div id="exName" class="ex-name">‚Äî</div>
                </div>
                <div class="text-soft" style="font-weight:900;" id="exIndex">‚Äî</div>
              </div>

              <div class="mt-2">
                <video id="playerVideo" class="player-video" controls playsinline webkit-playsinline preload="metadata"></video>
              </div>

              <div class="mt-2 text-soft" style="font-size:.9rem;">
                Si el video no carga, igual el timer funciona.
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

    <!-- LISTA -->
    <div class="col-12 col-xl-4">
      <div class="card glass lift">
        <div class="card-header d-flex justify-content-between align-items-center">
          <div>
            <h5 class="mb-0 text-strong">Orden</h5>
            <div class="text-soft">Se reproduce en orden (hasta rounds)</div>
          </div>
          <span class="badge bg-secondary" id="listCount">‚Äî</span>
        </div>

        <div class="card-body">
          <div id="listWrap" class="tabata-list"></div>
        </div>
      </div>
    </div>

  </div>

</div>
{% endblock %}

{% block extra_css %}
<style>
.tabata-player{ border-radius: 22px; }
.timer-box{ border-radius: 18px; }
.timer-kicker{
  letter-spacing:.18em;
  text-transform:uppercase;
  font-weight:900;
  color: rgba(255,255,255,.70);
  font-size:.82rem;
}
.timer-big{
  font-weight: 1000;
  letter-spacing:.02em;
  font-size: 64px;
  line-height: 1;
  margin-top: 6px;
}
@media (max-width: 480px){
  .timer-big{ font-size: 52px; }
}
.current-card{ border-radius: 18px; }
.ex-name{
  font-weight: 1000;
  font-size: 1.35rem;
  margin-top: 4px;
}
.player-video{
  width: 100%;
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.35);
  min-height: 260px;
  object-fit: cover;
}
.tabata-list{ display:flex; flex-direction:column; gap:10px; }
.tli{
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.03);
  padding: 12px 12px;
  display:flex;
  align-items:flex-start;
  justify-content: space-between;
  gap: 10px;
}
.tli.active{
  border-color: rgba(34,211,238,.45);
  box-shadow: 0 0 0 1px rgba(34,211,238,.18) inset;
}
.tli .name{ font-weight: 900; color: rgba(255,255,255,.95); }
.tli .meta{ font-size:.85rem; color: rgba(255,255,255,.65); margin-top: 2px; }
.tli .pill{
  font-size:.78rem;
  font-weight: 900;
  letter-spacing:.08em;
  color: rgba(255,255,255,.70);
  border: 1px solid rgba(255,255,255,.12);
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(0,0,0,.25);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
/**
 * Tabata player (sin dependencias)
 * - Cambia fase: READY -> WORK/REST por cada ejercicio -> FINAL -> DONE
 * - Soporta aplicar config antes de iniciar
 */

const ITEMS = {{ items|tojson }};
let cfg = {
  work: Number({{ work }}),
  rest: Number({{ rest }}),
  rounds: Number({{ rounds }}),
  final: Number({{ final_rest }})
};

let state = {
  running: false,
  phase: "READY", // READY | WORK | REST | FINAL | DONE
  idx: 0,
  remaining: 0,
  intervalId: null,
  phaseTotal: 0,
};

const el = (id) => document.getElementById(id);

function clamp(n, a, b){ n = Number(n); if(isNaN(n)) n = a; return Math.max(a, Math.min(b, n)); }

function fmtMMSS(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function setBadge(phase){
  const b = el("phaseBadge");
  b.className = "badge";
  if(phase === "WORK"){ b.classList.add("bg-success"); b.textContent = "WORK"; }
  else if(phase === "REST"){ b.classList.add("bg-warning"); b.textContent = "REST"; }
  else if(phase === "FINAL"){ b.classList.add("bg-info"); b.textContent = "FINAL"; }
  else if(phase === "DONE"){ b.classList.add("bg-secondary"); b.textContent = "FINALIZADO"; }
  else { b.classList.add("bg-secondary"); b.textContent = "LISTO"; }
}

function updateUI(){
  const totalPhases = Math.min(cfg.rounds, ITEMS.length);
  el("roundLabel").textContent = (state.phase === "DONE")
    ? `Completado ¬∑ ${totalPhases} rounds`
    : `Round ${Math.min(state.idx+1, totalPhases)} / ${totalPhases}`;

  el("timeBig").textContent = fmtMMSS(state.remaining);
  el("timeSmall").textContent = `${state.phase}`;
  el("totalSmall").textContent = `Total: ${fmtMMSS(state.phaseTotal)}`;

  const pct = state.phaseTotal > 0 ? (100 * (state.phaseTotal - state.remaining) / state.phaseTotal) : 0;
  el("timeBar").style.width = `${Math.max(0, Math.min(100, pct))}%`;

  // current exercise
  const cur = getCurrentItem();
  el("exName").textContent = cur ? cur.name : "‚Äî";
  el("exIndex").textContent = cur ? `#${state.idx+1}` : "‚Äî";

  // video
  const v = el("playerVideo");
  const src = cur && cur.video ? cur.video : "";
  if(src){
    if(v.getAttribute("src") !== src){
      try { v.pause(); } catch(e){}
      v.setAttribute("src", src);
      v.load();
    }
  }else{
    v.removeAttribute("src");
    v.load();
  }

  // buttons
  el("btnStart").disabled = state.running;
  el("btnPause").disabled = !state.running;
  el("btnNext").disabled = (state.phase === "READY" || state.phase === "DONE");

  // list highlight
  highlightList();
}

function getCurrentItem(){
  const max = Math.min(cfg.rounds, ITEMS.length);
  if(state.idx < 0 || state.idx >= max) return null;
  return ITEMS[state.idx];
}

function buildList(){
  const wrap = el("listWrap");
  wrap.innerHTML = "";
  const max = Math.min(cfg.rounds, ITEMS.length);
  el("listCount").textContent = `Total: ${max}`;
  for(let i=0; i<max; i++){
    const it = ITEMS[i];
    const div = document.createElement("div");
    div.className = "tli";
    div.dataset.idx = String(i);
    div.innerHTML = `
      <div>
        <div class="name">${escapeHtml(it.name || "Ejercicio")}</div>
        <div class="meta">${it.video ? "üé• Video" : "‚Äî sin video"}</div>
      </div>
      <div class="pill">${i+1}</div>
    `;
    div.addEventListener("click", () => {
      if(state.running) return;
      state.idx = i;
      // si estamos ready, mantenemos ready; si ya hab√≠a fase, reiniciamos a READY
      state.phase = "READY";
      state.remaining = 0;
      state.phaseTotal = 0;
      setBadge("READY");
      updateUI();
    });
    wrap.appendChild(div);
  }
  highlightList();
}

function highlightList(){
  const nodes = el("listWrap").querySelectorAll(".tli");
  nodes.forEach(n => n.classList.remove("active"));
  const active = el("listWrap").querySelector(`.tli[data-idx="${state.idx}"]`);
  if(active) active.classList.add("active");
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function startPhase(phase){
  state.phase = phase;
  setBadge(phase);

  if(phase === "WORK"){
    state.remaining = cfg.work;
    state.phaseTotal = cfg.work;
  } else if(phase === "REST"){
    state.remaining = cfg.rest;
    state.phaseTotal = cfg.rest;
  } else if(phase === "FINAL"){
    state.remaining = cfg.final;
    state.phaseTotal = cfg.final;
  } else if(phase === "DONE"){
    state.remaining = 0;
    state.phaseTotal = 0;
  } else {
    state.remaining = 0;
    state.phaseTotal = 0;
  }

  updateUI();
}

function tick(){
  if(!state.running) return;
  state.remaining -= 1;
  if(state.remaining <= 0){
    // transition
    if(state.phase === "WORK"){
      if(cfg.rest > 0) startPhase("REST");
      else nextExerciseOrFinal();
    } else if(state.phase === "REST"){
      nextExerciseOrFinal();
    } else if(state.phase === "FINAL"){
      finish();
    } else {
      // READY o DONE no deber√≠an tickear
    }
  } else {
    updateUI();
  }
}

function nextExerciseOrFinal(){
  const max = Math.min(cfg.rounds, ITEMS.length);
  // avanzar ejercicio
  if(state.idx + 1 < max){
    state.idx += 1;
    startPhase("WORK");
  } else {
    // terminamos rondas -> final rest o done
    if(cfg.final > 0){
      startPhase("FINAL");
    } else {
      finish();
    }
  }
}

function run(){
  if(state.intervalId) clearInterval(state.intervalId);
  state.intervalId = setInterval(tick, 1000);
}

function start(){
  if(state.running) return;
  state.running = true;
  el("btnPause").textContent = "‚è∏ Pausa";

  // si est√° listo, empieza WORK
  if(state.phase === "READY" || state.phase === "DONE"){
    state.idx = clamp(state.idx, 0, Math.max(0, Math.min(cfg.rounds, ITEMS.length)-1));
    startPhase("WORK");
  }
  run();
  updateUI();
}

function pause(){
  if(!state.running) return;
  state.running = false;
  if(state.intervalId) clearInterval(state.intervalId);
  state.intervalId = null;
  updateUI();
}

function togglePause(){
  if(!state.running) start();
  else pause();
}

function next(){
  // forzar next en medio de work/rest
  if(state.phase === "WORK" || state.phase === "REST"){
    nextExerciseOrFinal();
  } else if(state.phase === "FINAL"){
    finish();
  }
}

function resetAll(){
  pause();
  state.phase = "READY";
  state.idx = 0;
  state.remaining = 0;
  state.phaseTotal = 0;
  setBadge("READY");
  buildList();
  updateUI();
}

function finish(){
  pause();
  startPhase("DONE");
  updateUI();
}

function applyCfg(){
  // solo antes de iniciar (si est√° corriendo, no)
  if(state.running){
    alert("Paus√° antes de aplicar configuraci√≥n.");
    return;
  }

  cfg.work = clamp(el("cfgWork").value, 5, 300);
  cfg.rest = clamp(el("cfgRest").value, 0, 300);
  cfg.rounds = clamp(el("cfgRounds").value, 1, 50);
  cfg.final = clamp(el("cfgFinal").value, 0, 600);

  // ajustar idx si qued√≥ fuera
  const max = Math.min(cfg.rounds, ITEMS.length);
  if(state.idx >= max) state.idx = Math.max(0, max-1);

  // reset fase
  state.phase = "READY";
  state.remaining = 0;
  state.phaseTotal = 0;
  setBadge("READY");

  buildList();
  updateUI();
}

document.addEventListener("DOMContentLoaded", () => {
  // init
  if(!Array.isArray(ITEMS) || !ITEMS.length){
    alert("Esta rutina no tiene ejercicios.");
    return;
  }

  buildList();
  setBadge("READY");
  updateUI();

  el("btnStart").addEventListener("click", start);
  el("btnPause").addEventListener("click", togglePause);
  el("btnNext").addEventListener("click", next);
  el("btnReset").addEventListener("click", resetAll);
  el("btnApplyCfg").addEventListener("click", applyCfg);

  // espacio = pausa/play
  document.addEventListener("keydown", (e) => {
    if(e.code === "Space"){
      e.preventDefault();
      togglePause();
    }
    if(e.code === "ArrowRight"){
      e.preventDefault();
      next();
    }
    if(e.code === "KeyR"){
      e.preventDefault();
      resetAll();
    }
  });
});
</script>
{% endblock %}
